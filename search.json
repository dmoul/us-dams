[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "A look at US Dams",
    "section": "",
    "text": "1 Introduction\nHaving learned of the existence of the US National Inventory of Dams, I started wondering …",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "index.html#focus",
    "href": "index.html#focus",
    "title": "A look at US Dams",
    "section": "1.1 Focus",
    "text": "1.1 Focus\nIn this report I look at dams in the continental USA, excluding dikes, and levees. In order to put dams into the larger context of US civil infrastructure, I include infrastructure grades, funding and funding gap data published by the American Society of Civil Engineers.\nGoing beyond the dams, I also look at their drainage area, waterways and watersheds, and land roughness around dams. Where I go deeper in a specific state, I typically pick North Carolina, the state where I live.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "index.html#introducting-the-national-inventory-of-dams-nid",
    "href": "index.html#introducting-the-national-inventory-of-dams-nid",
    "title": "A look at US Dams",
    "section": "1.2 Introducting the National Inventory of Dams (NID)",
    "text": "1.2 Introducting the National Inventory of Dams (NID)\nThe following is from the mission page on the NID web site1.\n\nThe National Inventory of Dams (NID) is a congressionally authorized database that documents more than 91,000 dams across the U.S. and its territories. It is maintained and published by the U.S. Army Corps of Engineers, in cooperation with the Association of State Dam Safety Officials, the states, territories, and federal agencies.2 …. The National Inventory of Dams (NID) documents all known dams in the U.S. and its territories that meet certain criteria. It is designed to provide a variety of users the ability to search for specific data about dams in the U.S. and serves as a resource to support awareness of dams and actions to prepare for a dam-related emergency. USACE is responsible for maintaining the NID and works in close collaboration with federal and state dam regulating agencies, the Federal Emergency Management Agency (FEMA) and the Association of State Dam Safety Officials, to obtain accurate and complete information about dams in the database. The database contains information about a dam’s location, type, size, purpose, uses and benefits, last inspection, other structural and geographical information, and much more (there are more than 70 data fields for each dam). The NID is also used to assist federal, state, and local agencies developing dam safety policies ….\nInformation Available in the NID\nSince transitioning to a web-based platform, site visitors have been able to download or export certain data. The NID is currently the only place to find and download national data at such a detailed level. Today, the database contains information for more than 91,000 dams that meet the following criteria:\n\nDams where a failure or mis-operation will likely result in loss of human life (high hazard potential).\nDams where a failure or mis-operation would likely result in disruption of access to critical facilities, damage to public and private facilities, and require difficult mitigation efforts (significant hazard potential).\nDams that meet minimum height and reservoir size requirements, even though they do not pose the same level of life or economic risk as those above – these dams are equal to or exceed 25 feet in height and exceed 15 acre-feet in storage, or equal to or exceeding 50 acre-feet in storage and exceeding 6 feet in height.\nThe NID does not yet contain all dams in the U.S. that meet these criteria. Continued, routine updates to the NID and enhanced data collection efforts, focused on the most reliable data sources (primarily the many federal and state government dam regulatory programs), will help capture these dams and result in a more robust dataset over time….\n\nA common misconception is that the NID contains only dams that are large or pose a threat to human life. In reality, there are a wide variety of dams in the NID. For example, around two-thirds (60,000) of the dams in the NID do not pose life loss or economic risk (low hazard potential). Half of the NID dams are less than 25 feet in height, and only two percent of the dams are more than 100 feet tall.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "index.html#definitions",
    "href": "index.html#definitions",
    "title": "A look at US Dams",
    "section": "1.3 Definitions",
    "text": "1.3 Definitions\nThe following definitions are published by the US Society on Dams3\n\nDam: An artificial barrier that has the ability to impound water, wastewater, or any liquid-borne material, for the purpose of storage or control of water.\nDike: (1) (Engineering) An embankment to confine or control water, especially one built along the banks of a river to prevent overflow of lowlands; a levee. (2) A low wall that can act as a barrier to prevent a spill from spreading. (3) (Geology) A tabular body of igneous (formed by volcanic action) rock that cuts across the structure of adjacent rocks or cuts massive rocks.\nLevee: A natural or man-made earthen barrier along the edge of a stream, river, or lake to prevent the flow of water out of its channel.\n\n\nThe data set include many helpful variables. Definitions below are from the National Inventory of Dams Data Dictionary updated December 2021. Some with a “nid” prefix are worth explaining here:\n\nnidId: The official NID identification number for the dam, known formerly as the National ID. This is a required field, and must have an entry for each dam included in the NID. The State Dam Safety Offices assign and maintain the NID IDs for all dams, regardless of ownership. The first two characters of the identity are the two-letter state abbreviation, based on the location of the dam. The last five to six characters of the identity are a unique number (AB#####); although States are allowed to use alphanumeric combinations in the characters that follow the state abbreviation.\nnidHieght: Calculated field: Maximum value of dam height, structural height, and hydraulic height. Accepted as the general height of the dam.\nnidHeightId: Calculated field: Based on the NID Height, grouped into categories: less than 25 feet, 25-49 feet, 50-100 feet, and greater than 100 feet.\nnidStorage Calculated field: Maximum value of normal storage and maximum storage. Accepted as the general storage of the dam\n\nMaximum Storage: Maximum storage, in acre-feet, which is defined as the total storage space in a reservoir below the maximum attainable water surface elevation, including any surcharge storage.\nNormal Storage: Normal storage, in acre-feet, which is defined as the total storage space in a reservoir below the normal retention level, including dead and inactive storage and excluding any flood control or surcharge storage. For normally dry dams, the normal storage will be a zero value. If unknown, the value will be blank and not zero.\n\n\nnidStorage is the measurement of volume managed by the dam.\nOther useful numerical data include surfaceArea, maxDischarge, drainageArea, yearCompleted, and yearsModified.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "index.html#acknowledgements",
    "href": "index.html#acknowledgements",
    "title": "A look at US Dams",
    "section": "1.4 Acknowledgements",
    "text": "1.4 Acknowledgements\nThe U.S. Army Corps of Engineers maintains the National Inventory of Dams and publishes it at https://nid.sec.usace.army.mil/#/ .\nI reuse some definitions from the US Society on Dams.\nThe American Society for Civil Engineers publishes an infrastructure report card, including the 2025 report summary, and 2025 full report.\nRiver shape files are published by the National Weather Service National Operational Hydrologic Remote Sensing Center which I downloaded from https://www.weather.gov/gis/Rivers .\nUsing the osmdata package, I downloaded some dam and river data from OpenStreetMap, which is licensed on the terms of the Open Database License, “ODbL” 1.0.\nThe USABoundaries package by Jacci Ziebert et al. provides easy access to current and historical boundaries. Kyle Walker’s tidycensus package provide easy access to data from the US Census Bureau including population and other demographics along with boundaries data from the US Census Bureau’s TIGER/Line shapefiles.\nThe elevatr package by Jeffrey Hollister et al. (which is mirrored by the US Environmental Protection Agency) makes it easy to download Digital Elevation Model (DEM) data. The elevatr package gets data from the AWS Open Data Terrain Tiles, managed by Mapzen, a Linux Foundation project. I use 3DEP data, specifically data from the NASA Shuttle RADAR Topography Mission (SRTM). The United States 3DEP (formerly NED) and SRTM terrain data are provided courtesy of the U.S. Geological Survey.\nThe rspacial packages terra and sf do the GIS heavy lifting, as well as many tidyverse packages. I use a color scheme and other helpful functions from Diego Hernangómez’s tidyterra .\nThanks to Jeremy Singer-Vine for highlighting the National Inventory of Dams in his newsletter Data Is Plural — 2025.05.14 edition.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "index.html#licensing",
    "href": "index.html#licensing",
    "title": "A look at US Dams",
    "section": "1.5 Licensing",
    "text": "1.5 Licensing\nA look at US dams © 2026 by Daniel Moul is licensed under CC BY 4.0\nThe source code creating this text can be found at https://github.com/dmoul and is offered under the MIT license.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "index.html#footnotes",
    "href": "index.html#footnotes",
    "title": "A look at US Dams",
    "section": "",
    "text": "https://nid.sec.usace.army.mil/#/about-the-nid/mission ↩︎\nhttps://nid.sec.usace.army.mil/assets/whatIsNid/nov-2021-factsheet.pdf ↩︎\nhttps://www.ussdams.org/glossary/ ↩︎",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "summary.html",
    "href": "summary.html",
    "title": "2  Summary",
    "section": "",
    "text": "There were 92245 dams, dykes, locks and levees in the National Inventory of Dams when I downloaded the data set on 2025-05-07. I removed secondary structures, levees and dykes not associated with dams, and structures outside the continental USA, leaving 86351 dams.1. In the cleaned data set there are 1526 big dams (defined as having a height of at least 100 feet), which is about 2% of the dams.\nDams serve many purposes, and as noted in the Chapter 1 Introduction, can be dangerous. Dams are assigned risk levels, and some dams need an emergency action plans (EAPs). In general, risk level and the existence of EAPs seem to be sensibly correlated, but there are high risk dams without EAPs. See Chapter 3 Risks.\nAmerican civil infrastructure is under-funded. The American Society of Civil Engineers (ASCE) projects that in the years 2024-2033, dams and levees will have the greatest gap of all infrastructure categories in funding as proportion unmet_need::projected_need. This is despite there being so many dams (or perhaps partly because there are so many). In dollar terms, the ASCE projects larger gaps for some other infrastructure categories as noted in Chapter 4 Infrastructure grades.\nSo where are the dams? In short, nearly everywhere. See Chapter 5 Maps.\nDams come in many sizes and types, and the amount of water and its surface area behind dams varies widely. The distributions of many metrics are approximately log-normal. See Chapter 6 Numbers.\nThe drainage basins served by dams vary widely. See Chapter 8 Drainage.\nTerrain ruggedness index (TRI) is a quantification of the roughness of the land. What can we learn from this? Perhaps more than you expect. See Chapter 10 Terrain ruggedness.\nNearly all dams are the origin of a waterway or or a break in its flow. See Chapter 9 Dams, waterways, and watersheds.\nSee Chapter 12 Notes.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Summary</span>"
    ]
  },
  {
    "objectID": "summary.html#footnotes",
    "href": "summary.html#footnotes",
    "title": "2  Summary",
    "section": "",
    "text": "To simplify data acquisition, analysis and visualizations, I focus on the continental USA rather than including all states, districts, and territories. See discussion in Chapter 12 Notes and limitations ↩︎",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Summary</span>"
    ]
  },
  {
    "objectID": "risk.html",
    "href": "risk.html",
    "title": "3  Risks",
    "section": "",
    "text": "3.1 Dam condition\nA primary reason for the National Inventory of Dams is to ensure that risks related to dams are adequately identified and managed.\nThe NID data dictionary defines the hazard classifications:\nShow the code\ndta_for_plot &lt;- dams_no_geo |&gt;\n  count(hazardId, conditionAssessId)\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_col(aes(n, hazardId, fill = conditionAssessId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  labs(\n    subtitle = \"Hazard level by condition status\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_col(aes(n, conditionAssessId, fill = hazardId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  guides(fill = guide_legend(reverse = TRUE)) +\n  labs(\n    subtitle = \"Condition status by hazard level\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Hazard level by condition status\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 3.1: Dam hazard levels and condition assessment (continental states)\nVery few are rated “Unsatisfactory”\nShow the code\n# unsat &lt;- dams_no_geo |&gt;\n#   filter(conditionAssessId == \"Unsatisfactory\") |&gt;\n#   count(nidHeightId)\n# \n# poor &lt;- dams_no_geo |&gt;\n#   filter(conditionAssessId == \"Poor\") |&gt;\n#   count(nidHeightId)\n\ndams_no_geo |&gt;\n  count(hazardId, conditionAssessId, nidHeightId) |&gt;\n  ggplot() +\n  geom_col(aes(n, hazardId, fill = conditionAssessId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  facet_wrap(~nidHeightId) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.8, 0.3)) +\n  labs(\n    title = \"Dam hazard levels and condition assessment\\nby dam height\",\n    x = NULL,\n    y = NULL,\n    caption = my_caption\n  )\n\ndams_no_geo |&gt;\n  count(hazardId, conditionAssessId, nidHeightId) |&gt;\n  ggplot() +\n  geom_col(aes(n, hazardId, fill = nidHeightId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  facet_wrap(~conditionAssessId) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.8, 0.3)) +\n  labs(\n    title = \"Dam hazard levels and condition assessment\\nby dam height\",\n    x = NULL,\n    y = NULL,\n    caption = my_caption\n  )\n\ndams_no_geo |&gt;\n  filter(conditionAssessId %in% c(\"Unsatisfactory\", \"Poor\", \"Fair\")) |&gt;\n  count(hazardId, conditionAssessId, nidHeightId) |&gt;\n  ggplot() +\n  geom_col(aes(n, hazardId, fill = nidHeightId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  facet_wrap(~conditionAssessId, ncol = 2) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.8, 0.3)) +\n  labs(\n    title = \"Dam hazard levels and condition assessment\\nby dam height\",\n    x = NULL,\n    y = NULL,\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 3.2: Dam hazard levels and condition assessment (continental states)\n\n\n\n\n\n\n\n\n\n\n\nFigure 3.3: Dam hazard levels and condition assessment (continental states)\n\n\n\n\n\n\n\n\n\n\n\nFigure 3.4: Dam hazard levels and condition assessment (continental states)\nBig dams with Unsatisfactory or Poor condition:\nShow the code\ndta_for_plot &lt;- dams_no_geo |&gt;\n  filter(conditionAssessId %in% c(\"Unsatisfactory\", \"Poor\"),\n         big_dam) |&gt;\n  count(hazardId, conditionAssessId, nidHeightId)\n\nn_dams_big_unsat_poor = sum(dta_for_plot$n)\n\ndta_for_plot |&gt;\n  ggplot() +\n  geom_col(aes(n, hazardId, fill = nidHeightId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  facet_wrap(~conditionAssessId, ncol = 2) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.8, 0.3)) +\n  labs(\n    title = glue(\"{n_dams_big_unsat_poor} big dams have assessment\\nof Unsatisfactory or Poor\"),\n    x = NULL,\n    y = \"HazardId\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 3.5: High hazard levels and unsatisfactory or poor condition\nMost risky: over 100 ft, high hazard level, and unsatisfactory rating:\nShow the code\ndams_no_geo |&gt;\n  filter(hazardId == \"High\",\n         conditionAssessId == \"Unsatisfactory\",\n         nidHeightId == \"Greater than 100 feet\") |&gt;\n  select(name, nidId, state, primaryPurposeId, nidHeight, nidStorage, hazardId, conditionAssessDate, eapId, eapLastRevDate, ownerNames) |&gt;\n  arrange(desc(nidStorage)) |&gt;\n  mutate(idx = row_number()) |&gt;\n  relocate(idx) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 10) |&gt;\n  tab_header(md(\"**Big dams with high hazard level and unsatisfactory condition**\"))\n\n\n\n\nTable 3.1: Short list: High hazard level and unsatisfactory condition\n\n\n\n\n\n\n\n\n\nBig dams with high hazard level and unsatisfactory condition\n\n\nidx\nname\nnidId\nstate\nprimaryPurposeId\nnidHeight\nnidStorage\nhazardId\nconditionAssessDate\neapId\neapLastRevDate\nownerNames\n\n\n\n\n1\nMossyrock\nWA00151\nWashington\nHydroelectric\n606\n1900000\nHigh\n2023-04-11\nYes\n2022-12-30\nCity of Tacoma\n\n\n2\nMayfield\nWA00152\nWashington\nHydroelectric\n250\n184194\nHigh\n2023-04-11\nYes\n2022-12-30\nCity of Tacoma\n\n\n3\nLiberty Dam\nMD00003\nMaryland\nWater Supply\n175\n177000\nHigh\n2022-04-22\nNo\n2024-04-11\nBaltimore City DPW Reservoir Section\n\n\n4\nSanchez\nCO00790\nColorado\nIrrigation\n137\n137850\nHigh\n2022-07-22\nYes\n2019-06-20\nSANCHEZ DITCH AND RESERVOIR CO. (CALDON, KEITH)\n\n\n5\nAnderson\nCA00294\nCalifornia\nWater Supply\n240\n89073\nHigh\n2023-09-29\nYes\n2023-01-24\nSanta Clara Valley Water District\n\n\n6\nWillow Creek 3 (Malheur)\nOR00390\nOregon\nIrrigation\n110\n49000\nHigh\n2021-09-30\nYes\nNA\nOrchards Water Co\n\n\n7\nLake Hodges\nCA00108\nCalifornia\nWater Supply\n131\n37700\nHigh\n2023-02-02\nYes\n2019-06-04\nCity of San Diego\n\n\n8\nLaprele\nWY00204\nWyoming\nIrrigation\n135\n26850\nHigh\n2022-09-08\nYes\n2011-04-01\nLAPRELE IRRIGATION DISTRICT\n\n\n9\nToronto\nNY00506\nNew York\nHydroelectric\n103\n25211\nHigh\n2023-08-04\nYes\n2021-11-02\nEagle Creek Hydro Power, LLC\n\n\n10\nNarraguinnep - Main Dam\nCO01089\nColorado\nIrrigation\n114\n22700\nHigh\n2023-05-23\nYes\n2021-05-27\nMONTEZUMA VALLEY IRRIGATION CO.\n\n\n11\nSmith\nOR00541\nOregon\nHydroelectric\n235\n17530\nHigh\n2023-04-11\nYes\n2022-12-31\nEugene Water and Electric Board\n\n\n12\nFletcher Tailings Dam\nMO30160\nMissouri\nTailings\n201\n5333\nHigh\n2007-12-21\nYes\n2018-05-01\nDOE RUN COMPANY\n\n\n13\nClear Branch\nOR00451\nOregon\nIrrigation\n110\n5290\nHigh\n2023-04-11\nYes\n2022-12-06\nMiddle Fork Irrigation District\n\n\n14\nHosler (Reeder Gulch\nOR00110\nOregon\nWater Supply\n114\n888\nHigh\n2023-04-11\nYes\n2023-01-05\nCity of Ashland\n\n\n15\nCat Creek\nNV10101\nNevada\nWater Supply\n123\n155\nHigh\n2022-10-02\nYes\n2007-10-02\nHawthorne Army Depot",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Risks</span>"
    ]
  },
  {
    "objectID": "risk.html#dams-for-which-an-eap-is-mandated",
    "href": "risk.html#dams-for-which-an-eap-is-mandated",
    "title": "3  Risks",
    "section": "3.2 Dams for which an EAP is mandated",
    "text": "3.2 Dams for which an EAP is mandated\n\nEmergency Action Plan (EAP Prepared) Indicating whether this dam has an Emergency Action Plan (EAP) developed by the dam owner. An EAP is defined as a plan of action to be taken to reduce the potential for property damage and loss of life in an area affected by a dam failure or large flood.\n\nYes\nNo\nNot Required (by regulatory agency)\n\nIf an EAP is required (or not required) and has one, it will be listed as Yes. If an EAP is required and does not have one, it will be listed as No. If there is not an EAP and one is not required, it will be listed as Not Required.1\n\n\n\nShow the code\ndta_for_plot &lt;- dams_no_geo |&gt;\n  count(hazardId, eapId)\n\ndta_for_plot |&gt;\n  ggplot() +\n  geom_col(aes(n, hazardId, fill = eapId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    title = \"Hazard level: count by\\nemergency action plan (EAP) status\",\n    x = NULL,\n    y = NULL,\n    caption = my_caption\n    \n  )\n\n\n\n\n\n\n\n\n\n\n\nShow the code\ndams_no_geo |&gt;\n  count(hazardId, eapId) |&gt;\n  mutate(prop_of_hazardId = n / sum(n),\n         .by = hazardId) |&gt;\n  filter(eapId %in% c(\"Yes\", \"No\")) |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Dam hazard level and Emergency Action Plan**\")) |&gt;\n  fmt_percent(columns = prop_of_hazardId,\n              decimals = 0) |&gt;\n  cols_align(columns = c(hazardId, eapId),\n             align = \"left\")\n\n\n\n\n\n\n\n\n\n\n\nDam hazard level and Emergency Action Plan\n\n\nhazardId\neapId\nn\nprop_of_hazardId\n\n\n\n\nUndetermined\nNo\n2922\n77%\n\n\nUndetermined\nYes\n93\n2%\n\n\nLow\nNo\n5420\n10%\n\n\nLow\nYes\n1540\n3%\n\n\nSignificant\nNo\n3809\n34%\n\n\nSignificant\nYes\n4592\n41%\n\n\nHigh\nNo\n2523\n16%\n\n\nHigh\nYes\n11962\n75%\n\n\n\n\n\n\n\n\nTable 3.2: Dam hazard level and Emergency Action Plan",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Risks</span>"
    ]
  },
  {
    "objectID": "risk.html#footnotes",
    "href": "risk.html#footnotes",
    "title": "3  Risks",
    "section": "",
    "text": "NID data dictionary↩︎",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Risks</span>"
    ]
  },
  {
    "objectID": "asce-grades.html",
    "href": "asce-grades.html",
    "title": "4  Infrastructure grades",
    "section": "",
    "text": "Each year the American Society of Civil Engineers (ASCE) brings attention to our national infrastructure systems by grading them and summarizing projected funding levels and funding gaps1. From the 2025 summary:\nThe 2025 report2 includes projections for the ten years 2024-2033 for dams and other kinds of infrastructure. Dams are graded “D+” and as a category are second only to levees in the smallest portion of the need being funded (Figure 4.2 panel B).\nRoads have a similar grade (“D”) and have a projected spending need 12 times and projected gap four times that for dams (Figure 4.1). Note that ports have a higher grade than inland waterways, but the ASCE doesn’t publish separate funding estimates).\nPlotting projected funding gap by projected need (Figure 4.2), roads and energy emerge as the biggest holes. Dams are almost lost in the small noise–thought I’m sure that isn’t how people living downstream of dams with high hazards see it (Chapter 3 Risks).",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Infrastructure grades</span>"
    ]
  },
  {
    "objectID": "asce-grades.html#footnotes",
    "href": "asce-grades.html#footnotes",
    "title": "4  Infrastructure grades",
    "section": "",
    "text": "https://infrastructurereportcard.org/cat-item/dams-infrastructure/ ↩︎\nACSE A Comprehensive Assessment of America’s Infrastructure: 2025 report card for America’s infrastructure, page 8.↩︎",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Infrastructure grades</span>"
    ]
  },
  {
    "objectID": "maps.html",
    "href": "maps.html",
    "title": "5  Maps",
    "section": "",
    "text": "5.1 Dams by height\nLet’s start with two choropleth maps: Figure 5.1 shows number of dams and square miles per dam in each state. It’s a plot of 86,351 dams in the National Inventory of Dams (NID) in the continental USA.\nStates with the fewest dams are small (NJ, RI, VT) or very dry (ID, AZ, NM). States with the most dams are wet, large and/or had a compelling need for flood control (MS, GA, TX, MO).\nThe states with the fewest square miles per dam come from New England states (CT, RI, MA) and (because there are so many dams: MS). The dry states in the west (ID, NV, AZ, NM) have the most square miles per dam:\nPlotting dam locations colored by purpose in Figure 5.2, even without showing state state borders, we can see some regional and state differences1:\nFigure 5.3 makes the clusters by region and state easier to see.\nA similar map colored by damHeight (Figure 5.4) makes visible other patterns:\nShow the code\ndta_for_plot &lt;- dams |&gt;\n            mutate(n_nidHeightId = n(),\n                   .by = nidHeightId) |&gt;\n            mutate(nidHeightId_label = glue(\"{nidHeightId} (n={n_nidHeightId})\"),\n                   nidHeightId_label = fct_reorder(nidHeightId_label, -n_nidHeightId))\n\nggplot() +\n  geom_sf(data = dta_for_plot,\n          aes(color = nidHeightId_label),\n          size = 0.01,\n          alpha = 0.5) +\n  guides(color = guide_legend(override.aes = list(size = 3),\n                              position = \"inside\")) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.9, 0.3)) +\n  labs(\n    title = \"Dams in in the National Inventory of Dams - colored by `damHeight`\",\n    subtitle = \"Continental USA\",\n    caption = my_caption,\n    color = \"Dam height\"\n  )\n\n\n\n\n\n\n\n\nFigure 5.4: Map of dams colored by damHeight in the continental states\nAgain the same information faceted (Figure 5.5) make some patterns easier to see.\nShow the code\nggplot() +\n  geom_sf(data = state_boundaries_sf,\n          color = \"grey50\",\n          linewidth = 0.1,\n          fill = NA) +\n  geom_sf(data = dta_for_plot,\n          aes(color = nidHeightId_label),\n          size = 0.01,\n          alpha = 0.5) +\n  guides(color = \"none\") +\n  facet_wrap( ~ nidHeightId_label, ncol = 3) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank()) +\n  labs(\n    title = \"Dams faceted by height (`nidHeightId`)\",\n    subtitle = \"Continental USA\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 5.5: Map of dams in the continental USA by damHeight",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Maps</span>"
    ]
  },
  {
    "objectID": "maps.html#dams-by-height",
    "href": "maps.html#dams-by-height",
    "title": "5  Maps",
    "section": "",
    "text": "There are a lot of small dams &lt; 25 ft high along the east coast and in the north central and north east.\nThere is a cluster of big dams in and around the Tennessee Valley and in the Sierra Nevada mountains of California.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Maps</span>"
    ]
  },
  {
    "objectID": "maps.html#big-dams",
    "href": "maps.html#big-dams",
    "title": "5  Maps",
    "section": "5.2 Big dams",
    "text": "5.2 Big dams\nThe NID categorizes dams by height in nidHeightId. The tallest category includes dams that are more than 100 ft high. Let’s call them “big dams”.\n\n\nShow the code\nn_big_dams &lt;- dams |&gt;\n  filter(big_dam) |&gt;\n  nrow()\n\nggplot() +\n  geom_sf(data = state_boundaries_sf,\n          color = \"grey50\",\n          fill = NA) +\n  geom_sf(data = dams |&gt;\n            filter(big_dam) |&gt;\n            mutate(n_primaryPurposeId = n(),\n                   .by = primaryPurposeId) |&gt;\n            mutate(primaryPurposeId = glue(\"{primaryPurposeId} (n={n_primaryPurposeId})\"),\n                   primaryPurposeId = fct_reorder(primaryPurposeId, -n_primaryPurposeId)),\n          aes(color = primaryPurposeId),\n          size = 1,\n          alpha = 0.75) +\n  guides(color = guide_legend(override.aes = list(size = 3),\n                              position = \"inside\")) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.9, 0.3)) +\n  labs(\n    title = glue(\"There are {n_big_dams} big dams in in the National Inventory of Dams\"),\n    subtitle = \"Continental USA\",\n    caption = my_caption,\n    color = \"Primary purpose\"\n  )\n\n\n\n\n\n\n\n\nFigure 5.6: Map of big dams in the continental USA\n\n\n\n\n\n\nFaceting by their primaryPurpose (Figure 5.7) makes the patterns easier to see.\n\n\nShow the code\ndta_for_plot &lt;- dams |&gt;\n            filter(big_dam) |&gt;\n            mutate(n_primaryPurposeId = n(),\n                   .by = primaryPurposeId) |&gt;\n            mutate(primaryPurposeId_label = glue(\"{primaryPurposeId} (n={n_primaryPurposeId})\"),\n                   primaryPurposeId_label = fct_reorder(primaryPurposeId_label, -n_primaryPurposeId))\n\nggplot() +\n  geom_sf(data = state_boundaries_sf,\n          color = \"grey50\",\n          linewidth = 0.1,\n          fill = NA) +\n  geom_sf(data = dta_for_plot,\n          aes(color = primaryPurposeId_label),\n          size = 0.5,\n          alpha = 0.5) +\n  guides(color = \"none\") +\n  facet_wrap( ~ primaryPurposeId_label, ncol = 3) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank()) +\n  labs(\n    title = \"Big dams faceted by primary purpose\",\n    subtitle = \"Continental USA\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 5.7: Map of big dams by primary purpose\n\n\n\n\n\n\nMost of the big dams (Figure 5.8) are primarily for flood risk reduction, water supply, hydroelectric power, and to hold mine tailings.\n\n\nShow the code\ndta_for_plot2 &lt;- dta_for_plot |&gt;\n  distinct(primaryPurposeId_label, n_primaryPurposeId)\n\nn_dams &lt;- sum(dta_for_plot2$n_primaryPurposeId)\npct80 &lt;- round(n_dams * 0.8)\n\ndta_for_plot2 |&gt;\n  arrange(desc(n_primaryPurposeId)) |&gt;\n  mutate(primaryPurposeId_label = fct_reorder(primaryPurposeId_label, n_primaryPurposeId),\n         cum_n = cumsum(n_primaryPurposeId)) |&gt;\n  ggplot(aes(cum_n, primaryPurposeId_label, group = cum_n)) +\n  # geom_line() +\n  geom_vline(xintercept = pct80,\n             lty = 2, linewidth = 0.2, alpha = 0.5) +\n  geom_point() +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  expand_limits(x = 0) +\n  theme(plot.title.position = \"plot\") +\n  labs(\n    title = \"Count of big dam's primary purpose\",\n    subtitle = glue(\"Vertical line is 80% ({pct80}) of the {n_dams} big dams\"),\n    y = NULL,\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 5.8: Map of big dams in the continental USA\n\n\n\n\n\n\nThere are more insights to be gleaned by looking at other numerical distributions and summaries. That’s the focus of the next chapter.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Maps</span>"
    ]
  },
  {
    "objectID": "maps.html#footnotes",
    "href": "maps.html#footnotes",
    "title": "5  Maps",
    "section": "",
    "text": "Some differences may be due to differences in state-level policies related to data collection than to the number of dams; others may be due to geographical differences, since it was common to put borders where the geography changes.↩︎",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Maps</span>"
    ]
  },
  {
    "objectID": "numbers.html",
    "href": "numbers.html",
    "title": "6  Numbers",
    "section": "",
    "text": "6.1 Volume of water under management\nPerhaps the most important metric for dams is the amount of water1 stored by the dam. I think of this as “water under management”. It’s interesting to look at this by primary owner and primary purpose (Figure 6.1), and by state (Figure 6.2).\nShow the code\ndta_for_storage &lt;- dams_no_geo |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  filter(!is.na(nidStorage))\n\nstorage_by_primary_purpose &lt;- dta_for_storage |&gt;\n  filter(nidId != \"MI00650\") |&gt;\n  mutate(primaryOwnerTypeId = if_else(primaryOwnerTypeId == \"Tribal Government\",\n                                      \"Other or not specified\",\n                                      primaryOwnerTypeId)) |&gt;\n  count(primaryPurposeId, primaryOwnerTypeId, wt = nidStorage) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, n, sum),\n         primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum))\n\nstorage_by_primary_owner &lt;- dta_for_storage |&gt;\n  filter(nidId != \"MI00650\") |&gt;\n  mutate(primaryOwnerTypeId = if_else(primaryOwnerTypeId == \"Tribal Government\",\n                                      \"Other or not specified\",\n                                      primaryOwnerTypeId)) |&gt;\n  count(primaryOwnerTypeId, wt = nidStorage) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum))\n\nstorage_by_state &lt;- dta_for_storage |&gt;\n  count(state, state_abb, wt = nidStorage) |&gt;\n  mutate(state = fct_reorder(state, n),\n         state_abb = fct_reorder(state_abb, n)\n         )\n\nstorage_by_state_mi_corrected &lt;- dta_for_storage |&gt;\n  filter(nidId != \"MI00650\") |&gt;\n  count(state, state_abb, wt = nidStorage) |&gt;\n  mutate(state = fct_reorder(state, n),\n         state_abb = fct_reorder(state_abb, n)\n         )\nShow the code\np1 &lt;- storage_by_primary_purpose |&gt;\n  filter(primaryOwnerTypeId != \"Tribal Government\") |&gt;\n  ggplot(aes(n, primaryPurposeId)) +\n  geom_col(aes(fill = primaryOwnerTypeId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.04))) +\n  scale_fill_viridis_d(end = 0.9) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse =  TRUE)) +\n  theme(legend.position.inside = c(0.6, 0.4)) +\n  labs(\n    subtitle = \"A: Primary purpose\",\n    x = \"acre ft\",\n    y = NULL,\n    fill = \"Primary owner\"\n  )\n\np2 &lt;- storage_by_primary_owner |&gt;\n  ggplot(aes(n, primaryOwnerTypeId)) +\n  geom_col() + #aes(fill = primaryPurposeId)) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.04))) +\n  labs(\n    subtitle = \"B: Primary owner\",\n    x = \"acre ft\",\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Primary purpose and primary owner\\nby amount of water under management (nidStorage)\",\n    subtitle = \"Continental USA. Michigan corrected\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.1: primaryPurpose and primaryOwner by volume of water being managed (nidStorage)\nThe amount of water under management by state needs a correction before we can use it. In Figure 6.2 panel A, Michigan is shown as having so much more water under management than other states because of one structure: Soo Locks in Sault Ste. Marie (nidID MI00650), through which ships travel between Lake Superior and the other Great Lakes. Because of Soo Locks, Michigan “claims” nearly 278M acre-feet of water in Lake Superior. Removing this one structure in panel B moves Michigan down the ranking to 42 of 48 states. Where I’m not looking at nidStorage, I leave Soo Locks in the data sets. Where I remove it, the plot includes the note: “Michigan corrected”.\nFor other state-level data see Section 6.7 below.\nShow the code\nn_states &lt;- nrow(storage_by_state)\np1 &lt;- storage_by_state |&gt;\n  ggplot(aes(n, state)) +\n  geom_col() +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.04))) +\n  labs(\n    subtitle = glue(\"A: {n_states} states\"),\n    x = \"acre ft\",\n    y = NULL\n  )\n\np2 &lt;- storage_by_state_mi_corrected |&gt;\n  ggplot(aes(n, state)) +\n  geom_col() +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.04))) +\n  labs(\n    subtitle = glue(\"B: {n_states} states (Michigan corrected)\"),\n    x = \"acre ft\",\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"State by amount of water under management (nidStorage)\",\n    subtitle = \"Continental USA\",caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.2: Volume of water under management by state (nidStorage)",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#sec-other-metrics",
    "href": "numbers.html#sec-other-metrics",
    "title": "6  Numbers",
    "section": "6.2 Other primary dam metrics",
    "text": "6.2 Other primary dam metrics\nPrimary dam metrics are log-normal-ish and vary over nearly seven orders of magnitude: damHeight, damLength, maxDischarge, nidStorage, surfaceArea, and drainageArea (Figure 6.3). The latter seems like it might be a composite of two log-normal distributions. Indeed, big dams seem to be supplying a distinct distribution (Figure 6.4).\n\n\nShow the code\ndta_for_plot &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  select(name, state, big_dam, nidId, nidStorage, nidHeight, damLength, surfaceArea, drainageArea, maxDischarge) |&gt;\n  filter(nidId != \"MI00650\") |&gt;\n  filter(damLength &gt; 10)\n\nn_dams_allft &lt;- nrow(dta_for_plot)\n\ndta_for_plot_long &lt;- dta_for_plot |&gt;\n  pivot_longer(\n    cols = nidStorage:maxDischarge,\n    names_to = \"metric\",\n    values_to = \"value\"\n  ) |&gt;\n  filter(value &gt; 0) |&gt;\n  mutate(metric_label = case_match(\n    metric,\n    \"damLength\"        ~ \"dam length (ft)\",\n    \"nidHeight\"        ~ \"dam height (ft)\",\n    \"drainageArea\"     ~ \"drainage area (mi^2)\",\n    \"maxDischarge\"     ~ \"max discharge (ft^3/sec)\",\n    \"surfaceArea\"      ~ \"surface area (acre)\",\n    \"nidStorage\"       ~ \"storage (acre-feet)\",\n    .default = glue(\"error: {metric}\")\n  ))\n\ndta_for_plot_medians = dta_for_plot_long |&gt;\n  reframe(value = median(value),\n          n_dams = n(),\n          label_y = 0.3 * max(value, na.rm = TRUE),\n            .by = metric_label)\n\ndta_for_plot_long |&gt;\n  ggplot() +\n  geom_histogram(aes(value),\n                 bins = 30,\n                 na.rm = TRUE) +\n  geom_vline(data = dta_for_plot_medians,\n             aes(xintercept = value),\n             lty = 2,\n             linewidth = 0.25,\n             alpha = 0.5,\n             na.rm = TRUE) +\n  geom_label(data = dta_for_plot_medians,\n            aes(x = Inf, y = Inf, label = glue(\"n = {n_dams}\\nmedian = {round(value, digits = 1)}\")),\n            hjust = 1, vjust = 1,\n            size = 3,\n            na.rm = TRUE\n            ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale()),\n                expand = expansion(mult = c(0, 0.04))) +\n  facet_wrap(~metric_label, scales = \"free_x\") +\n  labs(\n    title = \"Primary dam metrics \",\n    subtitle = glue(\"Includes the portion of the {n_dams_allft} dams that are not missing values, which varies by metric\",\n                    \"\\nContinental USA. Michigan corrected.\"),\n    x = NULL,\n    y = \"Number of dams\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.3: Histograms of primary dam metrics\n\n\n\n\n\n\nFor big dams, damHeight and maxDischarge are one end of the distribution. The other big dam metric distributions are log-normal-ish.\n\n\nShow the code\ndta_for_plot &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  select(name, state, big_dam, nidId, nidStorage, nidHeight, damLength, surfaceArea, drainageArea, maxDischarge) |&gt;\n  filter(big_dam) |&gt;\n  filter(nidId != \"MI00650\") |&gt;\n  filter(damLength &gt; 10)\n\ndta_for_plot_long &lt;- dta_for_plot |&gt;\n  pivot_longer(\n    cols = nidStorage:maxDischarge,\n    names_to = \"metric\",\n    values_to = \"value\"\n  ) |&gt;\n  filter(value &gt; 0) |&gt;\n  mutate(metric_label = case_match(\n    metric,\n    \"damLength\"    ~ \"dam length (ft)\",\n    \"nidHeight\"    ~ \"dam height (ft)\",\n    \"drainageArea\" ~ \"drainage area (mi^2)\",\n    \"maxDischarge\" ~ \"max discharge (ft^3/sec)\",\n    \"surfaceArea\"  ~ \"surface area (acre)\",\n    \"nidStorage\"   ~ \"storage (acre-feet)\",\n    .default = glue(\"error: {metric}\")\n  ))\n\ndta_for_plot_medians = dta_for_plot_long |&gt;\n  reframe(value = median(value),\n          n_dams = n(),\n          .by = metric_label)\n\nn_dams_big &lt;- nrow(dta_for_plot)\n\ndta_for_plot_long |&gt;\n  ggplot() +\n  geom_histogram(aes(value),\n                 bins = 30) +\n  geom_vline(data = dta_for_plot_medians,\n             aes(xintercept = value),\n             lty = 2,\n             linewidth = 0.25,\n             alpha = 0.5) +\n  geom_label(data = dta_for_plot_medians,\n            aes(x = Inf, y = Inf, label = glue(\"n = {n_dams}\\nmedian = {round(value, digits = 1)}\")),\n            hjust = 1, vjust = 1,\n            size = 3) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  facet_wrap(~metric_label, scales = \"free_x\") +\n  labs(\n    title = \"Big dams: primary dam metrics\",\n    subtitle = glue(\"Includes the portion of the {n_dams_big} dams that are not missing values, which varies by metric\",\n                    \"\\nContinental USA. Michigan corrected.\"),\n    x = NULL,\n    y = \"Number of dams\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.4: Primary dam metrics for big dams",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#counts",
    "href": "numbers.html#counts",
    "title": "6  Numbers",
    "section": "6.3 Counts",
    "text": "6.3 Counts\nA plurality of dams are privately owned, for recreation, and made of earth (Figure 9.5).\n\n\nShow the code\np1 &lt;- dams_no_geo |&gt;\n  count(primaryOwnerTypeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n),\n         n_pct = `n` / sum(`n`)) |&gt;\n  ggplot(aes(n, primaryOwnerTypeId)) +\n  geom_col() +\n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"A: Primary owner type\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dams_no_geo |&gt;\n  count(primaryPurposeId) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, n),\n         n_pct = `n` / sum(`n`)) |&gt;\n  ggplot(aes(n, primaryPurposeId)) +\n  geom_col() +\n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"B: Primary purpose\",\n    x = NULL,\n    y = NULL\n  )\n\np3 &lt;- dams_no_geo |&gt;\n  count(primaryDamTypeId) |&gt;\n  mutate(primaryDamTypeId = fct_reorder(primaryDamTypeId, n),\n         n_pct = `n` / sum(`n`)) |&gt;\n  ggplot(aes(n, primaryDamTypeId)) +\n  geom_col() + \n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"C: Primary dam type\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Basic counts: owner, purpose, dam type\",\n    caption = my_caption\n  ) & theme(plot.title.position = \"plot\")\n\n\n\n\n\n\n\n\nFigure 6.5: Basic counts: owner, purpose, dam type\n\n\n\n\n\n\nBig dam proportions differ from the set of all dams (Figure 6.6) in the following ways:\n\nA smaller proportion of big dams are privately owned (only 37% compared to 64%)\nRecreation is not a major purpose. Instead flood risk control, water supply, and hydroelectric dominate the purposes (combined they are 60%)\nThere is more diversity in the dam type, since most small dams are made of earth\n\n\n\nShow the code\np1 &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt;\n  count(primaryOwnerTypeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n),\n         n_pct = `n` / sum(`n`)) |&gt;\n  ggplot(aes(n, primaryOwnerTypeId)) +\n  geom_col() +\n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"A: Primary owner type\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt;\n  count(primaryPurposeId) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, n),\n         n_pct = `n` / sum(`n`)) |&gt;\n  ggplot(aes(n, primaryPurposeId)) +\n  geom_col() +\n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"B: Primary purpose\",\n    x = NULL,\n    y = NULL\n  )\n\np3 &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt;\n  count(primaryDamTypeId) |&gt;\n  mutate(primaryDamTypeId = fct_reorder(primaryDamTypeId, n),\n         n_pct = `n` / sum(`n`)) |&gt;\n  ggplot(aes(n, primaryDamTypeId)) +\n  geom_col() + \n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"C: Primary dam type\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Big dam basic counts: owner, purpose, dam type\",\n    subtitle = \"Includes dams with height &gt; 100 ft\",\n    caption = my_caption\n  ) & theme(plot.title.position = \"plot\")\n\n\n\n\n\n\n\n\nFigure 6.6: Big dam basic counts: owner, purpose, dam type\n\n\n\n\n\n\nA matrix of primaryPurpose and primaryOwner make visible the most common combinations (Figure 6.7).\n\n\nShow the code\nowner_purpose &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  complete(primaryOwnerTypeId, primaryPurposeId, fill = list(n = 0)) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, -n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum))\n\nowner_purpose |&gt;\n  ggplot(aes(x = primaryOwnerTypeId, y = primaryPurposeId)) +\n  geom_tile(aes(fill = n),\n            alpha = 0.98) +\n  geom_text(aes(label = n),\n            color = \"white\",\n             size = 3) +\n  theme(plot.title.position = \"plot\",\n        axis.text.x = element_text(angle = 60, hjust = 0)\n        ) +\n  scale_x_discrete(position = \"top\") +\n  scale_fill_continuous(transform = scales::transform_log1p(),\n                        breaks = c(0, 10, 100, 1000, 10000)) +\n  labs(\n    title = \"Primary purpose by primary owner type - count\",\n    x = \"Primary owner\",\n    y = \"Primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.7: Primary purpose by primary owner type - count\n\n\n\n\n\n\nThe top ten combinations are shown below (Table 6.1):\n\n\nShow the code\nowner_purpose |&gt;\n  slice_max(order_by = n, n = 10) |&gt;\n  mutate(idx = row_number()) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 11) |&gt;\n  tab_header(md(\"**Top 10 combinations of primary owner type and primary purpose**\")) |&gt;\n  cols_align(columns = c(starts_with(\"primary\")),\n             align = \"left\") |&gt;\n  fmt_number(columns = n,\n             decimals = 0)\n\n\n\n\nTable 6.1\n\n\n\n\n\n\n\n\n\nTop 10 combinations of primary owner type and primary purpose\n\n\nprimaryOwnerTypeId\nprimaryPurposeId\nn\nidx\n\n\n\n\nPrivate\nRecreation\n23,975\n1\n\n\nLocal Government\nFlood Risk Reduction\n8,734\n2\n\n\nPrivate\nFire Protection, Stock, Or Small Fish Pond\n8,136\n3\n\n\nPrivate\nOther or not specified\n7,982\n4\n\n\nPrivate\nIrrigation\n6,356\n5\n\n\nLocal Government\nRecreation\n3,088\n6\n\n\nState\nFlood Risk Reduction\n2,730\n7\n\n\nPrivate\nFlood Risk Reduction\n2,409\n8\n\n\nState\nRecreation\n2,322\n9\n\n\nLocal Government\nWater Supply\n2,168\n10\n\n\n\n\n\n\n\n\n\n\n\nLarge dams, by contrast, are mostly federally owned and for flood reduction, whereas local governments’ dams are mostly for water supply, and public utility-owned dams are mostly for electricity generation (Figure 6.8).\n\n\nShow the code\nowner_purpose_big &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt; # only \"big\" dams\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  complete(primaryOwnerTypeId, primaryPurposeId, fill = list(n = 0)) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, -n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum))\n\nowner_purpose_big |&gt;\n  ggplot(aes(x = primaryOwnerTypeId, y = primaryPurposeId)) +\n  geom_tile(aes(fill = n),\n            alpha = 0.98) +\n  geom_text(aes(label = n),\n            color = \"white\",\n             size = 3) +\n  theme(plot.title.position = \"plot\",\n        axis.text.x = element_text(angle = 60, hjust = 0)\n        ) +\n  scale_x_discrete(position = \"top\") +\n  scale_fill_continuous(transform = scales::transform_log1p(),\n                        breaks = c(0, 10, 100, 1000, 10000)) +\n  labs(\n    title = \"Big dams: primary purpose by primary owner type - count\",\n    subtitle = \"'Big' dam defined as having height &gt;= 100 ft\",\n    x = \"Primary owner\",\n    y = \"Primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.8: Primary purpose by primary owner type - count\n\n\n\n\n\n\nThe most common combinations for big dams are shown below:\n\n\nShow the code\nowner_purpose_big |&gt;\n  slice_max(order_by = n, n = 10) |&gt;\n  mutate(idx = row_number()) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 11) |&gt;\n  tab_header(md(\"**Big dams: top 10 combinations of primary owner type and primary purpose**&lt;br&gt;Dams with height &gt; 100 ft\")) |&gt;\n  cols_align(columns = c(starts_with(\"primary\")),\n             align = \"left\") |&gt;\n  fmt_number(columns = n,\n             decimals = 0)\n\n\n\n\nTable 6.2\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nBig dams: top 10 combinations of primary owner type and primary purposeDams with height &gt; 100 ft\n\n\nprimaryOwnerTypeId\nprimaryPurposeId\nn\nidx\n\n\n\n\nFederal\nFlood Risk Reduction\n292\n1\n\n\nPrivate\nTailings\n229\n2\n\n\nLocal Government\nWater Supply\n140\n3\n\n\nPrivate\nHydroelectric\n94\n4\n\n\nPublic Utility\nHydroelectric\n93\n5\n\n\nPublic Utility\nWater Supply\n75\n6\n\n\nPrivate\nOther or not specified\n73\n7\n\n\nFederal\nIrrigation\n59\n8\n\n\nLocal Government\nFlood Risk Reduction\n52\n9\n\n\nFederal\nHydroelectric\n49\n10\n\n\n\n\n\n\n\n\n\n\n\nAlluvial plots provide a bird’s eye view of counts of multiple properties. I go deeper into North Carolina dams in Chapter 7 Owners in NC exclusively using this kind of plot.\n\n\nShow the code\n# following example at https://mjfrigaard.github.io/fm-ggp2/alluvial_charts.html\n\ndams_wide &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  # filter(nidHeightId == \"Greater than 100 ft\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId) |&gt;\n  filter(primaryOwnerTypeId != \"Other or not specified\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, 9)) |&gt;\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)\n  )\n\np1 &lt;- dams_wide |&gt;\n  ggplot(aes(axis1 = primaryOwnerTypeId, \n             axis2 = primaryPurposeId,\n             y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    subtitle = \"A. All dams\",\n    y = NULL\n  )\n\np1 +\n  plot_annotation(\n    title = \"Dams in continental US by primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.9: Dams by owner and purpose\n\n\n\n\n\n\n\n\nShow the code\n# following example at https://mjfrigaard.github.io/fm-ggp2/alluvial_charts.html\n\nbig_dams_wide &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  select(nidId, big_dam, primaryOwnerTypeId, primaryPurposeId) |&gt;\n  filter(big_dam, \n         primaryOwnerTypeId != \"Other or not specified\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, 7)) |&gt;\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)\n  )\n\np1 &lt;- big_dams_wide |&gt;\n  ggplot(aes(axis1 = primaryOwnerTypeId, \n             axis2 = primaryPurposeId,\n             y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    subtitle = \"A. All dams\",\n    y = NULL\n  )\n\np1 +\n  plot_annotation(\n    title = \"Big dams in continental US by primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.10: Big dams by owner and purpose",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#sec-ratios",
    "href": "numbers.html#sec-ratios",
    "title": "6  Numbers",
    "section": "6.4 Ratios",
    "text": "6.4 Ratios\nRatios are one thing expressed as a multiple of the other, i.e., divided by the other. Let’s look at surfaceArea::nidStorage. Dams built in hilly areas seem to me to be more likely to have low ratios of surfaceArea to nidStorage, i.e., the dams are likely to be deeper rather than broader. Can we substantiate or disprove this conjecture?\nFirst, some scatter plots in Figure 6.11:\n\nPanel A provides context: state population by area.\nPanel B plots the number dams in each state by state area.\nPanel C plots number of dams in the state by state population.\nAnd panel D plots dam storage (nidStorage) by number of dams in the state.\n\nIn each plot one or more regional clusters are visible.\n\n\nShow the code\np1 &lt;- dams_by_state_with_pop |&gt;\n  ggplot() +\n  geom_text(aes(usgs_total_area_less_great_lakes, pop, label = state_abb, color = state_region),\n            check_overlap = FALSE,\n            show.legend = FALSE,\n            key_glyph = \"point\") +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  labs(\n    subtitle = \"A: Population by surface area\",\n    x = \"State area (sq mi)\",\n    y = \"Population\"\n  )\n\np2 &lt;- dams_by_state_with_pop |&gt;\n  ggplot() +\n  geom_text(aes(usgs_total_area_less_great_lakes, n, label = state_abb, color = state_region),\n            check_overlap = FALSE,\n            key_glyph = \"point\") +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(size = 3))) +\n  theme(legend.position.inside = c(0.8, 0.7)) +\n  labs(\n    subtitle = \"B: Number of dams by area\",\n    x = \"State area (sq mi)\",\n    y = \"Number of dams in the NID\"\n  )\n\np3 &lt;- dams_by_state_with_pop |&gt;\n  ggplot() +\n  geom_text(aes(pop, n, label = state_abb, color = state_region),\n            check_overlap = FALSE,\n            show.legend = FALSE,\n            key_glyph = \"point\") +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  labs(\n    subtitle = \"C: Number of dams by population\",\n    x = \"Population\",\n    y = \"Number of dams in the NID\"\n  )\n\np4 &lt;- dams_by_state_with_pop |&gt;\n  left_join(\n    storage_by_state_mi_corrected |&gt;\n      select(state_abb, nidStorage = n),\n    by = \"state_abb\"\n  ) |&gt;\n  ggplot() +\n  geom_text(aes(n, nidStorage, label = state_abb, color = state_region),\n            check_overlap = FALSE,\n            show.legend = FALSE,\n            key_glyph = \"point\") +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  labs(\n    subtitle = \"D: Dams' volume of water under management\",\n    x = \"Number of dams in the NID\",\n    y = \"nidStorage (acre ft)\"\n  )\n\np1 + p2 + p3 + p4 +\n  plot_annotation(\n    title = \"State land area, population, and number of dams\",\n    subtitle = \"Area less Great Lakes (if applicable). Michigan corrected.\",\n    caption = my_caption_nid_census\n  )\n\n\n\n\n\n\n\n\nFigure 6.11: State land area, population, and number of dams\n\n\n\n\n\n\nFigure 6.12 below plots the ratio of surfaceArea to water under management (nidStorage) using medians (panels A and C) and means (panels B and C). In the plots that employ means, outliers and data errors have more effect. For example, in panel B Washington (WA), Colorado (CO) and Oregon (OR) are higher in the plot, from which I infer that each state has some large, shallow reservoirs (or large data errors).\nI found and removed two data errors for New Mexico. Note the reported discrepancy in damHeight and nidStorage for these two dams with very large surfaceArea when they are placed in context with the ten dams in NM with the most surface area (Table 6.3).\n\nShow the code\ndams_no_geo |&gt;\n  filter(state_abb == \"NM\") |&gt;\n  slice_max(order_by = surfaceArea,\n            n = 10) |&gt;\n  select(name, nidId, surfaceArea, nidHeight, nidStorage) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 10) |&gt;\n  tab_header(md(glue(\"**Dams in New Mexico with largest reported `surfaceArea`**\",\n                     \"&lt;br&gt;*Acres. Click column headers to sort*\"))) |&gt;\n  tab_source_note(md(glue(\"*Source: NID. Table: Daniel Moul.*\"))) |&gt;\n  fmt_number(columns = c(surfaceArea, nidHeight, nidStorage),\n             decimals = 0) |&gt;\n  tab_style(\n    style = list(\n      cell_fill(color = \"lightyellow\")\n    ),\n    locations = cells_body(\n      rows = str_detect(name, \"Encino\") | str_detect(name, \"Alamos\")\n    )\n    ) |&gt;\n  opt_interactive(\n    use_pagination = FALSE\n  )\n\n\n\n\n\n\n\nDams in New Mexico with largest reported surfaceAreaAcres. Click column headers to sort\n\n\n\n\n\n\nSource: NID. Table: Daniel Moul.\n\n\n\n\n\n\n\n\nTable 6.3: Dams in New Mexico with most reported surfaceArea of water behind dams\n\n\n\n\nThe ratio dam surface area::nidStorage is an indicator of the local geography: a high ratio indicates a wide, shallow reservoir behind the dam; a low ratio indicates a deep reservoir in a valley with steep gradients or perhaps a quarry or other excavated area.\nPlotting median and mean state ratios by state area per dam (Figure 6.12) reveals some regional clusters.\n\n\nShow the code\np1 &lt;- dams_ratios_per_state |&gt;\n  ggplot(aes(sqmi_per_dam, median_surface_area_to_nidStorage, color = state_region)) +\n  geom_text(aes(label = state_abb),\n            check_overlap = FALSE,\n            show.legend = FALSE,\n            key_glyph = \"point\") +\n  geom_mark_hull() +\n  scale_x_log10(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"A: Median(dam surface area::nidStorage) by sq mi per dam\",\n    x = \"State area (sq mi) per dam (log10 scale)\",\n    y = \"Median ratio\"\n  )\n\np2 &lt;- dams_ratios_per_state |&gt;\n  ggplot(aes(sqmi_per_dam, avg_surface_area_to_nidStorage, color = state_region)) +\n  geom_text(aes(label = state_abb),\n            check_overlap = FALSE,\n            show.legend = FALSE,\n            key_glyph = \"point\") +\n  geom_mark_hull() +\n  scale_x_log10(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  scale_y_log10(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.02, 0.04))) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"B: Mean(dam surface area::nidStorage) by sq mi per dam\",\n    x = \"State area (sq mi) per dam (log10 scale)\",\n    y = \"Mean ratio (log10 scale)\"\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"State ratios: median and mean surface area to dam volume\",\n    subtitle = \"Colored by region\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.12: Median and mean state values for ratio of surfaceArea to nidStorage",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#dam-completion-and-modification",
    "href": "numbers.html#dam-completion-and-modification",
    "title": "6  Numbers",
    "section": "6.5 Dam completion and modification",
    "text": "6.5 Dam completion and modification\nPublic dams are major civil works projects that require political will, budgeting, financing, and on-going funding to operate and maintain. Most dams were built after World War II and prior to the Reagan administration in the eighties.\n\n\n6.5.1 New dams\n\n\nShow the code\ndta_for_plot &lt;- dams_no_geo |&gt;\n  select(name, state, nidHeight, nidHeightId, yearCompleted, yearCompletedId, yearsModified)\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_bar(aes(yearCompletedId, fill = nidHeightId)) +\n  # scale_x_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  scale_y_continuous(label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  guides(fill = \"none\") +\n  coord_flip() +\n  theme(plot.title.position = \"plot\") +\n  labs(\n    subtitle = \"A: By decade\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  filter(yearCompletedId != \"Undetermined\") |&gt;\n  ggplot() +\n  geom_vline(xintercept = c(1950, 1979),\n             lty = 2,\n             linewidth = 0.2,\n             alpha = 0.5) +\n  stat_ecdf(aes(yearCompleted)) +\n  scale_x_continuous(breaks = c(1850, 1900, 1950, 1979, 2000)) +\n  scale_y_continuous(label = label_percent(),\n                     expand = expansion(mult = c(0.0, 0.04))) +\n  theme(plot.title.position = \"plot\") +\n  coord_cartesian(xlim = c(1850, NA)) +\n  labs(\n    subtitle = \"B: Cumulative distribution: year completed\",\n    x = NULL,\n    y = \"Percent of all dams with year built data\"\n  )\n\np3 &lt;- dta_for_plot |&gt;\n  filter(yearCompletedId != \"Undetermined\") |&gt;\n  ggplot() +\n  geom_vline(xintercept = c(1950, 1979),\n             lty = 2,\n             linewidth = 0.2,\n             alpha = 0.5) +\n  geom_density(aes(yearCompleted, color = nidHeightId)) +\n  scale_x_continuous(breaks = c(1850, 1900, 1950, 1979, 2000)) +\n  guides(color = \"none\") +\n  theme(plot.title.position = \"plot\") +\n  coord_cartesian(xlim = c(1850, NA)) +\n  labs(\n    subtitle = \"C: Density plot: year completed by height\",\n    x = NULL\n  )\n\np4 &lt;- dta_for_plot |&gt;\n  filter(yearCompletedId != \"Undetermined\") |&gt;\n  ggplot() +\n  geom_vline(xintercept = c(1950, 1979),\n             lty = 2,\n             linewidth = 0.2,\n             alpha = 0.5) +\n  stat_ecdf(aes(yearCompleted, color = nidHeightId)) +\n  scale_x_continuous(breaks = c(1850, 1900, 1950, 1979, 2000)) +\n  scale_y_continuous(label = label_percent(),\n                     expand = expansion(mult = c(0.0, 0.04))) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(plot.title.position = \"plot\",\n        legend.position.inside = c(0.3, 0.7)) +\n  coord_cartesian(xlim = c(1850, NA)) +\n  labs(\n    subtitle = \"D: Cumulative distribution: year completed by dam height\",\n    x = NULL,\n    y = \"Percent of all dams with year built data\"\n  )\n\np1 + p2 + p3 + p4 +\n  plot_annotation(\n    title = \"The heyday of dam building in the US was 1950-1979\",\n    subtitle = \"It's likely that the dams of undetermined nidHeight built since 1950 are small dams (plots C and D).\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.13: Year dams were completed and their height\n\n\n\n\n\n\n\n\n6.5.2 Primary purposes\n\n\nShow the code\nyearCompletedId_levels &lt;- c(\"Before 1900\", \"1900-1909\", \"1910-1919\", \"1920-1929\", \"1930-1939\",\n                            \"1940-1949\", \"1950-1959\", \"1960-1969\", \"1970-1979\", \"1980-1989\",\n                            \"1990-1999\", \"Since 2000\", \"Undetermined\")\n\nyearCompletedId_breaks &lt;- c(\"Before 1900\", # \"1900-1909\", \n                            \"1910-1919\", # \"1920-1929\", \n                            \"1930-1939\", # \"1940-1949\", \n                            \"1950-1959\", # \"1960-1969\", \n                            \"1970-1979\", # \"1980-1989\",\n                            \"1990-1999\" # , \"Since 2000\", \"Undetermined\"\n                            )\n\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region)\n\nyear_build_by_primary_purpose_big_dams &lt;- dams_no_geo |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId, big_dam) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  filter(big_dam) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region)\n\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = primaryPurposeId, group = primaryPurposeId)) +\n  # geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n  #             size = 0.75,\n  #            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  guides(color = guide_legend(#position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_region) +\n  theme(plot.title.position = \"plot\",\n        # legend.position.inside = c(I(0.15), I(0.85)),\n        legend.position = \"bottom\",\n        axis.text.x = element_text(angle = 30, hjust = 1)) +\n  labs(\n    subtitle = \"A: Dams\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- year_build_by_primary_purpose_big_dams |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = primaryPurposeId, group = primaryPurposeId)) +\n  # geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n  #             size = 0.75,\n  #            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  scale_color_viridis_d(end = 0.9) +\n  guides(color = guide_legend(#position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_region) +\n  theme(plot.title.position = \"plot\",\n        # legend.position.inside = c(I(0.15), I(0.85)),\n        legend.position = \"bottom\",\n        axis.text.x = element_text(angle = 30, hjust = 1)) +\n  labs(\n    subtitle = \"B: Big dams\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Most dams were built in the South. Most big dams were built in the West\",\n    subtitle = glue(\"New dams and their primary purpose, by region\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.14: New dams and their primary purpose, by region\n\n\n\n\n\n\n\n\nShow the code\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  filter(state_region == \"South\") |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region, state_abb)\n\nyear_build_by_primary_purpose_big_dams &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt;\n  filter(state_region == \"South\") |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region, state_abb)\n\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = primaryPurposeId, group = primaryPurposeId)) +\n  # geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n  #            size = 0.75,\n  #            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(#label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  guides(color = guide_legend(# position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_abb)  +\n  theme(plot.title.position = \"plot\",\n        # legend.position.inside = c(I(0.15), I(0.85)),\n        legend.position = \"bottom\",\n        axis.text.x = element_text(angle = 30, hjust = 1)) +\n  labs(\n    subtitle = \"A: Dams\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- year_build_by_primary_purpose_big_dams |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = primaryPurposeId, group = primaryPurposeId)) +\n  # geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n  #             size = 0.75,\n  #            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(breaks = 2 * 0:5,\n                     #label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  scale_color_viridis_d(end = 0.9) +\n  guides(color = guide_legend(# position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_abb)  +\n  theme(plot.title.position = \"plot\",\n        # legend.position.inside = c(I(0.15), I(0.85)),\n        legend.position = \"bottom\",\n        axis.text.x = element_text(angle = 30, hjust = 1)) +\n  labs(\n    subtitle = \"B: Big dams\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = glue(\"Most of the dams in the South were built in Texas and Oklahoma\", \n                 \"\\nfor flood risk reduction\"),\n    subtitle = glue(\"New dams in the South, by primary purpose\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    \n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.15: New dams and their purpose (South region)\n\n\n\n\n\n\n\n\nShow the code\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region, state_abb) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, -n, min))\n\ndta_highlight &lt;- year_build_by_primary_purpose |&gt;\n  slice_max(order_by = n, n = 1,\n            by = c(primaryPurposeId))\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, group = state_abb),\n            linewidth = 0.2,\n            alpha = 0.2) + \n  geom_point(data = dta_highlight,\n             aes(yearCompletedId, n, ),\n             size = 2,\n             color = \"steelblue\",\n             show.legend = FALSE) +\n  geom_text(data = dta_highlight,\n            aes(yearCompletedId, n, label = state_abb),\n            nudge_x = 1,\n            color = \"steelblue\",\n            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~primaryPurposeId, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    subtitle = \"A: By decade\",\n    x = NULL,\n    y = NULL\n  )\n\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_abb) |&gt;\n  complete(yearCompletedId, primaryPurposeId, state_abb,\n           fill = list(n = 0)) |&gt;\n  mutate(n_cum = cumsum(n),\n         idx = row_number(),\n         .by = c(primaryPurposeId, state_abb)) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, -n_cum, min))\n\ndta_highlight &lt;- year_build_by_primary_purpose |&gt;\n  filter(yearCompletedId != \"Undetermined\", \n         yearCompletedId == \"Since 2000\") |&gt;\n  slice_max(order_by = n_cum, n = 1,\n            by = primaryPurposeId)\n\np2 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n_cum, group = state_abb),\n            linewidth = 0.2,\n            alpha = 0.2) + \n  geom_text(data = dta_highlight,\n            aes(yearCompletedId, n_cum, label = state_abb),\n            nudge_x = 0.5,\n            color = \"steelblue\",\n            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~primaryPurposeId, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    subtitle = \"B: Cumulative\",\n    x = NULL,\n    y = NULL\n  )\n\np1 / p2 +\n  plot_annotation(\n    title = \"The most common purposes vary by state\\ndue to geography and local priorities\",\n    subtitle = glue(\"New dams in each state, by primary purpose\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.16: New dams in each state, by primary purpose\n\n\n\n\n\n\nUnpacking the “other” category in Figure 6.16 above, Figure 6.17 offers some surprises.\n\nI did not expect New York to have the most hydroelectric dams. Or the most dams for navigation, which appears to be mostly related to the Erie canal “from 1905 to 1918 when the”Barge Canal” was built and over half the original route was abandoned.”2\nMissouri has the most dams for debris control and grade stabilization, presumably due to mining.\nFlorida has the most dams for tailings. I expected another state with a lot of mining to lead here.\n\n\n\nShow the code\nexclude_purposes &lt;- c(\"Recreation\", \"Flood Risk Reduction\", \"Fire Protection, Stock,\\nOr Small Fish Pond\",\n                      \"Irrigation\", \"Water Supply\")\n\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  filter(!primaryPurposeId %in% exclude_purposes) |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_abb) |&gt;\n  complete(yearCompletedId, primaryPurposeId, state_abb,\n           fill = list(n = 0)) |&gt;\n  mutate(n_cum = cumsum(n),\n         idx = row_number(),\n         .by = c(primaryPurposeId, state_abb)) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, -n_cum, min))\n\ndta_highlight &lt;- year_build_by_primary_purpose |&gt;\n  filter(yearCompletedId != \"Undetermined\", \n         yearCompletedId == \"Since 2000\") |&gt;\n  slice_max(order_by = n_cum, n = 1,\n            by = primaryPurposeId)\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n_cum, group = state_abb),\n            linewidth = 0.2,\n            alpha = 0.2) + \n  geom_text(data = dta_highlight,\n            aes(yearCompletedId, n_cum, label = state_abb),\n            nudge_x = 0.5,\n            color = \"steelblue\",\n            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~primaryPurposeId, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    subtitle = \"A: Dams\",\n    x = NULL,\n    y = NULL\n  )\n \np1 +\n  plot_annotation(\n    title = \"New York and Missouri are top states\\nfor two of the 'other' categories\",\n    subtitle = glue(\"'Other' cumulative new dams in each state, by primary purpose\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.17: Unpacking the ‘other’ category\n\n\n\n\n\n\n\n\nShow the code\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region, state_abb)\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = primaryPurposeId, group = primaryPurposeId)) +\n  # geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n  #            size = 0.75,\n  #            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3),\n                              nrow = 1)) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_abb, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    x = NULL,\n    y = NULL\n  )\n\np1 +\n  plot_annotation(\n    title = \"New dams and their primary purpose, by state\",\n    subtitle = glue(\"Includes dams for which purpose and year completed data are available\", \n                    \"\\nY axis scale varies\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.18: New dams and their primary purpose, by state\n\n\n\n\n\n\n\n\nShow the code\nyear_build_by_primary_purpose_big_dams &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt;\n  # filter(state_region == \"South\") |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId,\n                                  levels = yearCompletedId_levels,\n                                  ordered = TRUE)) |&gt;\n  mutate(primaryPurposeId = fct_lump_n(primaryPurposeId, n = 5)) |&gt;\n  count(yearCompletedId, primaryPurposeId, state_region, state_abb)\n\np2 &lt;- year_build_by_primary_purpose_big_dams |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = primaryPurposeId, group = primaryPurposeId)) +\n  geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n              size = 0.75,\n             show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(#breaks = 2 * 0:5,\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  scale_color_viridis_d(end = 0.90) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3),\n                              nrow = 1)) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_abb)  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)) +\n  labs(\n    x = NULL,\n    y = NULL\n  )\n\np2 +\n  plot_annotation(\n    title = \"California has the most big dams\",\n    subtitle = glue(\"New big dams and their primary purpose, by state\",\n                    \"Includes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.19: New big dams and their primary purpose, by state\n\n\n\n\n\n\n\n\n6.5.3 All purposes\nSince dams are often built for multiple purposes, and it can be a judgement call to decide which purpose is “primary”, this section considers all documented purposes.\n\n\nShow the code\npurposes_primary &lt;- dams_no_geo |&gt;\n  count(primaryPurposeId)\n\npurposes_secondary &lt;- dams_no_geo_all_purposes |&gt;\n  count(purpose_id)\n\npurposes_compared &lt;- \n  left_join(\n    purposes_primary |&gt;\n      rename(purpose_id = primaryPurposeId),\n    purposes_secondary,\n    by = \"purpose_id\",\n    suffix = c(\"_primary\", \"_all\")\n  ) |&gt;\n  filter(purpose_id != \"Other or not specified\") |&gt;\n  mutate(pct_primary_of_all = n_primary / n_all)\n\np1 &lt;- purposes_compared |&gt;\n  mutate(purpose_id = fct_reorder(purpose_id, pct_primary_of_all)) |&gt;\n  ggplot() +\n  geom_col(aes(n_all, purpose_id),\n           alpha = 0.3) +\n  geom_col(aes(n_primary, purpose_id),\n           alpha = 0.3) +\n  geom_text(aes(-10, purpose_id, label = percent(pct_primary_of_all, accuracy = 1)),\n            nudge_x = -500,\n            hjust = 1) +\n  scale_x_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  expand_limits(x = -4000) +\n  labs(\n    subtitle = \"A: Count of purposes and\\nproportion of primary purposes\",\n    x = \"Count\",\n    y = NULL\n  )\n\ntailings_pct &lt;- purposes_compared |&gt;\n  filter(purpose_id == \"Tailings\") |&gt;\n  pull(pct_primary_of_all)\n\np2 &lt;- dams_no_geo |&gt;\n  mutate(n_purposes = str_count(purposeIds, \";\") + 1) |&gt;\n  ggplot() +\n  geom_histogram(aes(n_purposes),\n                 binwidth = 1) +\n  scale_y_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  labs(\n    subtitle = \"B: Number of purposes per dam\",\n    x = NULL,\n    y = \"Count\"\n  )\n\np2 &lt;- dams_no_geo |&gt;\n  mutate(n_purposes = str_count(purposeIds, \";\") + 1) |&gt;\n  filter(!is.na(n_purposes)) |&gt;\n  arrange(desc(n_purposes)) |&gt;\n  count(n_purposes) |&gt;\n  arrange(desc(n)) |&gt;\n  mutate(pct_n = n / sum(n),\n         n_cum = cumsum(n),\n         n_purpose_label = glue(\"{n_purposes} purposes\"),\n         n_purpose_label = fct_rev(n_purpose_label),\n         tmp = 0) |&gt;\n  ggplot() +\n  geom_line(aes(n_cum, n_purpose_label, group = tmp),\n            linewidth = 0.5,\n            color = \"steelblue\") +\n  geom_point(aes(n_cum, n_purpose_label, group = tmp),\n            size = 2,\n            color = \"steelblue\") +\n  geom_text(aes(x = 15000, y = n_purpose_label, label = n),\n            hjust = 1) +\n  geom_text(aes(x = 30000, y = n_purpose_label, label = percent(pct_n, accuracy = 0.1)),\n            hjust = 1) +\n  scale_x_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  expand_limits(x = 0) +\n  labs(\n    subtitle = \"B: Number of purposes per dam\",\n    x = \"Cumulative number of dams\",\n    y = NULL\n  )\n\n\np1 + p2 +\n  plot_annotation(\n    title = \"Purposes: primary purpose\\nas percent of all purpose mentions\",\n    subtitle = glue(\"Ordered by percent of purposes in which this purpose is primary. For example,\",\n                    \" {percent(tailings_pct, accuracy = 1)} of the cases\",\n                    \"\\nin which 'Tailings' is mentioned, it's the primary purpose.\", \n                    \" Or stated another way,\",\n                    \" in {percent(1 - tailings_pct, accuracy = 1)} of the cases,\",\n                    \"\\n'Tailings' is a secondary purpose\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.20: Primary and all purposes compared\n\n\n\n\n\n\n\n\nShow the code\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  left_join(dams_no_geo_all_purposes |&gt;\n              select(nidId, purpose_id),\n            by = join_by(nidId)) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, purpose_id, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(purpose_id = fct_lump_n(purpose_id, n = 5)) |&gt;\n  count(yearCompletedId, purpose_id, state_region, state_abb) |&gt;\n  mutate(purpose_id = fct_reorder(purpose_id, -n, min))\n\ndta_highlight &lt;- year_build_by_primary_purpose |&gt;\n  slice_max(order_by = n, n = 1,\n            by = c(purpose_id))\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, group = state_abb),\n            linewidth = 0.2,\n            alpha = 0.2) + \n  geom_point(data = dta_highlight,\n             aes(yearCompletedId, n, ),\n             size = 2,\n             color = \"steelblue\",\n             show.legend = FALSE) +\n  geom_text(data = dta_highlight,\n            aes(yearCompletedId, n, label = state_abb),\n            nudge_x = 1,\n            color = \"steelblue\",\n            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~purpose_id, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    subtitle = \"A: By decade\",\n    x = NULL,\n    y = NULL\n  )\n\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  left_join(dams_no_geo_all_purposes |&gt;\n              select(nidId, purpose_id),\n            by = join_by(nidId)) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, purpose_id, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(purpose_id = fct_lump_n(purpose_id, n = 5)) |&gt;\n  count(yearCompletedId, purpose_id, state_abb) |&gt;\n  complete(yearCompletedId, purpose_id, state_abb,\n           fill = list(n = 0)) |&gt;\n  mutate(n_cum = cumsum(n),\n         idx = row_number(),\n         .by = c(purpose_id, state_abb)) |&gt;\n  mutate(purpose_id = fct_reorder(purpose_id, -n_cum, min))\n\ndta_highlight &lt;- year_build_by_primary_purpose |&gt;\n  filter(yearCompletedId != \"Undetermined\", \n         yearCompletedId == \"Since 2000\") |&gt;\n  slice_max(order_by = n_cum, n = 1,\n            by = purpose_id)\n\np2 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n_cum, group = state_abb),\n            linewidth = 0.2,\n            alpha = 0.2) + \n  geom_text(data = dta_highlight,\n            aes(yearCompletedId, n_cum, label = state_abb),\n            nudge_x = 0.5,\n            color = \"steelblue\",\n            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~purpose_id, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    subtitle = \"B: Cumulative\",\n    x = NULL,\n    y = NULL\n  )\n\np1 / p2 +\n  plot_annotation(\n    title = \"The most common purposes vary by state\\ndue to geography and local priorities\",\n    subtitle = glue(\"New dams in each state, by purpose\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.21: New dams in each state, by purpose\n\n\n\n\n\n\nUnpacking the “other” category when considering all purposes in Figure 6.21 above, the surprises in seen in Figure 6.17 have gone away in Figure 6.22:\n\nCalifornia overtook New York in number of hydroelectric dams\nTexas overtook Missouri in dams for debris control (but not for grade stabilization)\n\nFlorida continues to have many more dams for tailings than other states, which remains a surprise..\n\n\nShow the code\nexclude_purposes &lt;- c(\"Recreation\", \"Flood Risk Reduction\", \"Fire Protection, Stock,\\nOr Small Fish Pond\",\n                      \"Irrigation\", \"Water Supply\")\n\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  left_join(dams_no_geo_all_purposes |&gt;\n              select(nidId, purpose_id),\n            by = join_by(nidId)) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         purpose_id != \"Other or not specified\",\n         purpose_id != \"Other\") |&gt;\n  filter(!purpose_id %in% exclude_purposes) |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, purpose_id, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  count(yearCompletedId, purpose_id, state_abb) |&gt;\n  complete(yearCompletedId, purpose_id, state_abb,\n           fill = list(n = 0)) |&gt;\n  mutate(n_cum = cumsum(n),\n         idx = row_number(),\n         .by = c(purpose_id, state_abb)) |&gt;\n  mutate(purpose_id = fct_reorder(purpose_id, -n_cum, min))\n\ndta_highlight &lt;- year_build_by_primary_purpose |&gt;\n  filter(yearCompletedId != \"Undetermined\", \n         yearCompletedId == \"Since 2000\") |&gt;\n  slice_max(order_by = n_cum, n = 1,\n            by = purpose_id)\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n_cum, group = state_abb),\n            linewidth = 0.2,\n            alpha = 0.2) + \n  geom_text(data = dta_highlight,\n            aes(yearCompletedId, n_cum, label = state_abb),\n            nudge_x = 0.5,\n            color = \"steelblue\",\n            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3))) +\n  expand_limits(y = 0) +\n  facet_wrap(~purpose_id, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    # subtitle = \"A: Dams\",\n    x = NULL,\n    y = NULL\n  )\n \np1 +\n  plot_annotation(\n    title = \"New York and Missouri are top states\\nfor two of the 'other' categories\",\n    subtitle = glue(\"'Other' cumulative new dams in each state, by purpose\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.22: Unpacking the ‘other’ category in purposes\n\n\n\n\n\n\n\n\nShow the code\nyear_build_by_primary_purpose &lt;- dams_no_geo |&gt;\n  left_join(dams_no_geo_all_purposes |&gt;\n              select(nidId, purpose_id),\n            by = join_by(nidId)) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         primaryPurposeId != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, purpose_id, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId, \n                                  levels = yearCompletedId_levels, \n                                  ordered = TRUE)) |&gt;\n  mutate(purpose_id = fct_lump_n(purpose_id, n = 5)) |&gt;\n  count(yearCompletedId, purpose_id, state_region, state_abb)\n\np1 &lt;- year_build_by_primary_purpose |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = purpose_id, group = purpose_id)) +\n  # geom_point(aes(yearCompletedId, n, color = primaryPurposeId),\n  #            size = 0.75,\n  #            show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(#label = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3),\n                              nrow = 1)) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_abb, scales = \"free_y\")  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)\n        ) +\n  labs(\n    x = NULL,\n    y = NULL\n  )\n\np1 +\n  plot_annotation(\n    title = \"New dams and their purposes, by state\",\n    subtitle = glue(\"Includes dams for which purpose and year completed data are available\", \n                    \"\\nY axis scale varies\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.23: New dams and their purposes, by state\n\n\n\n\n\n\nMany big dams serve multiple purposes. Compare California and Colorado below with Figure 6.19, which counts only primary purposes.\n\n\nShow the code\nyear_build_by_primary_purpose_big_dams &lt;- dams_no_geo |&gt;\n  filter(big_dam) |&gt;\n  left_join(dams_no_geo_all_purposes |&gt;\n              select(nidId, purpose_id),\n            by = join_by(nidId)) |&gt;\n  filter(yearCompletedId != \"Undetermined\",\n         purpose_id != \"Other or not specified\") |&gt;\n  select(nidId, primaryOwnerTypeId, primaryPurposeId, purpose_id, state, state_abb, state_region, nidStorage, yearCompleted, yearCompletedId) |&gt;\n  mutate(yearCompletedId = factor(yearCompletedId,\n                                  levels = yearCompletedId_levels,\n                                  ordered = TRUE)) |&gt;\n  mutate(purpose_id = fct_lump_n(purpose_id, n = 5)) |&gt;\n  count(yearCompletedId, purpose_id, state_region, state_abb)\n\np2 &lt;- year_build_by_primary_purpose_big_dams |&gt;\n  ggplot() +\n  geom_line(aes(yearCompletedId, n, color = purpose_id, group = purpose_id)) +\n  geom_point(aes(yearCompletedId, n, color = purpose_id),\n              size = 0.75,\n             show.legend = FALSE) +\n  scale_x_discrete(breaks = yearCompletedId_breaks) +\n  scale_y_continuous(#breaks = 2 * 0:5,\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  scale_color_viridis_d(end = 0.90) +\n  guides(color = guide_legend(override.aes = list(linewidth = 3),\n                              nrow = 1)) +\n  expand_limits(y = 0) +\n  facet_wrap(~state_abb)  +\n  theme(plot.title.position = \"plot\",\n        legend.position = \"top\",\n        axis.text.x = element_text(angle = 30, hjust = 1)) +\n  labs(\n    x = NULL,\n    y = NULL\n  )\n\np2 +\n  plot_annotation(\n    title = \"California has the most big dams\",\n    subtitle = glue(\"New big dams and their purposes, by state\",\n                    \"\\nIncludes dams for which purpose and year completed data are available\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.24: New big dams and their purposes, by state",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#dam-modifications",
    "href": "numbers.html#dam-modifications",
    "title": "6  Numbers",
    "section": "6.6 Dam modifications",
    "text": "6.6 Dam modifications\nThe data set includes records of modifications for a small portion of the dams:\n\nYear (four digits) when major modifications or rehabilitation of dam or major control structures were completed. Major modifications are defined as a structural, foundation, or mechanical construction activity which significantly restores the project to original condition; changes the project’s operation; capacity or structural characteristics (e.g. spillway or seismic modification); or increases the longevity, stability, or safety of the dam and appurtenant structures.\nCategory describing the type of modification: Foundation, Hydraulic, Mechanical, Seismic, Structural, Other3\n\n\n\nShow the code\ndta_for_plot_tmp1 &lt;- dams_no_geo |&gt;\n  filter(nidHeight &gt; 0,\n         !is.na(yearsModified),\n         yearsModified != \"-1\")\n\nn_dams_with_mod_data &lt;- nrow(dta_for_plot_tmp1)\npct_dams_with_mod_data = n_dams_with_mod_data / nrow(dams_no_geo)\n\ndta_for_plot &lt;- dta_for_plot_tmp1 |&gt;\n  select(name, state, nidId, nidHeight, nidHeightId, yearCompleted, yearCompletedId, yearsModified, big_dam) |&gt;\n  mutate(yearsModified_orig = yearsModified) |&gt;\n  separate_longer_delim(yearsModified, delim = \";\") |&gt;\n  mutate(modified_reason = str_extract(yearsModified, \"[A-Z]$\"),\n         year_modified = parse_number(yearsModified)) |&gt;\n  mutate(years_to_mod = year_modified - yearCompleted,\n         .by = c(name, nidId)) |&gt;\n  mutate(years_since_last_mod = years_to_mod - lag(years_to_mod, default = NA),\n         .by = c(name, nidId)) |&gt;\n  mutate(years_since_last_mod = ifelse(is.na(years_since_last_mod),\n                                       years_to_mod,\n                                       years_since_last_mod)) |&gt;\n  filter(years_to_mod &gt; 0) |&gt;\n  mutate(mod_idx = row_number(),\n         .by = c(name, nidId)) |&gt;\n  mutate(mod_idx_label = fct_reorder(glue(\"mod {mod_idx}\"), mod_idx)) |&gt;\n  distinct(name, nidId, year_modified, .keep_all = TRUE) |&gt; # remove duplicate rows where mods were made for multiple reasons\n  mutate(mod_idx_label = fct_lump_n(mod_idx_label, \n                                    n = 5,\n                                    other_level = \"mod 6+\"))\n\nn_dams_with_good_mod_data &lt;- dta_for_plot |&gt;\n  distinct(name, nidId) |&gt;\n  nrow()\n\npct_dams_with_good_mod_data = n_dams_with_good_mod_data / nrow(dams_no_geo)\n\nn_mod_one_only &lt;- dta_for_plot |&gt;\n  filter(mod_idx_label == \"mod 1\") |&gt;\n  nrow()\n\nn_mod_after_one &lt;- dta_for_plot |&gt;\n  filter(mod_idx_label != \"mod 1\") |&gt;\n  nrow()\n\npct_mod_data_is_mod1 &lt;- n_mod_one_only / (n_mod_one_only + n_mod_after_one)\n\nmy_binwidth &lt;- 10\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_histogram(aes(years_to_mod),\n                 binwidth = my_binwidth) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  labs(\n    subtitle = \"A: Years from dam completion\\nto modification (all mods)\",\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  filter(mod_idx == 1) |&gt;\n  ggplot() +\n  geom_histogram(aes(years_to_mod),\n                 binwidth = my_binwidth) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  labs(\n    subtitle = \"B: Years from dam completion\\nto first modification\",\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Distributions of years from completion to modifications\",\n    subtitle = glue(\"Includes {n_dams_with_good_mod_data} ({percent(pct_dams_with_good_mod_data, accuracy = 1)})\",\n                    \" dams with modification data\",\n                    \". Binwidth: {my_binwidth} years\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.25: Distibution of years from completion to modifications\n\n\n\n\n\n\nIn Figure 6.25 above we see the distribution of years from completion to any mod (Figure 6.25 panel A) and to the first model (panel B). The distributions have a similar shape–partly because 85% of dams with modification data are for the first modification.\nEven so, when we look at the distribution of years from completion to modification (Figure 6.26), the shapes are similar.\n\n\nShow the code\nmy_binwidth &lt;- 10\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_histogram(aes(years_to_mod),\n                 binwidth = my_binwidth) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  facet_wrap(~mod_idx_label, scales = \"free_y\") +\n  labs(\n    title = \"Density plot\",\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density(aes(years_to_mod, color = mod_idx_label)) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  guides(color = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.8, 0.7)) +\n  coord_cartesian(x = c(0, 200)) +\n  labs(\n    title = \"Density plot\",\n    color = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Similar distributions of years from completion to modification\\n(all modifications)\",\n    subtitle = glue(\"Includes {n_dams_with_good_mod_data} ({percent(pct_dams_with_good_mod_data, accuracy = 1)})\", \n                    \" dams with modification data\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.26: Years from completion to last modification\n\n\n\n\n\n\nWhen we look at the years since the last modification (Figure 6.27), the distributions are a similar shape for mods 2+.\n\n\nShow the code\nmy_binwidth &lt;- 10\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_histogram(aes(years_since_last_mod),\n                 binwidth = my_binwidth,\n                 na.rm = TRUE) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  facet_wrap(~mod_idx_label, scales = \"free_y\") +\n  labs(\n    subtitle = glue(\"Histogram; binwidth: {my_binwidth} years\")\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density(aes(years_since_last_mod, color = mod_idx_label),\n               na.rm = TRUE) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  scale_color_viridis_d(end = 0.9) +\n  guides(color = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.8, 0.7)) +\n  coord_cartesian(x = c(0, 150)) +\n  labs(\n    subtitle = \"Density plot\",\n    color = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = glue(\"For mods 2+ there is a similar distributions of years\\n since last modification\"),\n    subtitle = glue(\"Includes {n_dams_with_good_mod_data} ({percent(pct_dams_with_good_mod_data, accuracy = 1)}) dams with modification data\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.27: Distribution of years since last modificaiton\n\n\n\n\n\n\n\n6.6.1 Reasons for modification\nBig dams are more frequently modified for structural or seismic reasons (Figure 6.28).\n\n\nShow the code\ndta_for_plot_reasons &lt;- dta_for_plot |&gt;\n  filter(!is.na(modified_reason)) |&gt;\n  mutate(mod_reason_label = case_match(\n    modified_reason,\n    \"F\" ~ \"Foundation\",\n    \"H\" ~ \"Hydraulic\",\n    \"M\" ~ \"Mechanical\",\n    \"E\" ~ \"Seismic\",\n    \"S\" ~ \"Structural\",\n    \"O\" ~ \"Other\",\n  )) |&gt;\n  count(mod_reason_label, sort = TRUE) |&gt;\n  mutate(mod_reason_label = fct_reorder(mod_reason_label, n),\n         n_pct = `n` / sum(`n`))\n\np1 &lt;- dta_for_plot_reasons |&gt;\n  ggplot(aes(n, mod_reason_label)) +\n  geom_col() +\n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  # scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  labs(\n    subtitle = \"A: All dams\",\n    x = NULL,\n    y = NULL\n  )\n\ndta_for_plot_reasons_big &lt;- dta_for_plot |&gt;\n  filter(!is.na(modified_reason),\n         big_dam) |&gt;\n  mutate(mod_reason_label = case_match(\n    modified_reason,\n    \"F\" ~ \"Foundation\",\n    \"H\" ~ \"Hydraulic\",\n    \"M\" ~ \"Mechanical\",\n    \"E\" ~ \"Seismic\",\n    \"S\" ~ \"Structural\",\n    \"O\" ~ \"Other\",\n  )) |&gt;\n  count(mod_reason_label, sort = TRUE) |&gt;\n  mutate(mod_reason_label = fct_reorder(mod_reason_label, n),\n         n_pct = `n` / sum(`n`))\n\np2 &lt;- dta_for_plot_reasons_big |&gt;\n  ggplot(aes(n, mod_reason_label)) +\n  geom_col() +\n  geom_text(aes(x = 0.9 * max(n), label = glue(\"{n} | {percent(n_pct, accuracy = 1)}\")),\n            hjust = 1,\n            size = 3) +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  # scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  labs(\n    subtitle = \"B: Big dams\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Reasons for dam modifications\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.28: Reasons for dam modification\n\n\n\n\n\nIs the modification data complete? Unlikely, especially in earlier years and for smaller dams. Beyond that intuition, I cannot assess what proportion of modifications might be missing. Of the 86,351 dams, 6,514 have associated modification dates. 5,436 have valid modification dates.",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#sec-state-level-data",
    "href": "numbers.html#sec-state-level-data",
    "title": "6  Numbers",
    "section": "6.7 State-level information",
    "text": "6.7 State-level information\nBelow is state-level information, in case you wish to dig in.\n\n\nShow the code\np1 &lt;- dams_no_geo |&gt;\n  count(state, primaryOwnerTypeId) |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum)) |&gt;\n  ggplot() +\n  geom_col(aes(x = n, y = state, fill = primaryOwnerTypeId),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE,\n                             ncol = 2)) +\n  theme(legend.position = \"top\")+\n  labs(\n    subtitle = \"A: Primary owner\",\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  )\n\np2 &lt;- dams_no_geo |&gt;\n  count(state, primaryPurposeId) |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)) |&gt;\n  ggplot() +\n  geom_col(aes(x = n, y = state, fill = primaryPurposeId),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE,\n                             ncol = 2)) +\n  theme(legend.position = \"top\")+\n  labs(\n    subtitle = \"B: Primary purpose\",\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  )\n\np3 &lt;- dams_no_geo |&gt;\n  count(state, primaryDamTypeId) |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         primaryDamTypeId = fct_reorder(primaryDamTypeId, n, sum)) |&gt;\n  ggplot() +\n  geom_col(aes(x = n, y = state, fill = primaryDamTypeId),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE,\n                             ncol = 2)) +\n  theme(legend.position = \"top\") +\n  labs(\n    subtitle = \"C: Primary dam type\",\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  )\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Basic counts: owner, purpose, dam type\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.29: Basic counts: owner, purpose, dam type - by state\n\n\n\n\n\n\n\n\nShow the code\np1 &lt;- dams_no_geo |&gt;\n  count(state, primaryOwnerTypeId) |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum)) |&gt;\n  ggplot() +\n  geom_col(aes(x = n, y = state, fill = primaryOwnerTypeId),\n           position = \"fill\",\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE,\n                             ncol = 2)) +\n  theme(legend.position = \"top\")+\n  labs(\n    subtitle = \"A: Primary owner\",\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  )\n\np2 &lt;- dams_no_geo |&gt;\n  count(state, primaryPurposeId) |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)) |&gt;\n  ggplot() +\n  geom_col(aes(x = n, y = state, fill = primaryPurposeId),\n           position = \"fill\",\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE,\n                             ncol = 2)) +\n  theme(legend.position = \"top\")+\n  labs(\n    subtitle = \"B: Primary purpose\",\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  )\n\np3 &lt;- dams_no_geo |&gt;\n  count(state, primaryDamTypeId) |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         primaryDamTypeId = fct_reorder(primaryDamTypeId, n, sum)) |&gt;\n  ggplot() +\n  geom_col(aes(x = n, y = state, fill = primaryDamTypeId),\n           position = \"fill\",\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(reverse = TRUE,\n                             ncol = 2)) +\n  theme(legend.position = \"top\")+\n  labs(\n    subtitle = \"C: Primary dam type\",\n    x = NULL,\n    y = NULL,\n    fill = NULL\n  )\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Basic counts: owner, purpose, dam type (proportion of each category)\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.30: Basic counts: owner, purpose, dam type (proportion of each category) - by state\n\n\n\n\n\n\n\n\nShow the code\nstate_owner &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  count(primaryOwnerTypeId, state) |&gt;\n  complete(primaryOwnerTypeId, state, fill = list(n = 0)) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, -n, sum),\n         state = fct_reorder(state, n, sum))\n\np1 &lt;- state_owner |&gt;\n  ggplot(aes(x = primaryOwnerTypeId, y = state)) +\n  geom_tile(aes(fill = n),\n            alpha = 0.98) +\n  geom_text(aes(label = n),\n            color = \"white\",\n             size = 3) +\n  theme(plot.title.position = \"plot\",\n        axis.text.x = element_text(angle = 60, hjust = 0)\n        ) +\n  scale_x_discrete(position = \"top\") +\n  scale_fill_continuous(transform = scales::transform_log1p(),\n                        breaks = c(0, 10, 100, 1000, 10000)) +\n  guides(fill = \"none\") +\n  labs(\n    subtitle = \"A: Primary owner type - count\",\n    x = NULL,\n    y = NULL\n  )\n\nstate_purpose &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  count(primaryPurposeId, state) |&gt;\n  complete(primaryPurposeId, state, fill = list(n = 0)) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, -n, sum),\n         state = fct_reorder(state, n, sum))\n\np2 &lt;- state_purpose |&gt;\n  ggplot(aes(x = primaryPurposeId, y = state)) +\n  geom_tile(aes(fill = n),\n            alpha = 0.98) +\n  geom_text(aes(label = n),\n            color = \"white\",\n             size = 3) +\n  theme(plot.title.position = \"plot\",\n        axis.text.x = element_text(angle = 60, hjust = 0)\n        ) +\n  scale_x_discrete(position = \"top\") +\n  scale_fill_continuous(transform = scales::transform_log1p(),\n                        breaks = c(0, 10, 100, 1000, 10000),\n                        ) + # transform_sqrt()) +\n  labs(\n    subtitle = \"B: Primary purpose - count\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"State by primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.31: State by primary owner type and purpose - counts\n\n\n\n\n\n\n\n\nShow the code\np1 &lt;- dams_ratios_per_state |&gt;\n  ggplot() +\n  geom_col(aes(x = n_dams, y = state),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"A: Number of dams\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dams_ratios_per_state_big |&gt;\n  ggplot() +\n  geom_col(aes(x = n_dams, y = state),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"B: Number of big dams\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = glue(\"Number of dams\"),\n    # subtitle = glue(\"Includes {n_dams_with_good_mod_data} ({percent(pct_dams_with_good_mod_data, accuracy = 1)}) dams with modification data\"),\n    caption = my_caption\n  )\n\n\n\n\n\nShow the code\np1 &lt;- dams_ratios_per_state |&gt;\n  mutate(state = fct_reorder(state, pop_per_dam)) |&gt;\n  ggplot() +\n  geom_col(aes(x = pop_per_dam, y = state),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"A: Population per dam\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dams_ratios_per_state_big |&gt;\n  mutate(state = fct_reorder(state, pop_per_dam)) |&gt;\n  ggplot() +\n  geom_col(aes(x = pop_per_dam, y = state),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"B: Population per big dam\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = glue(\"Population per dam\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.32: Population per dam\n\n\n\n\n\n\n\n\nShow the code\np1 &lt;- dams_ratios_per_state |&gt;\n  mutate(state = fct_reorder(state, sqmi_per_dam)) |&gt;\n  ggplot() +\n  geom_col(aes(x = sqmi_per_dam, y = state),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"A: All dams\",\n    x = NULL,\n    y = NULL\n  )\n\np2 &lt;- dams_ratios_per_state_big |&gt;\n  mutate(state = fct_reorder(state, sqmi_per_dam)) |&gt;\n  ggplot() +\n  geom_col(aes(x = sqmi_per_dam, y = state),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"B: Big dams\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = glue(\"State sqmi per dam\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.33: State area (sqmi) per dam\n\n\n\n\n\n\n\n\nShow the code\ndta_for_plot &lt;- dams_with_pop |&gt;\n  reframe(n_dams = n(),\n         median_surface_area_to_nidStorage = median(surfaceArea / nidStorage, na.rm = TRUE),\n         avg_surface_area_to_nidStorage = mean(surfaceArea / nidStorage, na.rm = TRUE),\n         .by = \"state\"\n  ) |&gt;\n  mutate(state_label = glue(\"{state} ({n_dams})\"),\n         state_label = fct_reorder(state_label, median_surface_area_to_nidStorage))\n\nn_dams_total = sum(dta_for_plot$n_dams)\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_col(aes(x = median_surface_area_to_nidStorage, \n               width = pmax(15 * n_dams / n_dams_total, 0.02), \n               y = state_label),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  theme(axis.ticks.y = element_blank()) +\n  labs(\n    subtitle = \"A: All dams\",\n    x = NULL,\n    y = NULL\n  )\n\ndta_for_plot_big &lt;- dams_with_pop |&gt;\n  filter(big_dam) |&gt;\n  reframe(n_dams = n(),\n         median_surface_area_to_nidStorage = median(surfaceArea / nidStorage, na.rm = TRUE),\n         avg_surface_area_to_nidStorage = mean(surfaceArea / nidStorage, na.rm = TRUE),\n         .by = \"state\"\n  ) |&gt;\n  mutate(state_label = glue(\"{state} ({n_dams})\"),\n         state_label = fct_reorder(state_label, median_surface_area_to_nidStorage))\n\nn_dams_total_big = sum(dta_for_plot_big$n_dams)\n\np2 &lt;- dta_for_plot_big |&gt;\n  ggplot() +\n  geom_col(aes(x = median_surface_area_to_nidStorage,\n               width = pmax(8 * n_dams / n_dams_total_big, 0.02),\n               y = state_label),\n           alpha = 0.7) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0, 0.02))) +\n  scale_fill_viridis_d(end =  0.9,\n                       direction = -1) +\n  theme(axis.ticks.y = element_blank()) +\n  labs(\n    subtitle = \"B: Big dams\",\n    x = NULL,\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = glue(\"Median dam `surfaceArea`::`nidStorage` by state\"),\n    subtitle = \"Vertical height reflects the relative number of dams in the state\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 6.34: Median surfaceArea::nidStorage\n\n\n\n\n\n\nI’m surprised Florida is so low in the ranking in panel A, given it’s such a flat state. Also that it has 71 big dams (panel B).\nLooking deeper #1: all the big dams are privately owned by companies mining phosphorus, potash, etc. and nearly all have “tailings” as their primary purpose. (They have smaller dams in Florida too.)\n\n\nShow the code\ndams_no_geo |&gt;\n  filter(big_dam,\n         state_abb == \"FL\") |&gt;\n  select(nidId, name, ownerNames, primaryPurposeId, nidHeight, nidStorage) |&gt;\n  reframe(\n    n_dams = n(),\n    `nidStorage median` = median(nidStorage),\n    `nidStorage smallest` = min(nidStorage),\n    `nidStorage largest` = max(nidStorage),\n    `nidHeight median` = median(nidHeight),\n    `nidHeight smallest` = min(nidHeight),\n    `nidHeight largest` = max(nidHeight),\n    .by = ownerNames\n  ) |&gt;\n  arrange(desc(`nidStorage median`), `nidHeight median`) |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Big dams in Florida are owned by mining companies**\")) |&gt;\n  fmt_number(columns = is.numeric,\n             decimals = 0)\n\n\n\n\n\n\n\n\nBig dams in Florida are owned by mining companies\n\n\nownerNames\nn_dams\nnidStorage median\nnidStorage smallest\nnidStorage largest\nnidHeight median\nnidHeight smallest\nnidHeight largest\n\n\n\n\nPCS PHOSPHATE\n3\n52,500\n52,500\n52,500\n105\n105\n105\n\n\nU.S. AGRI - CHEM\n2\n1,768\n1,178\n2,358\n142\n135\n149\n\n\nTHE MOSAIC COMPANY\n60\n1,152\n128\n16,000\n105\n103\n145\n\n\nHRK HOLDINGS, LLC\n6\n960\n896\n1,920\n105\n105\n105\n\n\n\n\n\n\n\n\nLooking deeper #2: Regarding dams with the highest nidStorage_median owned by PCS PHOSPHATE (a subsidiary of Nutrien):\n\nIt’s suspicious that median, smallest, and largest are all the same size – are the entries duplicates, or are there data errors? It’s very unlikely that three dams would manage exactly the same amount of water or be exactly the same height.\nEach dam has it’s own name and nidId, and long/lat coordinates are different.\nI verified the dams on Google maps: there are three separate holding ponds very close to each other, located in North Florida about halfway between Tallahassee and Jacksonville.\nThus is seems some of the data fields were duplicated, but not all:\n\n\n\nShow the code\ndams_no_geo |&gt;\n  filter(big_dam,\n         state_abb == \"FL\",\n         ownerNames == \"PCS PHOSPHATE\") |&gt;\n  select(nidId, name, ownerNames, `primary PurposeId` = primaryPurposeId, nidHeight, nidStorage, `surface Area` = surfaceArea, longitude, latitude) |&gt;\n  arrange(nidId) |&gt;\n  gt() |&gt;\n  tab_header(md(\"**PCS PHOSPHATE's big dams seem to have some duplicated data in the NID**\")) |&gt;\n  fmt_number(columns = starts_with(\"nid\"),\n             decimals = 0)\n\n\n\n\n\n\n\n\nPCS PHOSPHATE’s big dams seem to have some duplicated data in the NID\n\n\nnidId\nname\nownerNames\nprimary PurposeId\nnidHeight\nnidStorage\nsurface Area\nlongitude\nlatitude\n\n\n\n\nFL10002\nCtc Gypsum\nPCS PHOSPHATE\nOther or not specified\n105\n52,500\n500\n-82.79000\n30.42997\n\n\nFL10004\nSc Gypsum\nPCS PHOSPHATE\nOther or not specified\n105\n52,500\n500\n-82.87461\n30.44806\n\n\nFL10009\nDo Gypsum\nPCS PHOSPHATE\nTailings\n105\n52,500\n500\n-82.77978\n30.43331",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "numbers.html#footnotes",
    "href": "numbers.html#footnotes",
    "title": "6  Numbers",
    "section": "",
    "text": "Or in some cases, dams provide surface impoundment of mine tailings or coal ash. See for example Fact Sheet: Coal Ash. EPA 530-F-23-004. June 2023 at https://www.epa.gov/system/files/documents/2023-06/CCR_Fact_Sheet_June_2023.pdf ↩︎\nhttps://en.wikipedia.org/wiki/Erie_Canal ↩︎\nNational Inventory of Dams Data Dictionary https://usace-cwbi-prod-il2-nld2-docs.s3-us-gov-west-1.amazonaws.com/ec51e2ba-daff-4dbe-95eb-af13b91066ba/NID%20Data%20Dictionary%202021-12-14.pdf ↩︎",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Numbers</span>"
    ]
  },
  {
    "objectID": "owners-nc.html",
    "href": "owners-nc.html",
    "title": "7  Owners in NC",
    "section": "",
    "text": "7.1 Overview\nWho owns all these dams, and what are their primary purposes? To answer more concretely than in Chapter 6, let’s look at the 3600 dams in North Carolina, where 2922 of the 3600 dams in the NID are privately owned (81%) compared to the 86351 in the continental US, where 55570 of the dams are privately owned (64%).\nThe NID includes ownership categories private, public utility, and three levels of government: federal, state, and local, as well as “Other or not specified”. The alluvial plots below offer a nice summary of the proportions of dam ownership and purpose.\nSome observations:\nIn Figure 7.1 I provide three admittedly busy plots on the same row to make it easier to compare them. Panel A shows all dams, and panels B and C include privately-owned and government-owned dams, respectively.\nShow the code\n# following example at https://mjfrigaard.github.io/fm-ggp2/alluvial_charts.html\n\nnc_wide &lt;- dams_nc |&gt;\n  st_drop_geometry() |&gt;\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)\n  )\n\np1 &lt;- ggplot(data = nc_wide,\n  aes(axis1 = primaryOwnerTypeId, axis2 = primaryPurposeId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    subtitle = \"A. All dams\",\n    y = NULL\n  )\n\nnc_private_wide &lt;- dams_no_geo_nc_private |&gt;\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)\n  )\n\np2 &lt;- ggplot(data = nc_private_wide,\n  aes(axis1 = primaryOwnerTypeId, axis2 = primaryPurposeId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    subtitle = \"B. Private entity or public utility\",\n    y = NULL\n  )\n\nnc_gov_wide &lt;- dams_no_geo |&gt;\n  filter(primaryOwnerTypeId %in% c(\"Federal\", \"State\", \"Local Government\")) |&gt;\n  count(primaryOwnerTypeId, primaryPurposeId) |&gt;\n  mutate(primaryOwnerTypeId = fct_reorder(primaryOwnerTypeId, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)\n  )\n\np3 &lt;- ggplot(data = nc_gov_wide,\n  aes(axis1 = primaryOwnerTypeId, axis2 = primaryPurposeId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    subtitle = \"C. Government entity\",\n    y = NULL\n  )\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Dams in NC by primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 7.1: Dams in NC by owner and purpose",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Owners in NC</span>"
    ]
  },
  {
    "objectID": "owners-nc.html#government-owned",
    "href": "owners-nc.html#government-owned",
    "title": "7  Owners in NC",
    "section": "7.2 Government-owned",
    "text": "7.2 Government-owned\nLet’s dig into the dams owned by government entities. There are a surprising number federal, state, and local government entities that own dams in North Carolina. The following three plots include a third dimension: dam height (specifically nidHeight), which I think could be a good proxy for the level of investment required to create and maintain the dam.\n\n\nShow the code\nnc_fed_simple_wide &lt;- dams_nc |&gt;\n  st_drop_geometry() |&gt;\n  mutate(ownerNameSimplified = case_when(\n    str_detect(ownerNames, \"Army|USACE\")     ~ \"Army Corp of Engineers\",\n    str_detect(ownerNames, \"USDA FS|Forest\") ~ \"US Forest Service\",\n    str_detect(ownerNames, \"USDA FS|Forest\") ~ \"US Forest Service\",\n    str_detect(ownerNames, \"DOI NPS\")        ~ \"National Park Service\",\n    str_detect(ownerNames, \"FISH\")           ~ \"US Fish and\\nWildlife Service\",\n    str_detect(ownerNames, \"Fort L\")         ~ \"Fort Liberty\\n(Fort Bragg)\",\n    str_detect(ownerNames, \"USDA FS|Forest\") ~ \"US Forest Service\",\n    .default = ownerNames\n  )) |&gt;\n  filter(primaryOwnerTypeId == \"Federal\") |&gt;\n  count(ownerNameSimplified, primaryPurposeId, nidHeightId) |&gt;\n  mutate(ownerNameSimplified = fct_reorder(ownerNameSimplified, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum),\n         nidHeightId = fct_rev(nidHeightId)\n  )\n\np1 &lt;- ggplot(data = nc_fed_simple_wide,\n  aes(axis1 = ownerNameSimplified, axis2 = primaryPurposeId, axis3 = nidHeightId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\", \"Height\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    y = NULL\n  )\n\np1 +\n  plot_annotation(\n    title = \"Federal dams in NC\\nby primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 7.2: Federal dams in NC by owner and purpose\n\n\n\n\n\n\n\n\nShow the code\nnc_state_simple_wide &lt;- dams_nc |&gt;\n  st_drop_geometry() |&gt;\n  filter(primaryOwnerTypeId == \"State\") |&gt;\n  mutate(ownerNameSimplified = case_when(\n    str_detect(ownerNames, \"State of North Carolina, State Property Office\")   ~ \"NC State Property\\nOffice\",\n    str_detect(ownerNames, \"NC Wildlife Resources Commission\")                 ~ \"NC Wildlife\\nResources Commission\",\n    str_detect(ownerNames, \"NC Department of Natural and Cultural Resources\")  ~ \"NC Dept of Natural\\nand Cultural\\nResources\",\n    str_detect(ownerNames, \"NC Department of Transportation\")                  ~ \"NC Dept of\\nTransportation\",\n    str_detect(ownerNames, \"Agricult\")                                         ~ \"NC Dept Ag &\\nConsumer Services\",\n    str_detect(ownerNames, \"NC Zoological Authority\")                          ~ \"NC Zoological Authority\",\n    str_detect(ownerNames, \"College|University|Inst\")                          ~ \"Colleges, Univerities,\\nInstitutes\",\n    .default = \"Other\"\n  )) |&gt;\n  count(ownerNameSimplified, primaryPurposeId, nidHeightId) |&gt;\n  mutate(ownerNameSimplified = fct_reorder(ownerNameSimplified, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum),\n         nidHeightId = fct_rev(nidHeightId)\n  )\n\np2 &lt;- ggplot(data = nc_state_simple_wide,\n  aes(axis1 = ownerNameSimplified, axis2 = primaryPurposeId, axis3 = nidHeightId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\", \"Height\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    y = NULL\n  )\n\n p2 + \n  plot_annotation(\n    title = \"State dams in NC\\nby primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 7.3: State dams in NC by owner and purpose\n\n\n\n\n\n\n\n\nShow the code\nnc_local_simple_wide &lt;- dams_nc |&gt;\n  st_drop_geometry() |&gt;\n  filter(primaryOwnerTypeId == \"Local Government\") |&gt;\n  mutate(ownerNameSimplified = case_when(\n    str_detect(ownerNames, \"Parks\")                   ~ \"Parks & Rec\",\n    str_detect(ownerNames, \"Airport\")                 ~ \"Airport\",\n    str_detect(ownerNames, \"Soil\")                    ~ \"Soil & Water,\\nWatershed\",\n    str_detect(ownerNames, \"Utilit\")                  ~ \"Public Utilities\",\n    str_detect(ownerNames, \"Sewer|Storm\")             ~ \"Water & Sewer\",\n    str_detect(ownerNames, \"Public Works\")            ~ \"Public Works\",\n    str_detect(ownerNames, \"Engineering\")             ~ \"Engineering Services\",\n    str_detect(ownerNames, \"Educ|Uni\")                ~ \"Education\",\n    str_detect(ownerNames, \"Town|Village\")            ~ \"Other - town or village\",\n    str_detect(ownerNames, \"City|CIty\")               ~ \"Other - city\",\n    str_detect(ownerNames, \"County\")                  ~ \"Other - county\",\n    .default = \"Other\"\n  ),\n  primaryPurposeId = fct_lump_n(primaryPurposeId, 5)\n  ) |&gt;\n  count(ownerNameSimplified, primaryPurposeId, nidHeightId) |&gt;\n  mutate(ownerNameSimplified = fct_reorder(ownerNameSimplified, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum),\n         nidHeightId = fct_rev(nidHeightId)\n  )\n\np3 &lt;- ggplot(data = nc_local_simple_wide,\n  aes(axis1 = ownerNameSimplified, axis2 = primaryPurposeId, axis3 = nidHeightId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\", \"Height\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    y = NULL\n  )\n\np3 +\n  plot_annotation(\n    title = \"Local government dams in NC\\nby primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 7.4: Local government dams in NC by owner and purpose",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Owners in NC</span>"
    ]
  },
  {
    "objectID": "owners-nc.html#privately-owned",
    "href": "owners-nc.html#privately-owned",
    "title": "7  Owners in NC",
    "section": "7.3 Privately owned",
    "text": "7.3 Privately owned\nNearly all privately owned dams are less than 50 ft hight.\nPrivate owners subsumed in “Other” include “scouts/ymca/camp” and “farm/nursery”.\n\n\nShow the code\nnc_private_simple_wide &lt;- dams_nc |&gt;\n  st_drop_geometry() |&gt;\n  filter(primaryOwnerTypeId %in% c(\"Private\")) |&gt;\n  mutate(ownerNameSimplified = str_to_lower(ownerNames)) |&gt;\n  mutate(ownerNameSimplified = case_when(\n    str_detect(ownerNameSimplified, \"inc[.]|inc$|llc|lp$|corp|co[.]|firm|manuf|company|enterpr\")  ~ \"corporation\",\n    str_detect(ownerNameSimplified, \"international|partnership|group|property|trucks|solutions\")  ~ \"corporation\",\n    str_detect(ownerNameSimplified, \"properties|preserve|holdings|apartments|condo\")              ~ \"corporation\",\n    str_detect(ownerNameSimplified, \"energy|power|light|hydro\")                                   ~ \"utility\",\n    str_detect(ownerNameSimplified, \"farm|nursery\")                                               ~ \"farm/nursery\",\n    str_detect(ownerNameSimplified, \"club|church|presbytery|center|assembly|lodge|cathedral\")     ~ \"club/church/center/ngo\",\n    str_detect(ownerNameSimplified, \"council|conservancy|habitat|veterans\")                       ~ \"club/church/center/ngo\",\n    str_detect(ownerNameSimplified, \"poa|hoa|owners|assoc\")                                ~ \"POA/HOA/association\",\n    str_detect(ownerNameSimplified, \"scouts|ymca|camp\")                                    ~ \"scouts/ymca/camp\",\n    str_detect(ownerNameSimplified, \"foundation|trust|estate|heirs\")                       ~ \"foundation/trust/estate\",\n    str_detect(ownerNameSimplified, \"indians|tribal\")                                      ~ \"tribe\",\n    str_detect(ownerNameSimplified, \"parks & rec|city|county|nc dep|water\")                ~ \"local/regional/state govt\",\n    str_detect(ownerNameSimplified, \"national institutes\")                                 ~ \"federal gov\",\n    str_detect(ownerNameSimplified, \"airport|authorit\")                                    ~ \"airport/regional authority\",\n    str_detect(ownerNameSimplified, \"school|college|univ\")                                 ~ \"school, college,\\nor university\",\n    .default = \"individuals\" # \"Other\"\n  )) |&gt;\n  filter(ownerNameSimplified != \"local/regional/state govt\") |&gt; # apparently miscategorized\n  mutate(ownerNameSimplified = fct_lump_n(ownerNameSimplified, 5),\n         other_level = \"other\") |&gt;\n  count(ownerNameSimplified, primaryPurposeId, nidHeightId) |&gt;\n  mutate(ownerNameSimplified = fct_reorder(ownerNameSimplified, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum),\n         nidHeightId = fct_rev(nidHeightId)\n  )\n\np3 &lt;- ggplot(data = nc_private_simple_wide,\n  aes(axis1 = ownerNameSimplified, axis2 = primaryPurposeId, axis3 = nidHeightId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\", \"Height\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    y = NULL\n  )\n\np3 +\n  plot_annotation(\n    title = \"Privately owned dams in NC\\nby primary owner and primary purpose\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 7.5: Privately owned dams in NC by owner and purpose\n\n\n\n\n\n\nPower-generating utilities have unique needs to store and manage water and waste coal ash.\n\n\nShow the code\nnc_power_utility &lt;- dams_nc |&gt;\n  st_drop_geometry() |&gt;\n  filter(primaryOwnerTypeId %in% c(\"Private\", \"Public Utility\")) |&gt;\n  mutate(ownerNameSimplified = str_to_lower(ownerNames)) |&gt;\n  filter(str_detect(ownerNameSimplified, \"energy|power|light|hydro\")) |&gt;\n  mutate(ownerNameSimplified = case_when(\n    str_detect(ownerNameSimplified, \"duke\")    ~ \"Duke\",\n    .default = \"Other\"\n  ),\n  primaryPurposeId = fct_lump_n(primaryPurposeId, 6)\n  ) |&gt;\n  count(ownerNameSimplified, primaryPurposeId, nidHeightId) |&gt;\n  mutate(ownerNameSimplified = fct_reorder(ownerNameSimplified, n, sum),\n         primaryPurposeId = fct_reorder(primaryPurposeId, n, sum),\n         nidHeightId = fct_rev(nidHeightId)\n  )\n\np4 &lt;-  ggplot(data = nc_power_utility,\n  aes(axis1 = ownerNameSimplified, axis2 = primaryPurposeId, axis3 = nidHeightId,\n      y = n)) +\n  scale_x_discrete(\n    limits = c(\"Owner\", \"Purpose\", \"Height\"),\n    expand = c(0.1, 0.07),\n    position = \"top\") +\n  geom_alluvium(aes(fill = primaryPurposeId),\n                show.legend = FALSE) +\n  geom_stratum(linewidth = 0.05,\n               alpha = 0.8) +\n  geom_text(stat = \"stratum\",\n    aes(label = after_stat(stratum)),\n      size = 3) +\n  scale_fill_brewer(palette = \"Paired\") +\n  theme(axis.text.x = element_text(size = rel(2))) +\n  labs(\n    y = NULL\n  )\n\np4 +\n  plot_annotation(\n    title = \"Power utilities owning dams in NC\\nby primary owner and primary purpose\",\n    subtitle = glue(\"Many of the dams with 'other' purpose are ash dams located near coal-fired power plants.\",\n                    \"\\nDuke Energy is the primary power provider in North Carolina.\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 7.6: Power utility owned dams in NC by owner and purpose",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Owners in NC</span>"
    ]
  },
  {
    "objectID": "drainage.html",
    "href": "drainage.html",
    "title": "8  Drainage",
    "section": "",
    "text": "8.1 Dams with the largest drainage areas\nThe numerical summaries in Chapter 6 raise some interesting questions. One is “How is drainageArea defined? Is it the watershed drained by the current dam extending upriver to the next dam? Or is a dam’s drainageArea inclusive of the whole up-river watershed? The exploration below confirms the latter.\nFirst: data quality. There seems to be some errors in the data. In the top 20 dams in terms of drainageArea (mi^2), some seem too small (nidStorage, nidHeight and surfaceArea) to drain such a large area (Table 8.1).\nIn particular:\nShow the code\ndta_for_plot &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  select(name, otherNames, state, big_dam, nidId, nidStorage, nidHeight, damLength, surfaceArea, maxDischarge, drainageArea)\n  \n\ndta_for_plot |&gt;\n  slice_max(order_by = drainageArea,\n            n = 20) |&gt;\n  # select(-damLength) |&gt;\n  arrange(desc(drainageArea)) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 11) |&gt;\n  tab_header(md(\"**Top 20 dams in NID in terms of drainageArea**\")) |&gt;\n  sub_missing() |&gt;\n  fmt_number(columns = c(nidStorage, nidHeight, surfaceArea, maxDischarge, drainageArea),\n             decimals = 0)\n\n\n\n\nTable 8.1\n\n\n\n\n\n\n\n\n\nTop 20 dams in NID in terms of drainageArea\n\n\nname\notherNames\nstate\nbig_dam\nnidId\nnidStorage\nnidHeight\ndamLength\nsurfaceArea\nmaxDischarge\ndrainageArea\n\n\n\n\nEastern Avenue\nMaps\nOklahoma\nFALSE\nOK22289\n1,680\n13\n300\n142\n48,000\n8,300,000\n\n\nOld River\nSidney A. Murray, Jr.\nLouisiana\nTRUE\nLA00598\n—\n134\n1004\n—\n—\n1,250,000\n\n\nSt. Road 846 Land Trust Imp\n—\nFlorida\nFALSE\nFL75010\n350\n9\n10000\n72\n10\n721,640\n\n\nReed Bingham Park Lake Dam\n—\nGeorgia\nFALSE\nGA01591\n3,812\n16\n2000\n295\n—\n385,000\n\n\nLong Shoals Lake Dam\n—\nNorth Carolina\nFALSE\nNC00372\n160\n13\n350\n30\n990\n302,720\n\n\nRobert Moses - St. Lawrence\nRobert Moses - Robert H. Saunders Dam\nNew York\nTRUE\nNY00678\n803,000\n167\n1600\n37,500\n—\n300,000\n\n\nLaguna Diversion\nLaguna Diversion Reservoir\nArizona\nFALSE\nAZ10315\n1,600\n43\n4780\n—\n487,000\n287,000\n\n\nGrand Falls Dam\nGrand Falls Dam\nMissouri\nFALSE\nMO20006\n401\n15\n—\n50\n—\n275,000\n\n\nOahe Dam\nLake Oahe\nSouth Dakota\nTRUE\nSD01095\n23,600,000\n245\n9300\n376,000\n300,000\n243,490\n\n\nBonneville Locks and Dam\nLake Bonneville\nOregon\nTRUE\nOR00001\n537,000\n197\n2477\n20,600\n1,600,000\n240,000\n\n\nThe Dalles Lock and Dam\nLake Celilo\nOregon\nTRUE\nOR00002\n330,000\n200\n8735\n11,200\n2,290,000\n237,000\n\n\nJohn Day Lock and Dam\nLake Umatilla\nOregon\nTRUE\nOR00011\n2,530,000\n230\n5900\n55,000\n2,250,000\n226,000\n\n\nMcNary Lock and Dam\nLake Wallula\nOregon\nTRUE\nOR00616\n1,350,000\n220\n7365\n38,800\n2,200,000\n214,000\n\n\nOlmsted Locks and Dam\n—\nIllinois\nFALSE\nIL50745\n728,000\n67\n3575\n19,000\n—\n203,000\n\n\nParker Dam\nLake Havasu\nArizona\nTRUE\nAZ10312\n180,000\n320\n856\n20,390\n314,000\n182,700\n\n\nSoo Locks\nSuperior\nMichigan\nFALSE\nMI00650\n277,540,000\n17\n968\n20,255,000\n68,000\n181,000\n\n\nGarrison Dam\nLake Sakakawea\nNorth Dakota\nTRUE\nND00145\n26,000,000\n210\n11300\n133,000\n827,000\n180,940\n\n\nRetamal Diversion Dam\n—\nTexas\nFALSE\nTX07037\n6,000\n36\n172\n—\n30,000\n176,112\n\n\nAnzalduas Diversion Dam\n—\nTexas\nFALSE\nTX07036\n16,400\n23\n524\n1,287\n130,000\n176,112\n\n\n12th Street Intake Dam\n—\nWest Virginia\nFALSE\nWV08308\n150\n10\n217\n35\n—\n172,160\nShow the code\ndta_for_model &lt;- dams |&gt;\n  st_drop_geometry() |&gt;\n  select(nidId, big_dam, nidStorage, nidHeight, surfaceArea, drainageArea, maxDischarge) |&gt;\n  filter(!is.na(nidStorage),\n         !is.na(drainageArea)) |&gt;\n  filter(!nidId %in% c(\"FL75010\", \"OK22289\", \"MI00650\"))\n\nn_dta_for_model &lt;- nrow(dta_for_model)\n\ntop100_storage &lt;- dta_for_model |&gt;\n  slice_max(order_by = nidStorage,\n            n = 100)\n\ntop100_drainage &lt;- dta_for_model |&gt;\n  slice_max(order_by = drainageArea,\n            n = 100)\n\ndta_for_plot &lt;- inner_join(top100_storage,\n                           top100_drainage |&gt;\n                             select(nidId),\n                           by = \"nidId\")\n\nn_top100_drainage_storage &lt;- nrow(dta_for_plot)\nSo let’s let’s remove them and look at the 54,443 dams in the NID that are not missing any values for nidStorage, nidHeight, surfaceArea, and drainageArea.\nIn Figure 8.1 Panel B the 12 larger points represent dams that are in both the top 100 dams by drainageArea and by nidStorage.\nShow the code\np1 &lt;- dta_for_model |&gt;\n  ggplot() +\n  geom_point(aes(nidStorage, drainageArea, color = big_dam),\n             size = 0.5, alpha = 0.4,\n             na.rm = TRUE,\n             show.legend = FALSE) +\n  scale_x_log10(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_color_viridis_d(end = 0.8) +\n  # guides(color = guide_legend(override.aes = list(size = 3))) +\n  labs(\n    subtitle = glue(\"A: Bi-modal distribution evident in dams with small nidStorage\",\n                    \"\\nSee visual vertical artifacts at ~100 and ~1000 acre-ft:\\non the small end are storage amounts rough estimates?\")\n  )\n\nmy_drainageArea &lt;- 70000\nmy_nidStorage &lt;- 100000\n\np2 &lt;- dta_for_model |&gt;\n  filter(drainageArea &gt; my_drainageArea,\n         nidStorage &gt; my_nidStorage) |&gt;\n  ggplot() +\n  geom_point(data = dta_for_plot,\n             aes(nidStorage, drainageArea, color = big_dam),\n             size = 3, alpha = 0.4,\n             na.rm = TRUE) +\n  geom_point(aes(nidStorage, drainageArea, color = big_dam),\n             size = 0.5, alpha = 0.4,\n             na.rm = TRUE) +\n  scale_x_log10(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_color_viridis_d(end = 0.8) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(size = 3))) +\n  theme(legend.position.inside = c(0.2, 0.85)) + # c(0.85, 0.2)) +\n  labs(\n    subtitle = glue(\"B: Zooming in on the upper right: {n_top100_drainage_storage} dams\", \n                    \"\\n are in top 100 in both drainage and storage\",\n                    \"\\nShowing drainageArea &gt; {my_drainageArea}, nidStorage &gt; {my_nidStorage}\"),\n    y = NULL\n  )\n\np1 + p2 +\n  plot_annotation(\n    title = \"Dam drainage area (mi^2) by storage (acre-ft)\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 8.1: Drainage by storage\nShow the code\ntop_dams &lt;- dams |&gt;\n  select(name, otherNames, nidId, big_dam, primaryOwnerTypeId, primaryPurposeId, nidStorage, nidHeight, surfaceArea, drainageArea) |&gt;\n  inner_join(\n    dta_for_plot |&gt;\n      select(nidId),\n    by = \"nidId\"\n  ) |&gt;\n  mutate(drainageArea_m2 = drainageArea * 2.59e+6, # convert to meters\n         drainage_radius = sqrt(drainageArea_m2 / pi), # area = pi * r^2\n         drainage_circle = st_buffer(geom, dist = drainage_radius),\n         drainage_area_check = st_area(drainage_circle),\n         ptc_of_defined_area = drainage_area_check / drainageArea_m2\n  )\n\ntop_dams |&gt;\n  st_drop_geometry() |&gt;\n  arrange(desc(drainageArea)) |&gt;\n  select(name, otherNames, nidId, primaryOwnerTypeId, primaryPurposeId, nidStorage, nidHeight, surfaceArea, drainageArea) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 11) |&gt;\n  tab_header(md(glue(\"**There are {n_top100_drainage_storage} dams in NID in the top 100\", \n                      \" for both storage capacity and drainageArea**\"))) %&gt;%\n  fmt_number(columns = c(nidStorage, nidHeight, surfaceArea, drainageArea),\n             decimals = 0)\n\n\n\n\nTable 8.2\n\n\n\n\n\n\n\n\n\nThere are 12 dams in NID in the top 100 for both storage capacity and drainageArea\n\n\nname\notherNames\nnidId\nprimaryOwnerTypeId\nprimaryPurposeId\nnidStorage\nnidHeight\nsurfaceArea\ndrainageArea\n\n\n\n\nOahe Dam\nLake Oahe\nSD01095\nFederal\nFlood Risk Reduction\n23,600,000\n245\n376,000\n243,490\n\n\nJohn Day Lock and Dam\nLake Umatilla\nOR00011\nFederal\nNavigation\n2,530,000\n230\n55,000\n226,000\n\n\nGarrison Dam\nLake Sakakawea\nND00145\nFederal\nHydroelectric\n26,000,000\n210\n133,000\n180,940\n\n\nHoover Dam\nLake Mead\nNV10122\nFederal\nHydroelectric\n30,237,000\n730\n162,700\n167,800\n\n\nFalcon Dam\nNA\nTX00024\nFederal\nFlood Risk Reduction\n3,177,000\n175\n115,400\n159,270\n\n\nAmistad Dam\nNA\nTX02296\nFederal\nFlood Risk Reduction\n5,128,000\n287\n89,000\n123,134\n\n\nGlen Canyon Dam\nLake Powell\nAZ10307\nFederal\nHydroelectric\n25,025,826\n710\n160,784\n107,417\n\n\nGrand Coulee Dam\nFranklin D. Roosevelt Lake\nWA00262\nFederal\nFlood Risk Reduction\n9,715,346\n550\n82,300\n75,117\n\n\nKeystone Dam\nKeystone Lake\nOK10309\nFederal\nFlood Risk Reduction\n1,672,613\n121\n22,420\n74,506\n\n\nBrownlee\nBrownlee\nID00056\nPrivate\nHydroelectric\n1,470,000\n395\n14,621\n72,800\n\n\nFort Peck Dam\nFort Peck Lake\nMT00025\nFederal\nFlood Risk Reduction\n19,100,000\n256\n93,000\n57,725\n\n\nPainted Rock Dam\nPainted Rock Reservoir\nAZ10002\nFederal\nFlood Risk Reduction\n4,831,500\n181\n1\n50,800\nIn the NID data dictionary, drainage area is defined as follows:\nThus when one dam is downriver of another, the downriver dam drainage area includes the upriver dam’s drainage area. In Figure 8.2 this is visible in the drainage areas of dams on the Columbia River (Figure 8.3). It’s also evident in the dams on the Missouri River in Montana, North Dakota, and South Dakota (Figure 8.4).\nThe top dams are all west of the Mississippi River.\nShow the code\nn_top_dams &lt;- nrow(top_dams)\n\nggplot() +\n  geom_sf(data = state_boundaries_sf,\n          color = \"grey50\",\n          fill = NA,\n          alpha = 0.01) +\n  geom_sf(data = rivers_us,\n          color = \"darkblue\",\n          linewidth = 0.1,\n          fill = NA,\n          alpha = 0.3) +\n  geom_sf(data = top_dams |&gt;\n            st_set_geometry(\"drainage_circle\"), #|&gt;\n            # st_crop(bbox_continental),\n          color = \"dodgerblue\", fill = \"dodgerblue\",\n          alpha = 0.2) +\n  geom_sf(data = top_dams |&gt;\n            mutate(n_primaryPurposeId = n(),\n                   .by = primaryPurposeId) |&gt;\n            mutate(primaryPurposeId = glue(\"{primaryPurposeId} (n={n_primaryPurposeId})\"),\n                   primaryPurposeId = fct_reorder(primaryPurposeId, -n_primaryPurposeId)),\n          aes(color = primaryPurposeId),\n          size = 3,\n          alpha = 0.75) +\n  guides(color = guide_legend(override.aes = list(size = 3),\n                              position = \"inside\")) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.15, 0.15)) +\n  labs(\n    title = glue(\"There are {n_top_dams} top dams in in the National Inventory of Dams\"),\n    subtitle = glue(\"Defined as the top 100 in both drainage area and storage area.\",\n                    \" Circles show size of drainage area, not actual drainage area\"),\n    caption = my_caption_nid_nws\n  )\n\n\n\n\n\n\n\n\nFigure 8.2: Map of top dams\nZooming into the parts of the Columbia River basin in Washington and Oregon…\nShow the code\ncolumbia_river_watershed &lt;- st_read(here(\"data/raw/usgs/WBD_17_HU2_GDB/WBD_17_HU2_GDB.gdb\"),\n                                    layer = \"WBDHU4\",\n                                    quiet = TRUE)\n\n# col_layers &lt;- st_layers(here(\"data/raw/usgs/WBD_17_HU2_GDB/WBD_17_HU2_GDB.gdb\"))\n# library(nhdplusTools)\n# \n# # -------------------------------------------------------------\n# # 1. Find the COMID (hydrologic ID) for the Columbia River outlet\n# # -------------------------------------------------------------\n# # Use the approximate mouth coordinates of the Columbia River\n# # columbia_outlet &lt;- data.frame(\n# #   lon = -123.97,\n# #   lat = 46.25\n# # )\n# \n# columbia_outlet &lt;- c(\n#   lon = -123.97,\n#   lat = 46.25\n# )\n# # \n# # # Get COMID for the river outlet\n# comid &lt;- discover_nhdplus_id(st_sfc(st_point(columbia_outlet),\n#                                     crs = \"NAD83\")\n# )\n# # \n# # # -------------------------------------------------------------\n# # # 2. Get the upstream watershed (all catchments draining to that COMID)\n# # # -------------------------------------------------------------\n# # # get_vaa_names() # shows available attributes\n# # columbia_watershed &lt;- get_nhdplus(#AOI = comid, \n# #   comid = comid,\n# #   realization = \"catchment\")\n# \n# # # Alternatively, to get the complete upstream network (larger area):\n# columbia_network &lt;- get_nhdplus(comid = comid, realization = \"catchment\")\n# \n# flowline &lt;- navigate_nldi(list(featureSource = \"comid\", \n#                                featureID = comid), \n#                           mode = \"upstreamTributaries\", \n#                           distance_km = 9000)\n# # \n# # -------------------------------------------------------------\n# # 3. Convert to sf and ensure consistent CRS\n# # -------------------------------------------------------------\n# columbia_sf &lt;- st_as_sf(columbia_watershed)\n\n# -------------------------------------------------------------\n# 4. Plot with ggplot\n# -------------------------------------------------------------\n\nmy_rivers &lt;- st_join(columbia_river_watershed, rivers_us,\n                     join = st_touches)\n\n# my_rivers &lt;- st_crop(rivers_us, columbia_river_watershed)\n\nwa_or_bbox &lt;- st_bbox(state_boundaries_sf  |&gt;\n                        filter(state_abb %in% c(\"WA\", \"OR\"))\n                      )\n\nggplot() +\n  geom_sf(data = state_boundaries_sf |&gt;\n            filter(state_abb %in% c(\"WA\", \"OR\")),\n          fill = NA) +\n  geom_sf(data = columbia_river_watershed |&gt;\n            st_crop(wa_or_bbox),\n          fill = \"skyblue\", \n          color = \"firebrick\", \n          size = 0.1,\n          alpha = 0.2) +\n   geom_sf(data = my_rivers |&gt;\n            # filter(pname == \"COLUMBIA R\") |&gt;\n            st_crop(wa_or_bbox),\n          color = \"darkblue\",\n          linewidth = 0.5,\n          fill = NA,\n          alpha = 0.3) +\n  geom_sf(data = rivers_us |&gt;\n            filter(PNAME == \"COLUMBIA R\") |&gt;\n            st_crop(wa_or_bbox),\n          color = \"darkblue\",\n          linewidth = 1,\n          fill = NA,\n          alpha = 0.3) +\n  coord_sf() +\n  labs(\n    title = \"Columbia River Watershed\",\n    # subtitle = \"Retrieved using nhdplusTools and plotted with ggplot2\",\n    caption = \"Source: USGS National Hydrography Dataset (NHDPlus)\"\n  ) +\n  theme_minimal()\n\n# # -------------------------------------------------------------\n# # 1. Get the USGS Watershed Boundary Dataset (WBD)\n# # -------------------------------------------------------------\n# # HUC2 = 17 corresponds to the Columbia River Basin\n# columbia_huc &lt;- \"17\"\n# \n# # Retrieve the HUC2 polygon for the Columbia River Basin\n# columbia_basin &lt;- subset_wbd(huc = columbia_huc, type = \"huc2\")\n# \n# # -------------------------------------------------------------\n# # 2. Check and transform CRS if needed\n# # -------------------------------------------------------------\n# columbia_basin &lt;- st_transform(columbia_basin, 4326)\n# \n# # -------------------------------------------------------------\n# # 3. Plot with ggplot\n# # -------------------------------------------------------------\n# ggplot() +\n#   geom_sf(data = columbia_basin, fill = \"lightblue\", color = \"darkblue\", size = 0.4) +\n#   coord_sf() +\n#   labs(\n#     title = \"Columbia River Basin (HUC2 = 17)\",\n#     subtitle = \"Watershed Boundary Dataset (WBD)\",\n#     caption = \"Source: USGS / nhdplusTools\"\n#   ) +\n#   theme_minimal()\nShow the code\ndta_for_plot &lt;- dams |&gt;\n  select(nidId, riverName, drainageArea, geom) |&gt;\n  filter(str_squish(str_to_lower(riverName)) == \"columbia river\") |&gt;\n  mutate(drainageArea_m2 = drainageArea * 2.59e+6, # convert to meters\n         drainage_radius = sqrt(drainageArea_m2 / pi), # area = pi * r^2\n         drainage_circle = st_buffer(geom, dist = drainage_radius),\n         drainage_area_check = st_area(drainage_circle),\n         ptc_of_defined_area = drainage_area_check / drainageArea_m2,\n         spotlight = (drainageArea_m2 == max(drainageArea_m2) | \n                        drainageArea_m2 == min(drainageArea_m2))\n  )\n         \nn_dams_columbia &lt;- nrow(dta_for_plot)\n\nwa_or_bbox &lt;- st_bbox(state_boundaries_sf  |&gt;\n                        filter(state_abb %in% c(\"WA\", \"OR\"))\n                      )\n\nggplot() +\n  geom_sf(data = state_boundaries_sf  |&gt;\n            filter(state_abb %in% c(\"WA\", \"OR\")),\n          color = \"grey50\",\n          fill = NA,\n          alpha = 0.01) +\n  geom_sf(data = rivers_us |&gt;\n            filter(PNAME == \"COLUMBIA R\") |&gt;\n            st_crop(wa_or_bbox),\n          color = \"darkblue\",\n          linewidth = 1,\n          fill = NA,\n          alpha = 0.3) +\n  geom_sf(data = rivers_us |&gt;\n            st_crop(wa_or_bbox),\n          color = \"darkblue\",\n          linewidth = 0.1,\n          fill = NA,\n          alpha = 0.3) +\n  geom_sf(data = dta_for_plot |&gt;\n            filter(spotlight) |&gt;\n            st_set_geometry(\"drainage_circle\"), \n            # st_crop(bbox_continental),\n          color = \"dodgerblue\", fill = \"dodgerblue\",\n          alpha = 0.05) +\n  geom_sf(data = dta_for_plot,\n          aes(color = spotlight),\n          show.legend = FALSE,\n          alpha = 1) +\n  scale_color_manual(values = c(\"black\", \"firebrick\")) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.15, 0.15)) +\n  labs(\n    title = glue(\"Largest drainage area is dam most down-river;\\nsmallest is most up-river\"),\n    subtitle = glue(\"There are {n_dams_columbia} dams on the Columbia River according to the National Inventory of Dams.\",\n                    \"\\nCircles show size of drainage area, not actual drainage area.\"),\n    caption = my_caption_nid_nws\n  )\n\n\n\n\n\n\n\n\nFigure 8.3: Dams on the Columbia River",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Drainage</span>"
    ]
  },
  {
    "objectID": "drainage.html#dams-with-the-largest-drainage-areas",
    "href": "drainage.html#dams-with-the-largest-drainage-areas",
    "title": "8  Drainage",
    "section": "",
    "text": "FL75010 see also Google Maps\nOK22289 on the Oklahoma River see also Google Maps which is “claiming” the entire drainage area of the Oklahoma River, which like Soo locks in Michigan, distorts.\nMI00650 Soo Locks on Lake Superior as discussed in Chapter 6 Numbers.\n\n\n\n\n\n\n\n\n\n\n\nDrainage area of the dam, in square miles, which is defined as the area that drains to a particular point (in this case, the dam) on a river or stream.",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Drainage</span>"
    ]
  },
  {
    "objectID": "drainage.html#the-mississippi-river-system",
    "href": "drainage.html#the-mississippi-river-system",
    "title": "8  Drainage",
    "section": "8.2 The Mississippi river system",
    "text": "8.2 The Mississippi river system\n\n\nShow the code\nrivers_fname &lt;- here(\"data/raw/nws/rs16my07\") # subset of US river data \nrivers_us &lt;- st_read(rivers_fname,\n              crs = \"NAD83\",\n              quiet = TRUE) |&gt;\n  clean_names()\n\nmiss &lt;- rivers_us |&gt;\n  filter(str_detect(pname, \"^MISSISSIPPI\")) |&gt;\n  select(rf1_150_id, huc, seg, seqno, lev, pname, geometry)\n\nmiss_and_tribs &lt;- rivers_us |&gt;\n  filter(str_detect(pname, \"^(MISSISSIPPI|MISSOURI|OHIO|ARKANSAS|ILLINOIS|TENNESSEE)\"))\n\ndams_on_miss &lt;- dams |&gt;\n  filter(str_detect(riverName, \"^MISSISSIPPI\")) |&gt;\n  filter(!nidId %in% c(\"MO40057\")) |&gt;\n  filter(drainageArea &gt; 0) |&gt;\n  mutate(drainageArea_m2 = drainageArea * 2.59e+6, # convert to meters\n         drainage_radius = sqrt(drainageArea_m2 / pi), # area = pi * r^2\n         drainage_circle = st_buffer(geom, dist = drainage_radius),  # shouldn't need a factor on dist?\n         drainage_area_check = st_area(drainage_circle),\n         ptc_of_defined_area = drainage_area_check / drainageArea_m2\n  )\n\ndams_on_miss_flow_order &lt;- dams_on_miss |&gt;\n  arrange(desc(latitude)) |&gt;\n  mutate(idx = row_number())\n\ndams_on_miss_flow_order_no_drainageArea &lt;- dams |&gt;\n  filter(str_detect(riverName, \"^MISSISSIPPI\")) |&gt;\n  arrange(desc(latitude)) |&gt;\n  mutate(idx = row_number()) |&gt;\n  filter(is.na(drainageArea))\n\ndams_on_miss_and_tribs &lt;- dams |&gt;\n  filter(str_detect(riverName, \"^(MISSISSIPPI|MISSOURI|OHIO|ARKANSAS|ILLINOIS|TENNESSEE)\")) |&gt;\n  filter(!nidId %in% c(\"PA00714\", \"MO40057\")) |&gt;\n  filter(!nidId %in% c(\"MO40057\")) |&gt;\n  filter(drainageArea &gt; 0) |&gt;\n  mutate(drainageArea_m2 = drainageArea * 2.59e+6, # convert to meters\n         drainage_radius = sqrt(drainageArea_m2 / pi), # area = pi * r^2\n         drainage_circle = st_buffer(geom, dist = drainage_radius),  # shouldn't need a factor on dist?\n         drainage_area_check = st_area(drainage_circle),\n         ptc_of_defined_area = drainage_area_check / drainageArea_m2\n  )\n\n\nThe Mississippi River and its tributaries drain the largest portion of the continental US. The Mississippi has been (mostly) “tamed” through many dams and levees.\nFigure 8.4 shows graphically that, in general, the drainageArea increases at dams downriver. Some exceptions are visible on the Missouri river, which in some cases might be dams on tributaries close to the Missouri River.\n\n\nShow the code\nggplot() +\n  geom_sf(data = continental_us_border,\n          color = \"grey50\",\n          fill = NA,\n          linewidth = 0.1,\n          alpha = 0.1) +\n  geom_sf(data = miss_and_tribs,\n          color = \"darkblue\",\n          linewidth = 0.1,\n          fill = NA,\n          alpha = 0.3) +\n  geom_sf(data = dams_on_miss_and_tribs |&gt;\n            st_set_geometry(\"drainage_circle\"),\n          color = NA, #\"dodgerblue\",\n          fill = \"dodgerblue\",\n          alpha = 0.05) +\n  geom_sf(data = dams_on_miss_and_tribs,\n          size = 0.5,\n          color = \"firebrick\") +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.15, 0.15)) +\n  labs(\n    title = glue(\"The Mississippi River and its major tributaries\"),\n    # subtitle = str_wrap(nws_river_data_description, 120),\n    caption = my_caption_nid_nws\n  )\n\n\n\n\n\n\n\n\nFigure 8.4: Map of the Mississippi River and its major tributaries (NWS data)\n\n\n\n\n\nLooking only at the Mississippi River (Figure 8.5) and related Figure 8.6, it’s clear that drainage area increases for dams downriver.\n\n\nShow the code\nggplot() +\n  geom_sf(data = continental_us_border,\n          color = \"grey50\",\n          fill = NA,\n          linewidth = 0.1,\n          alpha = 0.1) +\n  geom_sf(data = miss_and_tribs,\n          color = \"darkblue\",\n          linewidth = 0.1,\n          fill = NA,\n          alpha = 0.3) +\n  geom_sf(data = dams_on_miss |&gt;\n            st_set_geometry(\"drainage_circle\"),\n          color = NA, #\"dodgerblue\",\n          fill = \"dodgerblue\",\n          alpha = 0.1) +\n  geom_sf(data = dams_on_miss,\n          size = 0.5,\n          color = \"firebrick\") +\n  geom_sf(data = dams_on_miss_flow_order_no_drainageArea,\n          size = 4,\n          shape = \"X\",\n          color = \"firebrick\") +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.15, 0.15)) +\n  labs(\n    title = glue(\"The Mississippi River\"),\n    subtitle = \"Dams without drainageArea data shown with 'X'\",\n    caption = my_caption_nid_nws\n  )\n\n\n\n\n\n\n\n\nFigure 8.5: Map of dams on the Mississippi River with drainage area\n\n\n\n\n\n\nFigure 8.6 presents the same data:\n\n\nShow the code\ndams_on_miss_flow_order |&gt;\n  ggplot() +\n  geom_point(aes(idx, drainageArea),\n             na.rm = TRUE) +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.04)),\n                     breaks = c(1, 1:4*10)) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),\n                     expand = expansion(mult = c(0.01, 0.04))) +\n  labs(\n    title = \"Dams on the Mississippi\\ndrainage area increases down-river\",\n    x = \"Index north to south (1 is northern-most dam)\",\n    y = \"Drainage area (mi^2)\",\n    caption = my_caption_nid_nws\n  )\n\n\n\n\n\n\n\n\nFigure 8.6: Dams on the Mississippi increase in drainage area down-river",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Drainage</span>"
    ]
  },
  {
    "objectID": "dams-and-waterways.html",
    "href": "dams-and-waterways.html",
    "title": "9  Dams, waterways, and watersheds",
    "section": "",
    "text": "9.1 Types of waterways associated with dams\nAlmost all dams are associated with a waterway.1 A dam is either the origin of a waterway, or a break in its flow.\nShow the code\ndams_and_rivers_count_by_state &lt;- dams_and_rivers |&gt;\n  count(water_name, water_type, water_name_root, state, sort = TRUE) |&gt;\n  arrange(state, water_name_root)\n\ndams_and_rivers_count_by_state_simplified &lt;- dams_and_rivers |&gt;\n  count(water_type, state, sort = TRUE) |&gt;\n  arrange(state)\n\ndams_and_rivers_for_plotting &lt;-\n  left_join(\n    dams,\n    left_join(\n      dams_and_rivers_count_by_state |&gt;\n        select(-n),\n      dams_and_rivers |&gt;\n        select(nidId, state, water_name, water_name_root, riverName, starts_with(\"is_\")),\n      by = join_by(state, water_name, water_name_root)\n    ),\n    by = join_by(nidId, state, riverName)\n    )\n\n\n###### Bad river watershed\n#  https://www.usgs.gov/national-hydrography/access-national-hydrography-products\n# # The Bad River HUC8 code\n# bad_river_huc8 &lt;- \"10140102\"\n# Manually downloaded from https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/NHD/HU8/Shape/\n\nbad_river_watershed &lt;- st_read(here(\"data/raw/usgs/NHD-10140102/NHD_H_10140102_HU8_Shape/Shape\"),\n                        quiet = TRUE)\n\nbad_river_watershed_with_buffer &lt;- st_buffer(bad_river_watershed, \n                                             dist = watershed_buffer) # in meters\n\ndams_in_buffer_bbox &lt;- st_bbox(bad_river_watershed_with_buffer)\n\n# using mask() on a spatVector does better than st_join(join = st_within)\ndams_in_bad_river_watershed_tmp &lt;-\n  st_crop(dams_and_rivers_for_plotting, bad_river_watershed) |&gt;\n  st_join(st_as_sf(st_union(bad_river_watershed)), \n          join = st_within, left = FALSE) |&gt;\n   mutate(water_type = case_when(\n    str_detect(water_name, \"fork\")      ~ \"fork\",\n    str_detect(water_name, \"tributary\") ~ \"tributary\",\n    .default =                            \"tributary\"\n  ),\n  water_type = factor(water_type, levels = c(\"river\", \"fork\", \"tributary\")),\n  primary_owner = fct_collapse(primaryOwnerTypeId ,\"State and Local\" = c(\"State\", \"Local Government\"))) \n  \n# using mask() on a spatVector does better than st_join(join = st_within)\ndams_in_bad_river_watershed &lt;- mask(crop(vect(dams_in_bad_river_watershed_tmp), bad_river_watershed), \n                                               vect(bad_river_watershed)) |&gt;\n  st_as_sf()\n\ndams_in_buffer_around_bad_river_watershed_tmp &lt;-\n  st_crop(dams_and_rivers_for_plotting, bad_river_watershed_with_buffer) |&gt;\n  st_join(st_as_sf(st_union(bad_river_watershed_with_buffer)) |&gt;\n                     st_make_valid(), \n          join = st_within, left = FALSE) |&gt;\n  st_filter(st_union(dams_in_bad_river_watershed), \n            .predicate = st_disjoint) |&gt; # anti_join()\n   mutate(water_type = case_when(\n    str_detect(water_name, \"fork\")      ~ \"fork\",\n    str_detect(water_name, \"tributary\") ~ \"tributary\",\n    .default =                            \"river\"\n  ),\n  water_type = factor(water_type, levels = c(\"river\", \"fork\", \"tributary\")),\n  primary_owner = fct_collapse(primaryOwnerTypeId ,\"State and Local\" = c(\"State\", \"Local Government\"))) \n\n# using mask() on a spatVector does better than st_join(join = st_within)\ndams_in_buffer_around_bad_river_watershed &lt;- mask(crop(vect(dams_in_buffer_around_bad_river_watershed_tmp), \n                                                                  bad_river_watershed_with_buffer), \n                                               vect(bad_river_watershed),\n                                               inverse = TRUE) |&gt;\n  st_as_sf()\n\n# TEST\n# ggplot() +\n#   geom_sf(data = bad_river_watershed |&gt;\n#             st_union(),\n#           color = muted(\"firebrick\"),\n#           width = 0.2,\n#           alpha = 0.3) +\n#   geom_sf(data = dams_in_bad_river_watershed,\n#           color = \"firebrick\", fill = NA) +\n#  geom_sf(data = dams_in_buffer_around_bad_river_watershed,\n#           color = \"darkblue\") +\n#   labs(\n#     title = \"Dams in and near the Bad River watershed\",\n#     subtitle = \"TEST: there shouldn't be any blue markers in the watershed\",\n#     x = NULL,\n#     y = NULL,\n#     caption = my_caption\n#   )\n\n###### Get OSM data\n\nsd_bad_river_osm_fname &lt;- here(\"data/processed/st-bad-river-osm.rds\")\nsd_bad_river_osm_points_fname &lt;- here(\"data/processed/st-bad-river-osm-points.rds\")\nsd_bad_river_roads_fname &lt;- here(\"data/processed/st-bad-river-osm-roads.rds\")\nsd_bad_river_places_fname &lt;- here(\"data/processed/st-bad-river-osm-places.rds\")\nsd_bad_river_dams_osm_fname &lt;- here(\"data/processed/st-bad-river-dams-osm.rds\")\n\n### River lines and points (points include additional tributary detail)\n\n# Features from https://wiki.openstreetmap.org/wiki/Map_features#Water\n# requires osmdata package\n\nif(!file.exists(sd_bad_river_osm_fname) | !file.exists(sd_bad_river_osm_points_fname)) {\n  \n  sd_bad_river_list &lt;- dams_in_buffer_bbox |&gt; # includes buffer around Bad River watershed\n    opq()%&gt;%\n    add_osm_feature(key = \"waterway\",\n                    value = c(\"river\", \"stream\")) %&gt;%\n    osmdata_sf()\n  \n  sd_bad_river_points &lt;- sd_bad_river_list$osm_points |&gt; \n    st_transform(crs = \"NAD83\") # |&gt;\n    # st_crop(dams_in_buffer_bbox) # not needed (bbox used in initial query)\n  \n  write_rds(sd_bad_river_points, sd_bad_river_osm_points_fname)\n  \n  sd_bad_river &lt;- sd_bad_river_list$osm_multilines |&gt; # multilines are best for \"clean\" map\n    filter(str_detect(name, \"Bad River\")) |&gt;\n    st_transform(crs = \"NAD83\") # |&gt;\n    # st_crop(dams_in_buffer_bbox) # not needed (bbox used in initial query)\n  \n  write_rds(sd_bad_river, sd_bad_river_osm_fname)\n  \n  \n} else {\n  \n  sd_bad_river &lt;- read_rds(sd_bad_river_osm_fname)\n  sd_bad_river_points &lt;- read_rds(sd_bad_river_osm_points_fname)\n  \n}\n\n### Roads\n\n# Features from https://wiki.openstreetmap.org/wiki/Map_features#Water\n# requires osmdata package\n\nif(!file.exists(sd_bad_river_roads_fname)) {\n  \n  sd_bad_roads_list &lt;- dams_in_buffer_bbox |&gt; # includes buffer around Bad River watershed\n    opq()%&gt;%\n    add_osm_feature(key = \"highway\",\n                    value = c(\"motorway\", \"trunk\", \"primary\", \"secondary\", \"tertiary\", \"unclassified\", \"road\",\n                              \"track\")) %&gt;%\n    osmdata_sf()\n  \n  # sd_bad_river_road_points &lt;- sd_bad_roads_list$osm_points |&gt; \n  #   st_transform(crs = \"NAD83\") # |&gt;\n  #   # st_crop(dams_in_buffer_bbox) # not needed (bbox used in initial query)\n  # \n  # # write_rds(sd_bad_river_road_points, sd_bad_river_osm_road_points_fname)\n  \n  sd_bad_river_roads &lt;- sd_bad_roads_list$osm_lines |&gt; # multilines are best for \"clean\" map\n    # filter(str_detect(name, \"Bad River\")) |&gt;\n    st_transform(crs = \"NAD83\") |&gt;\n    # st_zm() |&gt; # get rid of error:\n    #            # Problem while converting geom to grob.\n    #            # ℹ Error occurred in the 2nd layer.\n    #            # Caused by error in `check.length()`:\n    #            # ! 'gpar' element 'fontsize' must not be length 0\n    st_crop(dams_in_buffer_bbox) |&gt; # perhaps not needed (bbox used in initial query)?\n    remove_empty(which = \"cols\") |&gt;\n    select(osm_id, name, NHS, expressway, highway, ref, surface, geometry) |&gt;\n    mutate(length = st_length(geometry),\n           length_m = as.numeric(length),\n           length_mi = length_m * 0.6213712)\n  \n  write_rds(sd_bad_river_roads, sd_bad_river_roads_fname)\n  \n  \n} else {\n  \n  sd_bad_river_roads &lt;- read_rds(sd_bad_river_roads_fname)\n  # sd_bad_river_road_points &lt;- read_rds(sd_bad_river_osm_points_fname)\n  \n}\n\n\n### Places: cities, towns, etc.\n\n# Features from https://wiki.openstreetmap.org/wiki/Map_features#Water\n# requires osmdata package\n\nif(!file.exists(sd_bad_river_places_fname)) {\n  \n  sd_bad_river_places_list &lt;- dams_in_buffer_bbox |&gt; # includes buffer around Bad River watershed\n    opq()%&gt;%\n    add_osm_feature(key = \"place\",\n                    value = c(\"city\", \"town\", \"village\", \"hamlet\")) %&gt;%\n    osmdata_sf()\n  \n  # sd_bad_river_road_points &lt;- sd_bad_roads_list$osm_points |&gt; \n  #   st_transform(crs = \"NAD83\") # |&gt;\n  #   # st_crop(dams_in_buffer_bbox) # not needed (bbox used in initial query)\n  # \n  # # write_rds(sd_bad_river_road_points, sd_bad_river_osm_road_points_fname)\n  \n  sd_bad_river_places &lt;- sd_bad_river_places_list$osm_points |&gt; # not many polygons or multipolygons\n    # filter(str_detect(name, \"Bad River\")) |&gt;\n    st_transform(crs = \"NAD83\") |&gt;\n    # st_zm() |&gt; # get rid of error:\n    #            # Problem while converting geom to grob.\n    #            # ℹ Error occurred in the 2nd layer.\n    #            # Caused by error in `check.length()`:\n    #            # ! 'gpar' element 'fontsize' must not be length 0\n    st_crop(dams_in_buffer_bbox) |&gt; # perhaps not needed (bbox used in initial query)?\n    remove_empty(which = \"cols\") |&gt;\n    select(osm_id, name, place, population, geometry)\n  \n  write_rds(sd_bad_river_places, sd_bad_river_places_fname)\n  \n  \n} else {\n  \n  sd_bad_river_places &lt;- read_rds(sd_bad_river_places_fname)\n  # sd_bad_river_road_points &lt;- read_rds(sd_bad_river_osm_points_fname)\n  \n}\n\n\n### Dam points\n# Each Dam in OSM has a NID reference\n\n# if(!file.exists(sd_bad_river_dams_osm_fname)) {\n#   \n#   sd_dams_osm &lt;- dams_in_buffer_bbox |&gt; # includes buffer around Bad River watershed\n#     opq()%&gt;%\n#     add_osm_feature(key = \"waterway\",\n#                     value = c(\"dam\")) %&gt;%\n#     osmdata_sf()\n#   \n#   sd_dams_osm_points &lt;- sd_dams_osm$osm_points |&gt;\n#     st_transform(crs = \"NAD83\") |&gt;\n#     filter(!is.na(name)) # |&gt;\n#     # st_crop(dams_in_buffer_bbox) # not needed (bbox used in initial query)\n#   \n#   write_rds(sd_dams_osm_points, sd_bad_river_dams_osm_fname)\n#   \n# } else {\n#   \n#   sd_dams_osm_points &lt;- read_rds(sd_bad_river_dams_osm_fname)\n#   \n# }\n\n# dam_intersect_watershed &lt;- \n#   inner_join(\n#     dams_in_bad_river_watershed |&gt;\n#       st_drop_geometry(),\n#     sd_dams_osm_points |&gt;\n#       mutate(name = str_remove(name, \" Dam$\")),\n#     by = join_by(nidId == `ref:US:NID`) #, name)\n#   ) |&gt;\n#   st_as_sf(crs = \"NAD83\") |&gt;\n#   remove_empty(which = \"cols\") |&gt;\n#   remove_constant()\n# \n# dam_intersect_buffer &lt;- \n#   inner_join(\n#     dams_in_buffer_around_bad_river_watershed |&gt;\n#       st_drop_geometry(),\n#     sd_dams_osm_points |&gt;\n#       mutate(name = str_remove(name, \" Dam$\")),\n#     by = join_by(nidId == `ref:US:NID`) #, name)\n#   ) |&gt;\n#   st_as_sf(crs = \"NAD83\") |&gt;\n#   remove_empty(which = \"cols\") |&gt;\n#   remove_constant()\n\n\n###### Detailed stream, river and lake/reservoir data from National Hydrology Dataset (NHD)\n\n# sd1_layers not needed once we know which layers to load\n# sd1_layers &lt;- st_layers(here(\"data/raw/usgs/NHD-SD/NHD_H_South_Dakota_State_GDB.zip\"))\n\nsd_flowline_fname &lt;- here(\"data/processed/sd_flowline.rds\")\nsd_waterbody_fname &lt;- here(\"data/processed/sd_waterbody.rds\")\n\nif(!file.exists(sd_flowline_fname)) {\n  \n  sd_NHDFlowLine &lt;-  st_read(here(\"data/raw/usgs/NHD-SD/NHD_H_South_Dakota_State_GDB.zip\"),\n                             layer = \"NHDFlowLine\",\n                             quiet = TRUE) |&gt;\n    clean_names() |&gt;\n    remove_empty(which = \"cols\") |&gt;\n    remove_constant() |&gt;\n    st_zm(drop = TRUE) |&gt; # don't need elevation\n    st_transform(\"NAD83\") |&gt;\n    st_crop(dams_in_buffer_bbox)\n  \n  write_rds(sd_NHDFlowLine, sd_flowline_fname)\n  \n} else {\n  \n  sd_NHDFlowLine &lt;- read_rds(sd_flowline_fname)\n}\n\nif(!file.exists(sd_waterbody_fname)) {\n  \n  sd_NHDWaterbody &lt;-  st_read(here(\"data/raw/usgs/NHD-SD/NHD_H_South_Dakota_State_GDB.zip\"),\n                              layer = \"NHDWaterbody\",\n                              quiet = TRUE) |&gt;\n    clean_names() |&gt;\n    remove_empty(which = \"cols\") |&gt;\n    remove_constant() |&gt;\n    filter(ftype %in% c(390, 436)) |&gt; \n    st_zm(drop = TRUE) |&gt; # don't need elevation\n    st_transform(\"NAD83\") |&gt;\n    st_crop(dams_in_buffer_bbox)\n  \n  write_rds(sd_NHDWaterbody, sd_waterbody_fname)\n  \n} else {\n  \n  sd_NHDWaterbody &lt;- read_rds(sd_waterbody_fname)\n}\n\n# Note: ftype: 390: LakePond, 436: Reservoir as per https://www.usgs.gov/ngp-standards-and-specifications/national-hydrography-dataset-nhd-data-dictionary-feature-classes\n\n## Now subset\n\nsd_NHDFlowLine_bad_river &lt;- sd_NHDFlowLine |&gt;\n  filter(str_detect(gnis_name, \"Bad River\"))\n\n# TODO: delete the following\n# bad_river_bbox &lt;- dams_in_buffer_bbox \n\n# TODO: Get rid of superfluous variables\n                          \n# dta_flowline_for_plot &lt;- sd_NHDFlowLine |&gt; # TODO: Don't need to do this st_crop() (was already done above)\n#   st_crop(dams_in_buffer_bbox)\n\nsd_NHDFlowLine_missouri_river &lt;- sd_NHDFlowLine |&gt;\n  filter(str_detect(gnis_name, \"Missouri River\"))\n\n# sd_NHDWaterbody_near_bad_river &lt;- sd_NHDWaterbody\n\nbad_river_length_km &lt;- sd_NHDFlowLine_bad_river |&gt;\n  filter(gnis_name == \"Bad River\") |&gt; # omit forks\n  pull(lengthkm) |&gt;\n  sum() \n\nbad_river_length_mi &lt;- bad_river_length_km * 0.621371\nThere are many names for small waterways, and they are not always used consistently–unsurprising given that naming happened independently over hundreds of years by many people and in the wide variety of geographical environments. In the NID we find the following (after significant data cleaning):\nShow the code\ndams_and_rivers |&gt;\n  count(water_type, sort = TRUE) |&gt;\n  mutate(pct = n / sum(n)) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  gt() |&gt;\n  tab_header(md(glue(\"**Types of waterways associated with dams&lt;br&gt;in the NID**\"))) |&gt;\n  tab_options(table.font.size = 11) |&gt;\n  cols_align(columns = water_type,\n             align = \"left\"\n  ) |&gt;\n  fmt_number(columns = \"n\",\n             decimals = 0\n  ) |&gt;\nfmt_percent(columns = \"pct\",\n             decimals = 0\n  )\n\n\n\n\nTable 9.1\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTypes of waterways associated with damsin the NID\n\n\nwater_type\nn\npct\n\n\n\n\ntributary\n30,662\n46%\n\n\ncreek\n19,339\n29%\n\n\nfork\n8,612\n13%\n\n\nriver\n7,314\n11%\n\n\narroyo\n524\n1%\n\n\nrace\n40\n0%\n\n\nTotal\n66,491\n100%\nLooking at the counts and proportions of these terms by state in Figure 9.1.\nShow the code\ndta_for_plot &lt;- dams_and_rivers_count_by_state_simplified |&gt;\n  mutate(state = fct_reorder(state, n, sum),\n         water_type = factor(water_type, levels = rev(c(\"river\", \"fork\", \"tributary\", \"creek\", \"arroyo\", \"race\")))\n         )\n  \np1 &lt;- dta_for_plot |&gt; \n  ggplot() +\n  geom_col(aes(n, state, fill = water_type)) +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  scale_fill_viridis_d(end = 0.9,\n                       direction = -1) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE)) +\n  theme(legend.position.inside = c(0.8, 0.3)) +\n  labs(\n    subtitle = \"A: Count\",\n    x = \"Number of river-related water types\",\n    y = NULL,\n    fill = \"Water type\"\n  )\n\np2 &lt;-  dta_for_plot |&gt;\n  ggplot() +\n  geom_col(aes(n, state, fill = water_type),\n           position = \"fill\",\n           show.legend = FALSE) +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.04)),\n                     labels = label_percent()) +\n  scale_fill_viridis_d(end = 0.9,\n                       direction = -1) +\n  labs(\n    subtitle = \"B: Proportion\",\n    x = \"Proportion of river-related water types\",\n    y = NULL,\n    fill = \"Water type\"\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"Count of river-related water types\\nassociated with dams in the NID\",\n    caption = my_caption,\n  )\n\n\n\n\n\n\n\n\nFigure 9.1: State-level river-related water types associated with dams in the NID",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Dams, waterways, and watersheds</span>"
    ]
  },
  {
    "objectID": "dams-and-waterways.html#types-of-waterways-associated-with-dams",
    "href": "dams-and-waterways.html#types-of-waterways-associated-with-dams",
    "title": "9  Dams, waterways, and watersheds",
    "section": "",
    "text": "North Carolina, Georgia, and Wyoming have the most usages of “creek”.\nIt’s not surprising that historically Spanish-speaking areas have the most use of “arroyo” (New Mexico and Arizona). I’m surprised to see so many uses of “arroyo” in North Dakota, Idaho, and Wyoming.\n“Race” seems to be a peculiarity of Michigan with only a small additional number in Indiana, Utah, and Nevada.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Dams, waterways, and watersheds</span>"
    ]
  },
  {
    "objectID": "dams-and-waterways.html#case-study-watershed-of-the-bad-river-south-dakota",
    "href": "dams-and-waterways.html#case-study-watershed-of-the-bad-river-south-dakota",
    "title": "9  Dams, waterways, and watersheds",
    "section": "9.2 Case study: watershed of the Bad River South Dakota",
    "text": "9.2 Case study: watershed of the Bad River South Dakota\nThe bad river watershed is located in southwest South Dakota just north of the famous Badlands and Badland National Park. It’s a dry environment. Nonetheless, there are a lot of dams within its watershed.\n\n\nShow the code\ndams_in_bad_river_watershed |&gt;\n  st_drop_geometry() |&gt;\n  count(water_type, sort = TRUE) |&gt;\n  mutate(pct = n / sum(n)) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  gt() |&gt;\n  tab_header(md(glue(\"**Types of waterways associated with dams&lt;br&gt;in the Bad River watershed**\"))) |&gt;\n  tab_options(table.font.size = 11) |&gt;\n  cols_align(columns = water_type,\n             align = \"left\"\n  ) |&gt;\n  fmt_number(columns = \"n\",\n             decimals = 0\n  ) |&gt;\nfmt_percent(columns = \"pct\",\n             decimals = 0\n  )\n\n\n\n\nTable 9.2\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTypes of waterways associated with damsin the Bad River watershed\n\n\nwater_type\nn\npct\n\n\n\n\ntributary\n388\n96%\n\n\nfork\n16\n4%\n\n\nTotal\n404\n100%\n\n\n\n\n\n\n\n\n\n\n\nThe Bad River flows north-east-east into the Missouri River at Fort Pierre. Across from it, on the east side of the Missouri, is Pierre, the state capital.\n\n\nShow the code\n# TODO: The following works, but I would prefer a 10-mile length bar on the plot (not 49.7 mi)\n\n### what is the East-West distance in miles of 0.5 degree at 44.0 degrees?\np1 &lt;- st_point(c(-101, 44.6)) #44.4\np2 &lt;- st_point(c(-101.5, 44.6)) #44.4\n\n# https://en.wikipedia.org/wiki/Longitude\n# https://en.wikipedia.org/wiki/Earth_radius\n# r_earth = 6371 # km\n# dist_long = (pi / 180) * r_earth * cos(44 * pi / 180)\n# 79.98694 km = 49.7 mi\n# TODO: Use the above to try out a 10 mi bar\n\nmyline &lt;- st_sfc(list(p1, p2)) |&gt;\n  st_set_crs(\"WGS84\") |&gt;\n  st_transform(\"NAD83\")\n\nlinestring &lt;- st_combine(st_sfc(list(p1, p2))) %&gt;% st_cast(\"LINESTRING\") |&gt;\n  st_set_crs(\"WGS84\") |&gt;\n  st_transform(\"NAD83\")\n\nlinestring_mi_label &lt;- drop_units(st_length(linestring)) * 0.000621371\n\nmyline_df &lt;- st_as_sf(linestring) |&gt;\n  st_set_crs(\"WGS84\") |&gt;\n  st_transform(\"NAD83\")\n\n# Now the label\np1 &lt;- st_point(c(-101, 44.6))\np2 &lt;- st_point(c(-101.5, 44.6))\np3 &lt;- st_point(c(-102, 44.6))\nmyline &lt;- st_sfc(list(p1, p2, p3)) |&gt;\n  st_set_crs(\"WGS84\") |&gt;\n  st_transform(\"NAD83\")\nlinestring &lt;- st_combine(st_sfc(list(p1, p2))) %&gt;% st_cast(\"LINESTRING\") |&gt;\n  st_set_crs(\"WGS84\") |&gt;\n  st_transform(\"NAD83\")\n\nmyline_df_label &lt;- st_as_sf(linestring) |&gt;\n  st_set_crs(\"WGS84\") |&gt;\n  st_transform(\"NAD83\") |&gt;\n  mutate(center = st_centroid(x),\n         name = \"50 miles\")\n\nst_geometry(myline_df_label) &lt;- myline_df_label$center\n\ndistance_bar &lt;- st_as_sf(\n  st_union(\n    myline_df, \n    myline_df_label\n  )\n)\n\n\nMost dams are associated with “tributary” waterways; the exceptions are near the north and south forks.\n\n\nShow the code\ndams_in_bad_river_watershed |&gt;\n  ggplot() +\n  geom_sf(data = bad_river_watershed |&gt;\n            st_union() |&gt;\n            st_crop(dams_in_buffer_bbox),\n          color = muted(\"firebrick\"),\n          linewidth = 0.2,\n          alpha = 0.3) +\n  geom_sf(data = sd_NHDFlowLine, # many small streams\n          color = \"darkblue\",# \"grey60\",\n          linewidth = 0.05,\n          alpha = 0.3) +\n  geom_sf(data = sd_bad_river, # the main river\n          # size = 0.01,\n          linewidth = 0.5,\n          color = \"darkblue\", # \"grey70\",\n          alpha = 0.5) +\n  geom_sf(data = sd_NHDFlowLine_missouri_river, # the bigger river that Bad River flows into\n          # size = 0.01,\n          # linewidth = 0.5,\n          color = \"darkblue\", # \"grey70\",\n          alpha = 0.5) +\n   geom_sf(data = sd_NHDWaterbody, # the lake just upriver from where Bad River enters the Missouri\n          # size = 0.01,\n          linewidth = 1,\n          color = NA, #\"darkblue\", # \"grey70\",\n          fill = \"darkblue\",\n          alpha = 0.5) +\n  # roads\n  geom_sf(data = sd_bad_river_roads |&gt; # roads in the buffer bbox\n            filter(highway == \"motorway\") |&gt;\n            st_crop(st_union(sd_NHDWaterbody)),\n          linewidth = 0.5,\n          color = \"black\", #\"darkblue\", # \"grey70\",\n          fill = NA,\n          alpha = 0.9) +\n  geom_sf(data = sd_bad_river_roads |&gt; # roads in the buffer bbox\n            filter(highway %in% c(\"primary\", \"secondary\") |\n                     highway == \"tertiary\" & surface %in% c(\"paved\", \"asphalt\", \"concrete\")\n                   ) |&gt;\n            st_crop(st_union(sd_NHDWaterbody)),\n          linewidth = 0.25,\n          color = \"sienna\", \n          fill = NA,\n          alpha = 0.9) +\n  # places\n  geom_sf(data = sd_bad_river_places |&gt; # places in the buffer bbox\n            filter(!is.na(place)) |&gt;\n            st_join(st_as_sf(st_union(bad_river_watershed)), \n                    join = st_within, left = FALSE),\n          size = 2, # was 0.15\n          color = \"sienna\", \n          # fill = \"gold\",\n          shape = 15, # solid square \n          alpha = 0.5) +  \n  geom_sf(aes(color = water_type),\n          size = 1,  # The NID dataset points\n          alpha = 0.8\n  ) +\n  geom_sf(data = distance_bar) + # distance bar line\n  geom_sf_label(data = distance_bar,\n                aes(label = name)) + # distance bar label\n  scale_color_viridis_d(end = 0.60,\n                        direction = -1) +\n  guides(color = guide_legend(override.aes = list(size = 3))) +\n  theme(legend.position = \"bottom\") +\n  labs(\n    title = \"Dams in the watershed of the Bad River in South Dakota\",\n    subtitle = glue(\"Dots are NID dams. Highways: black. Other paved roads and human settlements: tan\"),\n    x = NULL,\n    y = NULL,\n    color = \"NID water type\",\n    caption = my_caption_nid_nws_wbd_oms\n  )\n\n\n\n\n\n\n\n\nFigure 9.2: Dams in the watershed of the Bad River in South Dakota\n\n\n\n\n\n\n\n\nShow the code\n## Not in the watershed\n\ndta_for_plot &lt;- dams_in_buffer_around_bad_river_watershed |&gt;\n  filter(water_name_root == \"bad river\")\n\nn_dams_in_error &lt;- nrow(dta_for_plot)\n\ndta_for_plot |&gt;\n  ggplot() +\n  geom_sf(data = bad_river_watershed |&gt;\n            st_union() |&gt;\n            st_crop(dams_in_buffer_bbox),\n          color = muted(\"firebrick\"),\n          linewidth = 0.2,\n          alpha = 0.3) +\n  geom_sf(data = sd_NHDFlowLine, # many small streams\n          color = \"darkblue\",# \"grey60\",\n          linewidth = 0.05,\n          alpha = 0.3) +\n  geom_sf(data = sd_bad_river, # the main river\n          # size = 0.01,\n          linewidth = 0.5,\n          color = \"darkblue\", # \"grey70\",\n          alpha = 0.5) +\n  geom_sf(data = sd_NHDFlowLine_missouri_river, # the bigger river that Bad River flows into\n          # size = 0.01,\n          linewidth = 0.5,\n          color = \"darkblue\", # \"grey70\",\n          alpha = 0.5) +\n   geom_sf(data = sd_NHDWaterbody, # the lake just upriver from where Bad River enters the Missouri\n          # size = 0.01,\n          linewidth = 1,\n          color = NA, #\"darkblue\", # \"grey70\",\n          fill = \"darkblue\",\n          alpha = 0.5) +\n  geom_sf(aes(color = water_type),\n          size = 2,  # The NID dataset points\n          alpha = 0.8\n          ) +\n  geom_sf(data = distance_bar) + # distance bar line\n  geom_sf_label(data = distance_bar,\n                aes(label = name)) + # distance bar label\n  scale_color_viridis_d(end = 0.60,\n                        direction = -1) +\n  guides(color = guide_legend(override.aes = list(size = 3))) +\n  theme(legend.position = \"bottom\") +\n  labs(\n    title = glue(\"There are {n_dams_in_error} dams associated with the Bad River\\nbut are not in its watershed\"),\n    subtitle = \"Two are debatable (on the boundary of the watershed). The other two seem to be recorded in error.\",\n    x = NULL,\n    y = NULL,\n    color = \"NID water type\",\n    caption = my_caption_nid_nws_wbd_oms\n  )\n\n\n\n\n\n\n\n\nFigure 9.3: Dams associated with the Bad River but not in its the watershed\n\n\n\n\n\n\n\n\nShow the code\nggplot() +\n  geom_sf(data = bad_river_watershed |&gt;\n            st_union() |&gt;\n            st_crop(dams_in_buffer_bbox),\n          color = muted(\"firebrick\"),\n          linewidth = 0.2,\n          alpha = 0.3) +\n  geom_sf(data = sd_bad_river_points |&gt;\n            st_crop(dams_in_buffer_bbox), \n          size = 0.005,\n          color = \"grey90\",\n          alpha = 0.05) +\n  geom_sf(data = sd_bad_river,\n          size = 0.005,\n          color = \"grey70\",\n          alpha = 0.05) + # was 0.3\n  geom_sf(data = dams_in_bad_river_watershed |&gt;\n            filter(primary_owner == \"Private\"), \n          size = 1,\n          alpha = 0.2\n          ) + \n  geom_sf(data = dams_in_bad_river_watershed |&gt;\n            filter(primary_owner != \"Private\"), \n          aes(color = primary_owner),\n          size = 1,\n          alpha = 0.8\n          ) + \n  scale_color_viridis_d(end = 0.6,\n                       direction = -1) +\n  guides(color = guide_legend(override.aes = list(size = 3))) +\n  theme(legend.position = \"bottom\") +\n  labs(\n    title = \"Publically-owned dams\\nare not on the main river\",\n    subtitle = glue(\"Federal dams are owned by the US Forest Service.\\nBad River watershed South Dakota\"),\n    color = \"Primary owner\",\n    caption = my_caption_nid_nws_wbd_oms\n  )\n\n\n\n\n\n\n\n\nFigure 9.4: Publically owned dams are not on the main river\n\n\n\n\n\n\n\n\nShow the code\nmedian_nidHeight_by_owner &lt;- dams_in_bad_river_watershed |&gt;\n  st_drop_geometry() |&gt;\n  summarize(median_nidHeight = median(nidHeight, na.rm = TRUE),\n         .by = primary_owner)\n\np1 &lt;- dams_in_bad_river_watershed |&gt;\n  count(primary_owner, primaryPurposeId) |&gt;\n  mutate(primaryPurposeId = fct_reorder(primaryPurposeId, n, sum)) |&gt; \n  ggplot(aes(n, primaryPurposeId, fill = primary_owner)) +\n  geom_col() +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_viridis_d(end = 0.90,\n                       direction = -1) +\n  scale_color_viridis_d(end = 0.90,\n                       direction = -1) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.7, 0.3)) +\n  labs(\n    subtitle = glue(\"A: Publicly-owned dams\",\n                    \"\\nare mostly for recreation, water supply,\", \n                    \"\\nand irrigation\"), \n    x = \"Count\",\n    y = NULL\n  )\n\np2 &lt;- dams_in_bad_river_watershed |&gt;\n  ggplot(aes(nidHeight, fill = primary_owner)) +\n  geom_histogram(binwidth = 5,\n                 alpha = 0.6) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  scale_fill_viridis_d(end = 0.90,\n                       direction = -1) +\n  scale_color_viridis_d(end = 0.90,\n                       direction = -1) +\n  guides(color = \"none\",\n         fill = \"none\") +\n  labs(\n    subtitle = glue(\"B: Private dams are mostly for\", \n                    \"\\nstock, fish, and wildlife\"),\n    x = \"nidHeight (ft)\",\n    y = NULL\n  )\n\np3 &lt;- dams_in_bad_river_watershed |&gt;\n  ggplot(aes(nidHeight, color = primary_owner)) +\n  geom_vline(data = median_nidHeight_by_owner,\n             aes(xintercept = median_nidHeight, color = primary_owner),\n             lty = 2,\n             linewidth = 0.25,\n             alpha = 0.75) +\n  geom_density() +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  scale_color_viridis_d(end = 0.90,\n                       direction = -1) +\n  guides(color = \"none\",\n         fill = \"none\") +\n  labs(\n    subtitle = glue(\"C: Median dam heights are similar\"),\n    x = \"nidHeight (ft)\",\n    y = NULL\n  )\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Dams in the Bad River watershed\",\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 9.5: Dams on the Bad River and tributaries",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Dams, waterways, and watersheds</span>"
    ]
  },
  {
    "objectID": "dams-and-waterways.html#footnotes",
    "href": "dams-and-waterways.html#footnotes",
    "title": "9  Dams, waterways, and watersheds",
    "section": "",
    "text": "The exceptions are dams for tailings and other waste products like coal ash, which are designed not to allow the contents behind the dam to flow.↩︎",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Dams, waterways, and watersheds</span>"
    ]
  },
  {
    "objectID": "ruggedness.html",
    "href": "ruggedness.html",
    "title": "10  Terrain ruggedness",
    "section": "",
    "text": "10.1 Hypotheses related to dams and ruggedness\nAfter thinking about the question I asked in Section 6.4 Ratios and how I might answer it:\nI’ve thought of three more specific hypotheses I want to explore (\\(H_2\\) and \\(H_3\\) are variants addressing the original question).",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#hypotheses-related-to-dams-and-ruggedness",
    "href": "ruggedness.html#hypotheses-related-to-dams-and-ruggedness",
    "title": "10  Terrain ruggedness",
    "section": "",
    "text": "Dams built in hilly areas seem to me to be more likely to have low ratios of surfaceArea to nidStorage, i.e., the dams are likely to be deeper rather than broader. Can we substantiate or disprove this conjecture?\n\n\n\n10.1.1 Hypothesis 1\n\nLocal terrain ruggedness in the area around dams is greater than the ruggedness of areas around randomly sampled points in the continental US states.\n\nIn other words, for states:\n\\[tri\\_mean_{dam} \\gt tri\\_mean_{sample}\\] In addition to plots exploring distributions and relationships, I look at four regressions:\n\nmod.h1.1: lm(tri_mean_dam ~ tri_mean_sample)\n\n\nIf \\(H_1\\) is true, the regression term estimate for \\(tri\\_mean_{sample}\\) will be positive. this is a necessary but not sufficient condition for \\(H_1\\).\n\n\nmod.h1.2: lmer(tri_mean_dam ~ (1 | state))\n\n\nHow much variation in \\(tri\\_mean_{dam}\\) can be explained by state effects without consideration of \\(tri\\_mean_{sample}\\)? This provides a base from which to consider other models.\n\n\nmod.h1.3: lmer(tri_mean_sample ~ (1 | state))\n\n\nHow much variation in \\(tri\\_mean_{sample}\\) can be explained by state effects without consideration of \\(tri\\_mean_{dam}\\)? This provides a base from which to consider other models.\n\n\nmod.h1.4: lmer(tri_mean_dam ~ tri_mean_sample + (1 | state))\n\n\nI assume this model explains the more of the variance than the others.\n\n\n\n\n10.1.2 Hypothesis 2\n\nIn states with higher terrain ruggedness, dams’ \\(\\frac{surfaceArea}{nidStorage}\\) will be lower.\n\nWhere dams are in more rugged states, it seems likely dams’ lakes will be deeper and thus have smaller ratios \\(\\frac{surfaceArea}{nidStorage}\\). In other words, considering the states in the continental US, there is an inverse proportional relationship:\n\\[tri\\_mean_{sample} \\propto \\frac{1}{\\left(\\frac{surfaceArea}{nidStorage}\\right)}\\]\nIn addition to plots exploring distributions and relationships, I look at two regressions:\n\nlm(tri_mean_sample ~ ratio)\nlmer(tri_mean_sample ~ ratio + (1 | state))\n\nwhere \\(ratio = \\frac{surfaceArea}{nidStorage}\\).\n\n\n10.1.3 Hypothesis 3\n\nCompared to H2 there is a stronger inverse proportional relationship between ruggeness in the local areas around dams and surfaceArea::nidStorage\n\nIn \\(H_3\\) I restrict the locations to the local areas around dams. It’s likely there is a stronger inverse proportional relationship between \\(tri\\_mean_{dam}\\) and \\(\\frac{surfaceArea}{nidStorage}\\) for the same dam, since dams are built where the topography provides good places to hold water.1\nExpressed like \\(H_2\\) :\n\\[tri\\_mean_{dam} \\propto \\frac{1}{\\left(\\frac{surfaceArea}{nidStorage}\\right)}\\]\nIn addition to plots exploring distributions and relationships, I look at two regressions:\n\nlm(tri_mean_dam ~ ratio)\nlmer(tri_mean_dam ~ ratio + (1 | state))",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#methodology",
    "href": "ruggedness.html#methodology",
    "title": "10  Terrain ruggedness",
    "section": "10.2 Methodology",
    "text": "10.2 Methodology\n\n10.2.1 Key metric\nI calculate terrain ruggedness index (TRI) from digital elevation model (DEM) data I downloaded and saved in GeoTIFF files. The terra::terrain() function calculates TRI for me from the elevation data using eight-neighbor “classic” TRI per Wilson et al. (2007).2\nFrom the terra::terrain() help:\n\n“TRI (Terrain Ruggedness Index) is the mean of the absolute differences between the value of a cell and its 8 surrounding cells.”\n\nNote that TRI values are sensitive to the resolution of the digital elevation model, since differences in elevation differ significantly over various distances.\n\n\n10.2.2 Data sources\nI get elevation data from elevatr::get_elev_raster(), which returns Shuttle Radar Topography Mission (SRTM)3 data via Open Topography. The SRTM’s Digital Elevation Model (DEM) is a Digital Surface Model (DSM) rather than a Digital Terrain Model (DTM). In other words, the radar reflections used to calculate elevations in some cases are from the tops of buildings and partway through the tree canopy; elevation values have not been adjusted to estimate ground level.4 For my purposes, and because I have so many points to work with, this noise is not an issue.\nThe SRTM digital elevation model (DEM) has a range over continental North America south of 60° N latitude. This range is fine, since the northernmost point in the continental USA is the Northwest Angle Inlet in Lake of the Woods, MN at 49.4°).5\nI use zoom level 9 (elevatr::get_elev_raster(z = 9)), which provides data at the resolution of about 125 m per point in North Carolina and greater distances between points in lower latitudes. For more information see Section 11.1.4.1 Resolution of elevation data varies by latitude.\nFor state boundaries, I use USAboundaries::us_states()\nFor drawing the Blue Ridge Parkway in North Carolina, I use shapes from OpenStreetMap, which I acquire via the osmdata package.\n\n\n10.2.3 Data prep\n\nDam data: Using data the from the National Inventory of Dams, I prepare a data set with 86351 dams that include nidHeightId (and thus nidHeight) along with state abbreviation (state_abb) and \\((longitude, latitude)\\) location.\nState boundaries, etc.: I use USAboundaries::us_states() to get state boundaries and use osmdata::opq() to download OpenStreetMap shapes for the Blue Ridge Parkway in North Carolina.\nState-level elevation data: Using state boundaries, I downloaded DEM and saved them as GeoTIFF files for use in the following steps.\nLocal terrain ruggedness around dams: I define a circle of radius r = 5 km around each dam location, get the elevations for every point in the circle, and calculate the TRI for the points. Then I create summary statistics for each dam’s circle (tri_mean_dam, tri_median_dam, tri_sd_dam, tri_n_dam points).\nLocal terrain ruggedness around random points: The number of dams vary by state. So for each state, I randomly sample the same number of points as there are dams in that state, define circles of radius r = 5 km, get the elevations for every point in the circle, and calculate the TRI for the points. Then I create summary statistics for each sample’s circle (tri_mean_sample, tri_median_sample, tri_sd_sample, tri_n_sample points).\n\nFor more information about data preparation, questions I asked, and trade-offs I made along the way, see Chapter 11 Preparing terrain ruggedness.\n\n\n10.2.4 Exploration\nTo explore \\(H_1:\\) in Section 10.3:\n\nI plot the distribution of \\(tri\\_mean_{dam}\\) and \\(tri\\_mean_{sample}\\) by state_abb, state_region, and nidHeightId.\nI sort the dam and state samples in order of \\(tri\\_mean_{dam}\\) and \\(tri\\_mean_{sample}\\) respectively, and I pair them in linear regressions with various models to check which models explain the most variance. I plot some of the model parameter (a.k.a. term) estimates.\n\nTo explore \\(H_2:\\)in Section 10.4:\n\nI plot the distributions of \\(surfaceArea\\), \\(nidStorage\\), and \\(\\frac{surfaceArea}{nidStorage}\\) aggregated by state_abb and nidHeigthId.\nI sort the dam and state samples in order of \\(tri\\_mean_{dam}\\) and \\(tri\\_mean_{sample}\\) respectively, and I pair them in linear regressions predicting \\(tri\\_mean_{sample}\\) using various models to check which models explain the most variance.\n\nTo explore \\(H_3:\\)in Section 10.5:\n\nI plot the distributions of \\(surfaceArea\\), \\(nidStorage\\), and \\(\\frac{surfaceArea}{nidStorage}\\) aggregated by state_abb and nidHeigthId.\nI use the same data set as in \\(H_2\\) and run linear regressions predicting \\(tri\\_mean_{dam}\\) using various models to check which models explain the most variance.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#sec-h1-explore",
    "href": "ruggedness.html#sec-h1-explore",
    "title": "10  Terrain ruggedness",
    "section": "10.3 Exploring H1 : Local terrain ruggedness in the area around dams is greater than the ruggedness of areas around randomly sampled points in the contentinental US states",
    "text": "10.3 Exploring H1 : Local terrain ruggedness in the area around dams is greater than the ruggedness of areas around randomly sampled points in the contentinental US states\nThe area around a dam has greater terrain ruggedness than its paired state sample if\n\\[tri\\_mean_{dam} - tri\\_mean_{sample} &gt; 0\\]\nWhen the differences in \\(tri\\_mean_{dam}\\) and \\(tri\\_mean_{sample}\\) are aggregated by state, region, or other property, their distributions and differences in distribution medians allow us to make some generalizations:\n\\[{median(tri\\_mean_{dam} - tri\\_mean_{sample})} &gt; 0\\]\nfor some aggregation.\n\n10.3.1 First: dam and sample distributions\nOf note re: Figure 10.1:\n\nThere is a lot of variation in the distributions and median tri_means of \\(tri\\_mean_{dam}\\) and \\(tri\\_mean_{sample}\\) by state. And I didn’t expect West Virginia to have the highest median \\(tri\\_mean_{sample}\\).\nWhile there are states that have high median \\(tri\\_mean_{dam}\\) for the local areas around some dams, there is no concentration in the distributions at these higher values. Ruggedness varies a lot more than flatness.\nThere is wide variation in number of points in each state, proportional to the number of dams in the state. DE has the fewest points: 471,661, which is more than enough for my purposes.\n\n\n\nShow the code\ndta_for_plot &lt;- state_dam_tri_summary_df |&gt;\n  mutate(state_mean_dam = weighted.mean(tri_mean_dam, w = tri_n_dam),\n         state_median_dam = median(tri_mean_dam),\n         .by = c(state_abb, state_region, region_label)) |&gt;\n  mutate(state_abb = fct_reorder(state_abb, state_median_dam))\n\np1_dam_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(tri_mean_dam, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = state_dam_tri_summary_df |&gt;\n      mutate(\n        state_mean_dam = weighted.mean(tri_mean_dam, w = tri_n_dam),\n        state_median_dam = median(tri_mean_dam),\n        .by = state_abb\n      ) |&gt;\n      distinct(state_abb, state_median_dam),\n    aes(state_median_dam, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.75, 0.2)) +\n  coord_cartesian(xlim = c(0, 28)) +\n  labs(\n    subtitle = \"A. Distribution of tri_mean&lt;sub&gt;dam&lt;/sub&gt;&lt;br&gt;\",\n    y = NULL\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_col(\n    aes(tri_n_dam, state_abb, fill = region_label),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  labs(\n    subtitle = \"B. Number of TRI values&lt;br&gt;\",\n    y = NULL\n  )\n\np1_dam_state + p2 +\n  plot_annotation(\n    title = \"Distribution of *tri_mean&lt;sub&gt;dam&lt;/sub&gt;* for local areas around dams\",\n    subtitle = \"Red indicator is median tri_mean&lt;sub&gt;dam&lt;/sub&gt;&lt;br&gt;\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.1: Distributions of tri_meandam in areas around dams in each state\n\n\n\n\n\n\nOf note re: Figure 10.2\n\nThe Northeast and West regions have the highest median \\(tri\\_mean_{dam}\\) (panel A).\nThe median \\(tri\\_mean_{dam}\\) is higher for every higher category of nidHeightId (panel B).\n\n\n\nShow the code\ndta_for_plot &lt;- state_dam_tri_summary_df |&gt;\n  mutate(region_mean_dam = weighted.mean(tri_mean_dam, w = tri_n_dam),\n         region_median_dam = median(tri_mean_dam),\n         .by = c(region_label))\n\ndta_for_plot_p1_region_medians &lt;- dta_for_plot |&gt;\n  distinct(region_label, .keep_all = TRUE)\n\np1_dam_region &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_mean_dam, fill = region_label),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot_p1_region_medians,\n    aes(region_median_dam, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  geom_text(\n    data = dta_for_plot_p1_region_medians,\n    aes(x= I(0.7), y = I(0.8), \n        label = glue(\"Median: {round(region_median_dam, digits = 1)}\")\n        )\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  facet_wrap(~region_label, ncol = 1) +\n  coord_cartesian(xlim = c(0, 55)) +\n  labs(\n    subtitle = \"A. Distribution of tri_mean&lt;sub&gt;dam&lt;/sub&gt;\\nby region&lt;br&gt;\",\n    y = NULL\n  )\n\ndta_for_plot_p2 &lt;- dams_with_tri |&gt;\n  st_drop_geometry() |&gt;\n  filter(nidHeightId != \"Undetermined\") |&gt;\n  select(nidId, state_abb, nidHeight, nidHeightId, starts_with(\"tri\")) |&gt;\n  mutate(nidHeightId_tri_mean_dam = weighted.mean(tri_mean_dam, w = tri_n_dam),\n         nidHeightId_tri_median_dam = median(tri_mean_dam),\n         .by = nidHeightId)\n\ndta_for_plot_p2_nidHeightId_medians &lt;- dta_for_plot_p2 |&gt;\n  distinct(nidHeightId, .keep_all = TRUE)\n\np2_dam_nidHeightId &lt;- dta_for_plot_p2 |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_mean_dam),\n    linewidth = 0.1,\n    fill = \"grey80\",\n    color = NA,\n  ) +\n  geom_text(\n    data = dta_for_plot_p2_nidHeightId_medians,\n    aes(nidHeightId_tri_median_dam, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  geom_text(\n    data = dta_for_plot_p2_nidHeightId_medians,\n    aes(x= I(0.7), y = I(0.8), \n        label = glue(\"Median: {round(nidHeightId_tri_median_dam, digits = 1)}\")\n        )\n  ) +\n  facet_wrap(~nidHeightId, ncol = 1) +\n  coord_cartesian(xlim = c(0, 55)) +\n  labs(\n    subtitle = \"B. Distribution of tri_mean&lt;sub&gt;dam&lt;/sub&gt;\\nby nidHeightId&lt;br&gt;\",\n    y = NULL\n  )\n\np1_dam_region + p2_dam_nidHeightId +\n  plot_annotation(\n    title = \"Distribution of *tri_mean&lt;sub&gt;dam&lt;/sub&gt;* for local areas around dams\",\n    subtitle = \"Red indicator is median tri_mean&lt;sub&gt;dam&lt;/sub&gt;&lt;br&gt;\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.2: Distribution of tri_meandam of areas around dams by nidHeightId and region\n\n\n\n\n\n\nOf note re: Figure 10.3:\n\nStates with large flat areas as well as mountains have a distribution with a mode in low TRI values and a long tail. See for example, CO, NC, OH, TX (panel A).\n\n\n\nShow the code\ndta_for_plot &lt;- state_samples_tri_summary_df |&gt;\n  mutate(state_mean_sample = weighted.mean(tri_mean_sample, w = tri_n_sample),\n         state_median_sample = median(tri_mean_sample),\n         .by = state_abb) |&gt;\n  mutate(state_abb = fct_reorder(state_abb, state_median_sample))\n  \ndta_for_plot2 &lt;- dta_for_plot |&gt;\n  mutate(region_mean_sample = weighted.mean(tri_mean_sample, w = tri_n_sample),\n         region_median_sample = median(tri_mean_sample),\n         .by = region_label) #|&gt;\n  # FYI: need to adjust factors to match regions in panel A if I use the fct_reorder() line below\n  # mutate(region_label = fct_reorder(region_label, region_mean)) \n\ndta_for_plot2_region_medians &lt;- dta_for_plot2 |&gt;\n  distinct(region_median_sample, .keep_all = TRUE)\n\np1_sample_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(tri_mean_sample, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = state_samples_tri_summary_df |&gt;\n      mutate(\n        state_mean_sample = weighted.mean(tri_mean_sample, w = tri_n_sample),\n        state_median_sample = median(tri_mean_sample),\n        .by = state_abb\n      ) |&gt;\n      distinct(state_abb, state_median_sample),\n    aes(state_median_sample, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_x_continuous(breaks = 0:10 * 5) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.75, 0.15)) +\n  coord_cartesian(xlim = c(0, 30)) +\n  labs(\n    subtitle = \"A. Distribution of tri_mean&lt;sub&gt;sample&lt;/sub&gt;&lt;br&gt;\",\n    y = NULL\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_col(\n    aes(tri_n_sample, state_abb, fill = region_label),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  labs(\n    subtitle = \"B. Number of TRI values&lt;br&gt;\",\n    y = NULL\n  )\n\np1_sample_state + p2 +\n  plot_annotation(\n    title = \"Distribution of *tri_mean&lt;sub&gt;sample&lt;/sub&gt;* for local area&lt;br&gt;around sampled points in each state\",\n    subtitle = \"Red indicator is median tri_mean&lt;sub&gt;sample&lt;/sub&gt;&lt;br&gt;\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.3: Distribution of tri_meansample for areas around randomly sampled points in each state\n\n\n\n\n\n\nOf note re: fig-state-local-area-tri-summary-density-non-state:\n\nSimilar to Figure 10.2, there is more variation in \\(tri\\_mean_{sample}\\) in the Northeast and West, which have higher median \\(tri\\_mean_{sample}\\) than the North Central and South regions (panel A).\nNorth Central looks by eye to be the region with a distribution of \\(tri\\_mean_{sample}\\) closest to the overall distribution (panel B), however Northeast region has the closest median \\(tri\\_mean_{sample}\\).\n\n\n\nShow the code\ndta_for_plot &lt;- state_samples_tri_summary_df |&gt;\n  mutate(region_mean_sample = weighted.mean(tri_mean_sample, w = tri_n_sample),\n         region_median_sample = median(tri_mean_sample),\n         .by = c(region_label))\n\ndta_for_plot_p1_region_medians &lt;- dta_for_plot |&gt;\n  distinct(region_label, .keep_all = TRUE)\n\np1_sample_region &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_median_sample, fill = region_label),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot_p1_region_medians,\n    aes(region_mean_sample, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  geom_text(\n    data = dta_for_plot_p1_region_medians,\n    aes(x= I(0.7), y = I(0.8), \n        label = glue(\"Median: {round(region_median_sample, digits = 1)}\")\n        )\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  facet_wrap(~region_label, ncol = 1) +\n  coord_cartesian(xlim = c(0, 55)) +\n  labs(\n    subtitle = \"A. Distribution of tri_mean&lt;sub&gt;sample&lt;/sub&gt; by region&lt;br&gt;\",\n    y = NULL\n  )\n\ndta_for_plot_p1_overall_median &lt;- dta_for_plot |&gt;\n  summarize(overall_tri_median_sample = mean(tri_mean_sample))\n\np2_sample_overall &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_mean_sample),\n    linewidth = 0.1,\n    fill = \"grey80\",\n    color = NA,\n    # alpha = 0.3\n  ) +\n  geom_text(\n    data = dta_for_plot_p1_overall_median,\n    aes(overall_tri_median_sample, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  geom_text(\n    data = dta_for_plot_p1_overall_median,\n    aes(x= I(0.7), y = I(0.8), \n        label = glue(\"Median: {round(overall_tri_median_sample, digits = 1)}\")\n        )\n  ) +\n  # facet_wrap(~nidHeightId, ncol = 1) +\n  coord_cartesian(xlim = c(0, 55)) +\n  labs(\n    subtitle = \"B. Distribution of tri_mean&lt;sub&gt;sample&lt;/sub&gt;&lt;br&gt;\",\n    y = NULL\n  )\n\np1_sample_region + p2_sample_overall +\n  plot_annotation(\n    title = \"Distribution of *tri_mean&lt;sub&gt;sample&lt;/sub&gt;* for local areas around random points\",\n    subtitle = \"Red indicator is median tri_mean&lt;sub&gt;sample&lt;/sub&gt;&lt;br&gt;\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.4: Distribution of tri_meansample for areas around randomly sampled points in each state\n\n\n\n\n\n\n\n\n10.3.2 Second: difference in tri_meandam - tri_meansample\n\n\nShow the code\ntri_dam_tmp &lt;- dams_with_tri |&gt;\n      st_drop_geometry() |&gt;\n      select(nidId, state_abb, nidHeight, nidHeightId, nidStorage, surfaceArea, starts_with(\"tri_\")) |&gt;\n  arrange(state_abb, tri_mean_dam)\n\nn_tri_dam_tmp &lt;- tri_dam_tmp |&gt;\n  count(state_abb, name = \"n_dams\")\n\ntri_sample_tmp &lt;- state_samples_tri_summary_df\n\ncheck_n &lt;- left_join(\n  dams_with_tri |&gt;\n    st_drop_geometry() |&gt;\n    count(state_abb, name = \"n_dam\"),\n  state_dam_tri_summary_df |&gt;\n    count(state_abb, name = \"n_sample\"),\n  by = \"state_abb\"\n) |&gt;\n  mutate(\n    n_diff = n_sample - n_dam\n  )\n\n# Need n_diff to be zero for all states to pair tri_mean_dam and tri_mean_sample in dta_for_model\n\nif(sum(check_n$n_diff) != 0) {\n  # We have some work to do\n  \n  tri_sample_tmp2 &lt;- tri_sample_tmp |&gt;\n    left_join(check_n,\n              by = \"state_abb\")\n  \n  if(any(check_n$n_diff) &lt; 0) {\n    stop(\"Code block define-tri-diff-model-data: at least one state has fewer rows of sample points than dams. Fix this manually.\")\n  } \n  \n  tri_sample_tmp3 &lt;- tri_sample_tmp2 |&gt;\n    mutate(\n      test_n_sample = n_sample - n_diff,\n      test_tri_mean_sample = if_else(row_number() &lt;= n_diff,\n                              NA_real_,\n                              tri_mean_sample),\n      .by = state_abb\n    ) |&gt;\n    filter(!is.na(test_tri_mean_sample)) |&gt;\n    mutate(#test_tri_n_sample = test_tri_mean_sample,\n           n_diff2 = test_n_sample - n_dam\n    ) |&gt;\n    select(-starts_with(\"test\")) |&gt;\n    # TODO: solve the following kludge at source and remove this filter\n    filter(!(state_abb == \"TX\" & row_number() &lt;=3) &\n             !(state_abb == \"VT\" & row_number() == 1) &\n             !(state_abb == \"WV\" & row_number() == 1),\n           .by = state_abb)\n  \n  n_tri_sample_tmp3 &lt;- tri_sample_tmp3 |&gt;\n    count(state_abb, name = \"tri_sample_n2\")\n  \n  tri_check_tmp &lt;- \n    inner_join(\n      n_tri_sample_tmp3,\n      n_tri_dam_tmp,\n      by = join_by(state_abb)\n    ) |&gt;\n    mutate(dif = tri_sample_n2 - n_dams) |&gt;\n    arrange(desc(dif))\n  \n  state_abb_levels &lt;- tri_dam_tmp |&gt;\n    mutate(mean_tri_mean_dam = mean(tri_mean_dam),\n           .by = state_abb\n    ) |&gt;\n    arrange(mean_tri_mean_dam) |&gt;\n    distinct(state_abb, mean_tri_mean_dam) |&gt;\n    mutate(state_abb = as_factor(state_abb)) # keeps current order\n  \n} else {\n  # no adjustments needed\n  \n  state_tri_tmp3 &lt;- tri_dam_tmp #\n  \n}\n\ndta_for_model &lt;- \n  bind_cols(\n    tri_sample_tmp3 |&gt;\n      group_by(state_abb) |&gt;\n      arrange(tri_mean_sample,\n              .by_group = TRUE) |&gt;\n      ungroup(),\n    tri_dam_tmp |&gt;\n      group_by(state_abb) |&gt;\n      arrange(tri_mean_dam,\n              .by_group = TRUE) |&gt;\n      ungroup() |&gt;\n      select(-state_abb) # already in state_tri_tmp\n  ) |&gt;\n  mutate(tri_diff_dam_sample = tri_mean_dam - tri_mean_sample,\n         area_to_volume_dam = surfaceArea / nidStorage,\n         state_abb = factor(state_abb, levels = state_abb_levels$state_abb)\n         ) |&gt;\n  filter(nidId != \"NM00039\", # surfaceArea seems to be an error (or very major outlier)\n         nidId != \"MI00650\") # Lake Superior adjustments as noted in an earlier chapter\n\nn_dams_by_nidHeightId &lt;- dta_for_model |&gt;\n  count(nidHeightId) |&gt;\n  mutate(\n    supports_h1 = nidHeightId %in% c(\"Less than 25 feet\", \"25-50 feet\")\n  )\n\nn_dams_support_h1 &lt;- sum(n_dams_by_nidHeightId[n_dams_by_nidHeightId$supports_h1, ]$n)\npct_dams_support_h1 &lt;- n_dams_support_h1 / sum(n_dams_by_nidHeightId$n)\n\nstates_support_h1 &lt;- dta_for_model |&gt;\n  mutate(\n    supports_h1 = tri_mean_dam &gt; tri_mean_sample \n  ) |&gt;\n  reframe(\n    n_dams_state = n(),\n    n_dams_state_support_h1 = sum(supports_h1),\n    .by = state_abb\n  ) |&gt;\n  mutate(\n    pct_dams_in_state_support_h1 = n_dams_state_support_h1 / n_dams_state\n  )\n\nn_states_support_h1 &lt;- states_support_h1 |&gt;\n  filter(pct_dams_in_state_support_h1 &gt; 0.5) |&gt;\n  nrow()\n\n\nOf note re: Figure 10.5 and related data:\nAggregations in which \\(median({tri\\_mean_{dam} - tri\\_mean_{sample}}) &gt; 0\\) have a higher terrain ruggedness than the state in general. The panels in Figure 10.5 reveal the following:\n\nPanel A: there is a lot of variation in the distributions by state.\n\n30 of 48 states (62%) have positive \\({median(tri\\_mean_{dam} - tri\\_mean_{sample})} &gt; 0\\), supporting \\(H_1\\).\nin flatter states \\(H_1\\) holds true. In mountainous states it does not.\n\nPanel B: the median for all dams and samples is slightly positive, supporting \\(H_1\\).\nPanel C: North Central and South regions have a (mildly) positive median. These, the flattest regions, support \\(H_1\\).\nPanel D:nidHeightId categories &lt; 50 ft have positive means, which includes most dams\n\n79305 of 85854 (92%) support \\(H_1\\).\n\n\n\n\nShow the code\ndata_for_plot &lt;- dta_for_model |&gt;\n  mutate(state_abb = fct_reorder(state_abb, tri_diff_dam_sample))\n\np1_medians &lt;- data_for_plot |&gt;\n  summarize(state_median = median(tri_diff_dam_sample),\n         .by = state_abb)\n\np1_diff_dam_sample &lt;- data_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(tri_diff_dam_sample, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    quantile_lines = TRUE,\n    quantiles = 2,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_vline(\n    xintercept = 0,\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5) +\n  geom_text(\n    data = p1_medians,\n    aes(state_median, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.25, 0.85)) +\n  coord_cartesian(xlim = c(-13, 6)) +\n  labs(\n    subtitle = \"A. By state\",\n    y = NULL,\n    fill = \"Region (n=states)\"\n  )\n\np2_median &lt;- data_for_plot |&gt;\n  summarize(state_median = median(tri_diff_dam_sample))\n\np2_diff_all &lt;- data_for_plot |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_diff_dam_sample),\n    linewidth = 0.1,\n    color = \"grey80\",\n    fill = \"grey80\",\n    # alpha = 0.5\n  ) +\n  geom_vline(\n    xintercept = 0,\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5) +\n  geom_text(\n    data = p2_median,\n    aes(state_median, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  annotate(\"text\", x= I(0.3), y = I(0.8), label = glue(\"Median: {round(p2_median$state_median, digits = 2)}\")) +\n  labs(\n    subtitle = \"B. All in one\"\n  )\n\np3_medians &lt;- data_for_plot |&gt;\n  summarize(median_tri_diff_dam_state = median(tri_diff_dam_sample),\n            .by = region_label)\n\np3_diff_region &lt;- data_for_plot |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_diff_dam_sample, fill = region_label),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_vline(\n    xintercept = 0,\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5) +\n  geom_text(\n    data = p3_medians,\n    aes(median_tri_diff_dam_state, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  geom_text(\n    data = p3_medians,\n    aes(x= I(0.3), y = I(0.8), \n        label = glue(\"Median: {round(median_tri_diff_dam_state, digits = 1)}\")\n        )\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  facet_wrap(~region_label, ncol = 2) +\n  labs(\n    subtitle = \"C. By region\",\n    y = NULL\n  )\n\np4_medians &lt;- data_for_plot |&gt;\n  summarize(median_tri_diff_dam_state = median(tri_diff_dam_sample),\n            .by = nidHeightId)\n\np4_diff_nidHeightId &lt;- data_for_plot |&gt;\n  ggplot() +\n  geom_density(\n    aes(tri_diff_dam_sample, fill = nidHeightId),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_vline(\n    xintercept = 0,\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5) +\n  geom_text(\n    data = p4_medians,\n    aes(median_tri_diff_dam_state, 0, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  geom_text(\n    data = p4_medians,\n    aes(x= I(0.3), y = I(0.8), \n        label = glue(\"Median: {round(median_tri_diff_dam_state, digits = 2)}\")\n        )\n  ) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  facet_wrap(~nidHeightId, ncol = 2) +\n  labs(\n    subtitle = \"D. By nidHeightId\",\n    y = NULL\n  )\n\np1_diff_dam_sample + (p2_diff_all / p3_diff_region / p4_diff_nidHeightId) +\n  plot_annotation(\n    title = \"Distributions of *tri_mean&lt;sub&gt;dam&lt;/sub&gt; - tri_mean&lt;sub&gt;sample&lt;/sub&gt;*&lt;br&gt;\",\n    subtitle = glue(\"TRI means calculated from 5 km circles around each of {n_dams} dams\",\n                    \" and same number of random samples in each state.\",\n                    \"\\nRed indicators are median(tri_mean&lt;sub&gt;dam&lt;/sub&gt; - tri_mean&lt;sub&gt;sample&lt;/sub&gt;)&lt;br&gt;\"),\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.5: Distribution of dam tri_meandam and tri_meanstate sample by state\n\n\n\n\n\n\nOf note re: fig-three-tri-mean-distributions-by-date:\n\nThis plot of distributions is a recap of earlier plots. I place them next to each other for easy comparison.\nWhere the distribution of \\(tri\\_mean_{dam}\\) (panel A) differs from \\(tri\\_mean_{sample}\\) (panel B), it tells us the ruggedness around dams is not representative of the state. For example, Colorado doesn’t seem to have many dams in the flat, eastern part of the state–or the dams in the eastern part are in relatively rare hilly areas. I also note that more distributions in panel B seem to have long tails of high \\(tri\\_mean_{sample}\\) values.\nPanel C is ordered by the size of the difference \\(tri\\_mean_{dam} - tri\\_mean_{sample}\\) for each state (a different ordering than panel A or B). States with a positive difference support \\(H_1\\); those near zero or negative challenge it.\n\n\n\nShow the code\n(p1_dam_state + \n   labs(subtitle = \"A. Distribution of tri_mean_dam\")) + \n  (p1_sample_state + \n     labs(subtitle = \"B. Distribution of tri_mean_sample\")) + \n  (p1_diff_dam_sample + \n     labs(subtitle = \"C. Distribution of tri_diff_dam_sample\")) +\n  plot_annotation(\n    title = \"tri_mean distributions\",\n    subtitle = glue(\"Red indicator is median tri_mean for each variable. Ordered by descending median.\",\n                    \"\\nNote that each subplot orders the states differently.\"),\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple()) &\n  guides(fill = \"none\")\n\n\n\n\n\n\n\n\nFigure 10.6: Distribution of TRI means in each state\n\n\n\n\n\n\nOf note re: Figure 10.7:\n\nPlots in panels A1 and B1 appear to show that \\(tri\\_mean_{sample}\\) exceeds \\(tri\\_mean_{dam}\\) in most cases, which would disprove \\(H_1\\).\nHowever, panels A1 and B1 hide most of the data, which have low \\(tri\\_mean\\) values. The log-log plots in panels A2 and B2 show that in most cases, \\(tri\\_mean_{dam}\\) exceeds \\(tri\\_mean_{sample}\\).\nIn other words, in flatter areas \\(H_1\\) holds true. In mountainous areas it does not.\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(tri_mean_dam &gt; 0,\n         tri_mean_sample &gt; 0) |&gt;\n  ggplot(aes(tri_mean_dam, tri_mean_sample, color = state_abb, group = state_abb)) +\n  geom_line(\n    linewidth = 0.25,\n    alpha = 0.8\n  ) +\n  geom_abline(\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5\n  ) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA),\n                  ylim = c(0.01, NA)) +\n  labs(\n    subtitle = \"A1. Line plot\",\n    x = \"tri_mean_dam\",\n    y = \"tri_mean_sample\"\n  )\n\np1_log_log &lt;- dta_for_model |&gt;\n  filter(tri_mean_dam &gt; 0,\n         tri_mean_sample &gt; 0) |&gt;\n  ggplot(aes(tri_mean_dam, tri_mean_sample, color = state_abb, group = state_abb)) +\n  geom_line(\n    linewidth = 0.25,\n    alpha = 0.8\n  ) +\n  geom_abline(\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5\n  ) +\n  scale_x_log10() +\n  scale_y_log10() +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA),\n                  ylim = c(0.01, NA)) +\n  labs(\n    subtitle = \"A2. Line plot (log10 scales)\",\n    x = \"tri_mean_dam (log10 scale)\",\n    y = \"tri_mean_sample (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(tri_mean_dam &gt; 0,\n         tri_mean_sample &gt; 0) |&gt;\n  ggplot(aes(tri_mean_dam, tri_mean_sample, \n             color = state_abb, group = state_abb)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.2,\n    alpha = 0.8,\n    se = FALSE) +\n  geom_abline(\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5\n  ) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA),\n                  ylim = c(0.01, NA)) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"B1. Regression line plot (same data)\",\n    x = \"tri_mean_dam\",\n    y = \"tri_mean_sample\"\n  )\n\np2_log_log &lt;- dta_for_model |&gt;\n  filter(tri_mean_dam &gt; 0,\n         tri_mean_sample &gt; 0) |&gt;\n  ggplot(aes(tri_mean_dam, tri_mean_sample, \n             color = state_abb, group = state_abb)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.2,\n    alpha = 0.8,\n    se = FALSE) +\n  geom_abline(\n    lty = 2,\n    linewidth = 0.25,\n    alpha = 0.5\n  ) +\n  scale_x_log10() +\n  scale_y_log10() +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA),\n                  ylim = c(0.01, NA)) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"B2. Regression line plot (log10 scales)\",\n    x = \"tri_mean_dam (log10 scale)\",\n    y = \"tri_mean_sample (log10 scale)\"\n  )\n\np1 + p1_log_log + p2 + p2_log_log +\n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;sample&lt;/sub&gt; by tri_mean&lt;sub&gt;dam&lt;/sub&gt; for each state\",\n    subtitle = \"In most states, tri_mean&lt;sub&gt;sample&lt;/sub&gt; is larger than tri_mean&lt;sub&gt;dam&lt;/sub&gt;, disproving H1&lt;br&gt;\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.7: Distribution of TRI means in each state\n\n\n\n\n\n\n\n\n10.3.3 Regression models\nI ordered \\(tri\\_mean_{dam}\\) and \\(tri\\_mean_{sample}\\) from smallest to largest in each state before combining them in dta_for_model. The data set includes 85,854 pairs in 48 states. DE has the least dams: 83. TX has the most dams: 7276.\nThus, when model mod.h1.1 \\(tri\\_mean_{dam} \\sim \\beta_1 tri\\_mean_{sample} + \\epsilon\\) has \\(\\beta_1 &gt; 1.0\\) , it would that \\(tri\\_mean_{dam}\\) in general is larger than \\(tri\\_mean_{sample}\\) , which would consistent with the conclusions from Figure 10.5 in the prior section in supporting \\(H_1\\).\n\n10.3.3.1 Model mod.h1.1\nmod.h1.1 explains most of the variation: \\(R^2 = 0.87\\).\n\n\nShow the code\nmod.h1.1 &lt;- dta_for_model |&gt;\n  lm(tri_mean_dam ~ tri_mean_sample,\n     data = _)\n\nsummary(mod.h1.1)\n\n\n\nCall:\nlm(formula = tri_mean_dam ~ tri_mean_sample, data = dta_for_model)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-12.3141  -0.4044  -0.1503   0.4948  20.5014 \n\nCoefficients:\n                 Estimate Std. Error t value Pr(&gt;|t|)    \n(Intercept)     1.2566466  0.0071688   175.3   &lt;2e-16 ***\ntri_mean_sample 0.6809898  0.0008868   768.0   &lt;2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.641 on 85852 degrees of freedom\nMultiple R-squared:  0.8729,    Adjusted R-squared:  0.8729 \nF-statistic: 5.898e+05 on 1 and 85852 DF,  p-value: &lt; 2.2e-16\n\n\n\n\\(\\beta_1\\) in \\(\\beta_1 tri\\_mean_{dam}\\) is 0.68, meaning \\(tri\\_mean_{dam}\\) is on average 68% the size of \\(tri\\_mean_{sample}\\), apparently disproving \\(H_1\\).\nNote there is an implicit \\(\\left\\{\\beta_1,..\\beta_n\\right\\}\\) before each term \\(\\left\\{term_1,..term_n\\right\\}\\) in the regression formulas (and \\(+ \\epsilon\\)) at the end. For the sake of brevity and readability, I omit them from the formulas in the remainder of this chapter.\n\n\n\n10.3.3.2 Model mod.h1.2\nmod.h1.2 explains more than a third of the variance using only state means: \\(R^2 = 0.43\\). This is a base model useful when considering the variance explained by other models.\n\\[mod.h1.2: tri\\_mean_{dam} \\sim 1 | state\\]\n\n\nShow the code\nmod.h1.2 &lt;- dta_for_model |&gt;\n  mutate(#tri_mean_sample_scaled = scale(tri_mean_sample),\n         tri_mean_dam_scaled = scale(tri_mean_dam)\n         ) |&gt;\n  lmer(tri_mean_dam_scaled ~ 1 | state_abb,\n     data = _)\n\nsummary(mod.h1.2)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_dam_scaled ~ 1 | state_abb\n   Data: mutate(dta_for_model, tri_mean_dam_scaled = scale(tri_mean_dam))\n\nREML criterion at convergence: 207681.1\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.5983 -0.4175 -0.1013  0.2144 14.4448 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 0.5590   0.7477  \n Residual              0.6552   0.8095  \nNumber of obs: 85854, groups:  state_abb, 48\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept)   0.2026     0.1080   1.876\n\n\nShow the code\nr_squared &lt;- rsq(mod.h1.2)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 3)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 3)}\", \n     \" and random effects: {round(r_squared$random, digits = 3)}\"\n  )\n\n\n\nFor this model, which includes only intercepts for each state: r_squared: 0.395 consisting of fixed effects: -0.041 and random effects: 0.436.\n\n\n\n10.3.3.3 Model mod.h1.3\nmod.h1.3 explains more than a third of the variance using only state means: \\(R^2 = 0.39\\). This is a base model useful when considering the variance explained by other models.\n\\[mod.h1.3: tri\\_mean_{sample} \\sim 1 | state\\]\n\n\nShow the code\nmod.h1.3 &lt;- dta_for_model |&gt;\n  mutate(tri_mean_sample_scaled = scale(tri_mean_sample),\n         # tri_mean_dam_scaled = scale(tri_mean_dam)\n         ) |&gt;\n  lmer(tri_mean_sample_scaled ~ 1 | state_abb,\n     data = _)\n\nsummary(mod.h1.3)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_sample_scaled ~ 1 | state_abb\n   Data: \nmutate(dta_for_model, tri_mean_sample_scaled = scale(tri_mean_sample),      )\n\nREML criterion at convergence: 208106\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.4398 -0.3894 -0.1136  0.2037 10.8430 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 0.5491   0.7410  \n Residual              0.6585   0.8115  \nNumber of obs: 85854, groups:  state_abb, 48\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept)   0.1903     0.1070   1.778\n\n\nShow the code\nr_squared &lt;- rsq(mod.h1.3)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 3)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 3)}\", \n     \" and random effects: {round(r_squared$random, digits = 3)}\"\n  )\n\n\n\nFor this model, which includes only intercepts for each state: r_squared: 0.392 consisting of fixed effects: -0.036 and random effects: 0.429.\n\n\nShow the code\nas.data.frame(ranef(mod.h1.3, condVar = FALSE)) |&gt;\n  rename(state_abb = grp) |&gt;\n  select(-grpvar) |&gt;\n  left_join(\n    states_and_regions,\n    by = join_by(state_abb)\n  ) |&gt;\n  mutate(state_abb = fct_reorder(state_abb, condval)) |&gt;\n  ggplot(aes(condval, state_abb, fill = region_label)) +\n  geom_col() +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.75, 0.2)) +\n  labs(\n    title = \"mod.h1.3 random effect\\nconditional means indicate\\nrelative level of mean ruggedness\",\n    subtitle = \"West Virginia has the highest tri_mean, and Delaware has the lowest.\",\n    x = \"Conditional mean\",\n    y = NULL,\n    caption = my_caption_nid_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 10.8: mod.h1.3 random effect condidtional means\n\n\n\n\n\n\n\n\n10.3.3.4 Model mod.h1.4\nBetter is a linear mixed model adjusting for states. mod.h1.3 explains even more of the variation: \\(R^2 = 0.95\\).\n\\[mod.h1.4: tri\\_mean_{dam} \\sim tri\\_mean_{sample} | state\\]\n\n\nShow the code\nmod.h1.4 &lt;- dta_for_model |&gt; # dams_with_tri |&gt;\n  mutate(tri_mean_dam_scaled = scale(tri_mean_dam), \n         tri_mean_sample_scaled = scale(tri_mean_sample))|&gt;\n  lmer(tri_mean_dam_scaled ~ tri_mean_sample_scaled + state_abb + (1 | state_abb),\n       data = _)\n\nsummary(mod.h1.4)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_dam_scaled ~ tri_mean_sample_scaled + state_abb + (1 |  \n    state_abb)\n   Data: mutate(dta_for_model, tri_mean_dam_scaled = scale(tri_mean_dam),  \n    tri_mean_sample_scaled = scale(tri_mean_sample))\n\nREML criterion at convergence: 13306.1\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-7.5624 -0.2065  0.0302  0.1899 19.8787 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 0.08446  0.2906  \n Residual              0.06809  0.2609  \nNumber of obs: 85854, groups:  state_abb, 48\n\nFixed effects:\n                        Estimate Std. Error t value\n(Intercept)            -0.130513   0.292026  -0.447\ntri_mean_sample_scaled  0.944270   0.001098 860.165\nstate_abbFL             0.068811   0.412070   0.167\nstate_abbMI             0.013371   0.412073   0.032\nstate_abbLA             0.112335   0.412109   0.273\nstate_abbIL             0.069854   0.412043   0.170\nstate_abbMN             0.151334   0.412066   0.367\nstate_abbND             0.064370   0.412088   0.156\nstate_abbMS             0.076474   0.412005   0.186\nstate_abbTX             0.018921   0.412003   0.046\nstate_abbKS             0.154197   0.412029   0.374\nstate_abbWI             0.084184   0.412079   0.204\nstate_abbOK             0.056549   0.412009   0.137\nstate_abbNE             0.110183   0.412020   0.267\nstate_abbRI             0.154448   0.412364   0.375\nstate_abbIN             0.267030   0.412068   0.648\nstate_abbSD             0.163901   0.412025   0.398\nstate_abbSC             0.297093   0.412026   0.721\nstate_abbAL             0.047262   0.412030   0.115\nstate_abbIA             0.301910   0.412012   0.733\nstate_abbMO             0.094925   0.412008   0.230\nstate_abbGA             0.237632   0.412007   0.577\nstate_abbAR             0.047341   0.412058   0.115\nstate_abbNJ             0.378236   0.412097   0.918\nstate_abbOH             0.219358   0.412051   0.532\nstate_abbME             0.077980   0.412143   0.189\nstate_abbMD             0.309765   0.412198   0.751\nstate_abbMA             0.142192   0.412061   0.345\nstate_abbMT            -0.611956   0.412023  -1.485\nstate_abbTN            -0.005935   0.412062  -0.014\nstate_abbVA            -0.175889   0.412025  -0.427\nstate_abbCT             0.251949   0.412061   0.611\nstate_abbNC             0.443372   0.412017   1.076\nstate_abbWY            -0.065306   0.412050  -0.158\nstate_abbNM             0.407111   0.412202   0.988\nstate_abbNH            -0.089691   0.412125  -0.218\nstate_abbNY             0.401771   0.412038   0.975\nstate_abbNV             0.101763   0.412160   0.247\nstate_abbAZ             0.252024   0.412222   0.611\nstate_abbKY             0.109801   0.412073   0.266\nstate_abbPA             0.260837   0.412052   0.633\nstate_abbWA            -0.692934   0.412107  -1.681\nstate_abbID            -0.180944   0.412219  -0.439\nstate_abbVT             0.502196   0.412233   1.218\nstate_abbOR             0.047552   0.412095   0.115\nstate_abbCO             0.537532   0.412038   1.305\nstate_abbUT             0.985488   0.412096   2.391\nstate_abbCA             0.640588   0.412056   1.555\nstate_abbWV             0.522318   0.412178   1.267\n\n\nShow the code\nr_squared &lt;- rsq(mod.h1.4)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\nFor this model r_squared: 0.95 consisting of fixed effects: 0.93 and random effects: 0.02.\n\nWhile residuals are mostly small, a plot of residuals by predicted (Figure 10.9) is not what we’d hope for:\n\n\nShow the code\n# following pattern at \n# https://mspeekenbrink.github.io/sdam-r-companion/linear-mixed-effects-models.html#visually-assessing-model-assumptions\n\ntdat &lt;- tibble(predicted = predict(mod.h1.4), \n               residual = residuals(mod.h1.4), \n               state_abb = dta_for_model$state_abb)\n\np0 &lt;- tdat |&gt;\n  ggplot(aes(abs(residual))) + \n  geom_histogram(binwidth = 0.1, \n                 alpha = 0.5) +\n  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA)) +\n  labs(\n    subtitle = \"A. Histogram (residuals)\",\n    x = \"abs(residual)\",\n  )\n\np1 &lt;- tdat |&gt;\n  ggplot(aes(x = predicted, y = residual,\n             color = state_abb)) + \n  geom_point(size = 0.25,\n             alpha = 0.25) +\n  geom_hline(yintercept = 0, \n             lty = 2,\n             linewidth = 0.5,\n             alpha = 0.5) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA)) +\n  labs(\n    subtitle = \"A. Scatter plot\"\n  )\n\np1b &lt;- tdat |&gt;\n  ggplot(aes(x = predicted, y = residual,\n             color = state_abb)) + \n  geom_line(linewidth = 0.2,\n             alpha = 0.8) + \n  geom_hline(yintercept = 0, \n             lty = 2,\n             linewidth = 0.5,\n             alpha = 0.5) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA)) +\n  labs(\n    subtitle = \"A2. Line plot (same data)\",\n  )\n\np2 &lt;- tdat |&gt;\n  ggplot(aes(abs(residual),\n             color = state_abb)) + \n  stat_ecdf(linewidth = 0.2,\n             alpha = 0.8,\n            pad = FALSE) +\n  scale_y_continuous(labels = label_percent()) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA)) +\n  labs(\n    subtitle = \"B1. ECDF plot (residuals)\",\n    x = \"abs(residual)\",\n    y = \"Percent of residuals\"\n  )\n\np2b &lt;- tdat |&gt;\n  filter(residual &gt; 0) |&gt; # because scale_x_log10()\n  ggplot(aes(abs(residual),\n             color = state_abb)) + \n  stat_ecdf(linewidth = 0.2,\n             alpha = 0.8,\n            pad = FALSE) +\n  stat_ecdf(data = tdat |&gt;\n              filter(residual &gt; 0),\n            aes(abs(residual), color = state_abb),\n            linewidth = 1,\n            color = \"blue\",\n             alpha = 0.8,\n            pad = FALSE) +\n  scale_x_log10() +\n  scale_y_continuous(labels = label_percent()) +\n  guides(color = \"none\") +\n  coord_cartesian(xlim = c(0.01, NA)) +\n  labs(\n    subtitle = \"B2. ECDF plot (residuals on log10 scale)\",\n    x = \"abs(residual) (log10 scale)\",\n    y = \"Percent of residuals\"\n  )\n\nmy_layout &lt;- \nc(\"\nAA\nBC\nDE\")\n\np0 + p1 + p1b + p2 + p2b +\n  plot_annotation(\n    title = \"mod.h1.4 residuals are small but far from the random distribution\\none looks for in a well-described model\",\n    subtitle = 'Each \"thread\" is the residuals for a state',\n    caption = my_caption_nid_opentopography\n  ) +\n  plot_layout(design = my_layout)\n\n\n\n\n\n\n\n\nFigure 10.9: Residuals of model mod.h1.4 are mostly small but not randomly distributed\n\n\n\n\n\n\n\n\nShow the code\nggplot(tdat, aes(sample = residual)) +\n  stat_qq() + \n  stat_qq_line(\n    lty = 2,\n    linewidth = 0.5,\n    alpha = 0.5\n  ) +\n  labs(\n    title = \"mod.h1.4 QQ Plot residuals are not normal\",\n    subtitle = \"Tails are heavier than a normal distribution would produce\",\n    caption = my_caption_nid_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 10.10: mod.h1.4 QQ Plot shows the model produces heavy non-normal tails\n\n\n\n\n\n\n\n\n\n10.3.4 Conclusion: H1\nFrom the plots:\n\nFigure 10.5 is quite helpful. All four panels support \\(H_1\\).\nFigure 10.7 is also helpful. The log-log plots in panels A2 and B2 show that in most cases, \\(tri\\_mean_{dam}\\) exceeds \\(tri\\_mean_{sample}\\).\n\nIn flatter areas \\(H_1\\) is true. In mountainous areas it is not.\nFrom the regressions:\n\nSection 10.3.3.4 @mod.h1.4 best describes the variation in the data. Conditional means of the state effects are also aligned with the states’ \\(median(tri\\_mean_{sample})\\).\nThe regressions don’t make a strong case for \\(H_1\\).",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#sec-h2-explore",
    "href": "ruggedness.html#sec-h2-explore",
    "title": "10  Terrain ruggedness",
    "section": "10.4 Exploring H2 : In states with higher terrain ruggedness, dams’ \\(\\frac{surfaceArea}{nidStorage}\\) will be lower",
    "text": "10.4 Exploring H2 : In states with higher terrain ruggedness, dams’ \\(\\frac{surfaceArea}{nidStorage}\\) will be lower\nAs a reminder:\nWhere dams are in more rugged areas, it seems likely dams’ lakes will be deeper and thus have smaller ratios \\(\\frac{surfaceArea}{nidStorage}\\). In other words, considering the states in the continental US, there is an inverse proportional relationship:\n\\[tri\\_mean_{sample} \\propto \\frac{1}{\\left(\\frac{surfaceArea}{nidStorage}\\right)}\\]\nI look at two regressions:\n\nlm(tri_mean_sample ~ ratio)\n\n\nHow much does this simple mode capture the variance in the data? Does it perform better than the base model looking only at state effects Section 10.3.3.3?\n\n\nlmer(tri_mean_sample ~ ratio + (1 | state_abb)\n\n\nI assume this is the model likely to explain more variance than the other models.\n\nwhere \\(ratio = \\frac{surfaceArea}{nidStorage}\\).\n\n10.4.1 First: surfaceArea and nidStorage distributions\n\n10.4.1.1 Data availability\nThe NID records are mostly complete with nidHeight. In comparison, there are more gaps for nidStorage (water volume) and water surfaceArea. For most states, the nidStorage missing rate is less than 4%. The exception is Connecticut, where the missing rate is 35%\n\n\nShow the code\nmissing_nidStorage_by_state &lt;- dta_for_model |&gt;\n  select(state_abb, nidStorage) |&gt;\n  mutate(no_nidStorage = is.na(nidStorage)) |&gt;\n  reframe(n_dams = n(),\n          n_missing_nidStorage = sum(no_nidStorage),\n          pct_missing_nidStorage = n_missing_nidStorage / n_dams,\n          .by = state_abb) |&gt;\n  arrange(desc(pct_missing_nidStorage)) |&gt;\n  filter(pct_missing_nidStorage &gt; 0) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  mutate(rowid = row_number(),\n         pct_missing_nidStorage = n_missing_nidStorage / n_dams) # Do this again to pick up total row\n\nmissing_nidStorage_by_state |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Percent of dams missing nidStorage values**\")) |&gt;\n  fmt_percent(columns = starts_with(\"pct_\"),\n              decimals = 2)\n\n\n\n\n\n\n\n\n\n\n\nPercent of dams missing nidStorage values\n\n\nstate_abb\nn_dams\nn_missing_nidStorage\npct_missing_nidStorage\nrowid\n\n\n\n\nCT\n1211\n425\n35.09%\n1\n\n\nMD\n402\n15\n3.73%\n2\n\n\nRI\n222\n8\n3.60%\n3\n\n\nNJ\n787\n23\n2.92%\n4\n\n\nIN\n1081\n25\n2.31%\n5\n\n\nNC\n3346\n72\n2.15%\n6\n\n\nIL\n1606\n28\n1.74%\n7\n\n\nNM\n395\n5\n1.27%\n8\n\n\nUT\n825\n9\n1.09%\n9\n\n\nWV\n473\n5\n1.06%\n10\n\n\nCA\n1430\n10\n0.70%\n11\n\n\nNY\n1850\n11\n0.59%\n12\n\n\nME\n547\n3\n0.55%\n13\n\n\nMO\n5375\n23\n0.43%\n14\n\n\nOR\n854\n3\n0.35%\n15\n\n\nKY\n1063\n3\n0.28%\n16\n\n\nAZ\n362\n1\n0.28%\n17\n\n\nPA\n1462\n4\n0.27%\n18\n\n\nWA\n789\n2\n0.25%\n19\n\n\nNV\n499\n1\n0.20%\n20\n\n\nMI\n1014\n2\n0.20%\n21\n\n\nMN\n1113\n2\n0.18%\n22\n\n\nTN\n1199\n2\n0.17%\n23\n\n\nNH\n634\n1\n0.16%\n24\n\n\nLA\n704\n1\n0.14%\n25\n\n\nFL\n1059\n1\n0.09%\n26\n\n\nAL\n2175\n2\n0.09%\n27\n\n\nMA\n1213\n1\n0.08%\n28\n\n\nAR\n1253\n1\n0.08%\n29\n\n\nSD\n2530\n2\n0.08%\n30\n\n\nMT\n2958\n2\n0.07%\n31\n\n\nCO\n1948\n1\n0.05%\n32\n\n\nKS\n2226\n1\n0.04%\n33\n\n\nGA\n5356\n2\n0.04%\n34\n\n\nVA\n2695\n1\n0.04%\n35\n\n\nTotal\n52656\n698\n1.33%\n36\n\n\n\n\n\n\n\n\nTable 10.1: Missing nidStorage by state\n\n\n\n\nOnly the smallest dams have a missing 1 rate greater than 1%:\n\n\nShow the code\nmissing_nidStorage_by_nidHeightId &lt;- dta_for_model |&gt;\n  select(nidHeightId, nidStorage) |&gt;\n  mutate(no_nidStorage = is.na(nidStorage)) |&gt;\n  reframe(n_dams = n(),\n          n_missing_nidStorage = sum(no_nidStorage),\n          pct_missing_nidStorage = n_missing_nidStorage / n_dams,\n          .by = nidHeightId) |&gt;\n  # arrange(desc(pct_missing_nidStorage)) |&gt;\n  filter(pct_missing_nidStorage &gt; 0) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  mutate(rowid = row_number(),\n         pct_missing_nidStorage = n_missing_nidStorage / n_dams) # Do this again to pick up total row\n\nmissing_nidStorage_by_nidHeightId |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Percent of dams missing nidStorage values**\")) |&gt;\n  fmt_percent(columns = starts_with(\"pct_\"),\n              decimals = 2) |&gt;\n  cols_align(columns = nidHeightId,\n             align = \"left\")\n\n\n\n\n\n\n\n\n\n\n\nPercent of dams missing nidStorage values\n\n\nnidHeightId\nn_dams\nn_missing_nidStorage\npct_missing_nidStorage\nrowid\n\n\n\n\nLess than 25 feet\n43011\n598\n1.39%\n1\n\n\n51-100 feet\n5023\n15\n0.30%\n2\n\n\n25-50 feet\n36294\n80\n0.22%\n3\n\n\nGreater than 100 feet\n1526\n5\n0.33%\n4\n\n\nTotal\n85854\n698\n0.81%\n5\n\n\n\n\n\n\n\n\nTable 10.2: Missing nidStorage by nidHeightId\n\n\n\n\n\nFor surfaceArea the gaps are worse. For example, Utah and Montana, South Dakota, and Alabama are missing surfaceArea for more than 75% of their dams. Among all dams, 20% are missing this data.\n\n\nShow the code\nmissing_surfaceArea_by_state &lt;- dta_for_model |&gt;\n  select(state_abb, surfaceArea) |&gt;\n  mutate(no_surfaceArea = is.na(surfaceArea)) |&gt;\n  reframe(n_dams = n(),\n          n_missing_surfaceArea = sum(no_surfaceArea),\n          pct_missing_surfaceArea = n_missing_surfaceArea / n_dams,\n          .by = state_abb) |&gt;\n  arrange(desc(pct_missing_surfaceArea)) |&gt;\n  filter(pct_missing_surfaceArea &gt; 0) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  mutate(rowid = row_number(),\n         pct_missing_surfaceArea = n_missing_surfaceArea / n_dams) # Do this again to pick up total row\n\nmissing_surfaceArea_by_state |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Percent of dams missing surfaceArea values**\")) |&gt;\n  fmt_percent(columns = starts_with(\"pct_\"),\n              decimals = 2)\n\n\n\n\n\n\n\n\n\n\n\nPercent of dams missing surfaceArea values\n\n\nstate_abb\nn_dams\nn_missing_surfaceArea\npct_missing_surfaceArea\nrowid\n\n\n\n\nUT\n825\n790\n95.76%\n1\n\n\nMT\n2958\n2445\n82.66%\n2\n\n\nSD\n2530\n2007\n79.33%\n3\n\n\nAL\n2175\n1642\n75.49%\n4\n\n\nIL\n1606\n938\n58.41%\n5\n\n\nMS\n6088\n2344\n38.50%\n6\n\n\nAR\n1253\n471\n37.59%\n7\n\n\nMN\n1113\n380\n34.14%\n8\n\n\nVA\n2695\n918\n34.06%\n9\n\n\nTX\n7270\n1787\n24.58%\n10\n\n\nNM\n395\n90\n22.78%\n11\n\n\nAZ\n362\n68\n18.78%\n12\n\n\nWV\n473\n75\n15.86%\n13\n\n\nND\n860\n127\n14.77%\n14\n\n\nOK\n4968\n708\n14.25%\n15\n\n\nKY\n1063\n141\n13.26%\n16\n\n\nWA\n789\n104\n13.18%\n17\n\n\nOR\n854\n112\n13.11%\n18\n\n\nPA\n1462\n186\n12.72%\n19\n\n\nKS\n2226\n278\n12.49%\n20\n\n\nMD\n402\n49\n12.19%\n21\n\n\nNC\n3346\n370\n11.06%\n22\n\n\nMA\n1213\n105\n8.66%\n23\n\n\nWI\n953\n77\n8.08%\n24\n\n\nCA\n1430\n94\n6.57%\n25\n\n\nGA\n5356\n309\n5.77%\n26\n\n\nSC\n2399\n133\n5.54%\n27\n\n\nOH\n1393\n64\n4.59%\n28\n\n\nRI\n222\n10\n4.50%\n29\n\n\nTN\n1199\n49\n4.09%\n30\n\n\nCT\n1211\n49\n4.05%\n31\n\n\nIN\n1081\n43\n3.98%\n32\n\n\nDE\n83\n3\n3.61%\n33\n\n\nME\n547\n18\n3.29%\n34\n\n\nMI\n1014\n27\n2.66%\n35\n\n\nCO\n1948\n47\n2.41%\n36\n\n\nNV\n499\n12\n2.40%\n37\n\n\nWY\n1471\n31\n2.11%\n38\n\n\nLA\n704\n14\n1.99%\n39\n\n\nNY\n1850\n36\n1.95%\n40\n\n\nNJ\n787\n15\n1.91%\n41\n\n\nNE\n2948\n53\n1.80%\n42\n\n\nIA\n4042\n70\n1.73%\n43\n\n\nNH\n634\n6\n0.95%\n44\n\n\nID\n375\n2\n0.53%\n45\n\n\nFL\n1059\n4\n0.38%\n46\n\n\nMO\n5375\n9\n0.17%\n47\n\n\nTotal\n85506\n17310\n20.24%\n48\n\n\n\n\n\n\n\n\nTable 10.3: Missing surfaceArea by state\n\n\n\n\n\nThe biggest gaps in surfaceArea data are for the smallest dams, where a quarter are missing.\n\n\nShow the code\nmissing_surfaceArea_by_nidHeightId &lt;- dta_for_model |&gt;\n  select(nidHeightId, surfaceArea) |&gt;\n  mutate(no_surfaceArea = is.na(surfaceArea)) |&gt;\n  reframe(n_dams = n(),\n          n_missing_surfaceArea = sum(no_surfaceArea),\n          pct_missing_surfaceArea = n_missing_surfaceArea / n_dams,\n          .by = nidHeightId) |&gt;\n  # arrange(desc(pct_missing_surfaceArea)) |&gt;\n  filter(pct_missing_surfaceArea &gt; 0) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  mutate(rowid = row_number(),\n         pct_missing_surfaceArea = n_missing_surfaceArea / n_dams) # Do this again to pick up total row\n\nmissing_surfaceArea_by_nidHeightId |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Percent of dams missing surfaceArea values**\")) |&gt;\n  fmt_percent(columns = starts_with(\"pct_\"),\n              decimals = 2) |&gt;\n  cols_align(columns = nidHeightId,\n             align = \"left\")\n\n\n\n\n\n\n\n\n\n\n\nPercent of dams missing surfaceArea values\n\n\nnidHeightId\nn_dams\nn_missing_surfaceArea\npct_missing_surfaceArea\nrowid\n\n\n\n\nLess than 25 feet\n43011\n10887\n25.31%\n1\n\n\n51-100 feet\n5023\n514\n10.23%\n2\n\n\n25-50 feet\n36294\n5719\n15.76%\n3\n\n\nGreater than 100 feet\n1526\n190\n12.45%\n4\n\n\nTotal\n85854\n17310\n20.16%\n5\n\n\n\n\n\n\n\n\nTable 10.4: Missing surfaceArea by nidHeightId\n\n\n\n\n\nLet’s proceed with exploring \\(H_2\\), recognizing that for some states the results may not be useful.\n\n\n10.4.1.2 Plots\nIn this section I look at the distributions and relationship between surfaceArea and nidStorage before exploring their associations with \\(tri\\_mean_{sample}\\) in the next section.\nOf note in Figure 10.11:\n\nThe distributions of surfaceArea, nidStorage, and \\(\\frac{surfaceArea}{nidStorage}\\) differ in many states. I’m not sure what to make of this fact.\n\n\n\nShow the code\ndta_for_plot &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  mutate(state_median_surfaceArea = median(surfaceArea),\n         state_median_nidStorage = median(nidStorage),\n         state_median_area_to_vol = median(area_to_volume_dam),\n         .by = state_abb) |&gt;\n  mutate(state_abb = fct_reorder(state_abb, state_median_surfaceArea))\n\np1_surfaceArea_by_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(surfaceArea, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot |&gt;\n      distinct(state_abb, state_median_surfaceArea),\n    aes(state_median_surfaceArea, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  # guides(fill = guide_legend(position = \"inside\")) +\n  guides(fill = \"none\") + #guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.75, 0.15)) +\n  labs(\n    subtitle = \"A. surfaceArea&lt;br&gt;\",\n    y = NULL\n  )\n\np2_nidStorage_by_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(nidStorage, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot |&gt;\n      distinct(state_abb, state_median_nidStorage),\n    aes(state_median_nidStorage, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  # scale_x_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") + #guide_legend(position = \"inside\")) +\n  # theme(legend.position.inside = c(0.75, 0.15)) +\n  coord_cartesian(xlim = c(1, 1e6)) +\n  labs(\n    subtitle = \"B. nidStorage&lt;br&gt;\",\n    y = NULL\n  )\n\np3_surface_area_nidStorage_by_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(area_to_volume_dam, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot |&gt;\n      distinct(state_abb, state_median_area_to_vol),\n    aes(state_median_area_to_vol, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  # scale_x_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") + #guide_legend(position = \"inside\")) +\n  # theme(legend.position.inside = c(0.75, 0.15)) +\n  coord_cartesian(xlim = c(0.001, 1)) +\n  labs(\n    subtitle = \"C. surfaceArea / nidStorage&lt;br&gt;\",\n    y = NULL\n  )\n\np4_n_dams_by_state &lt;- dta_for_plot |&gt;\n  reframe(n = n(),\n          .by = c(state_abb, region_label)) |&gt;\n  ggplot() +\n  geom_col(\n    aes(n, state_abb, fill = region_label),\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") +\n  labs(\n    subtitle = \"D. Number of dams\",\n    x = \"n dams with surfaceArea\\nand nidStorage values\",\n    y = NULL\n  )\n\nmy_layout &lt;-\nc(\"\nABCD\")\n\np1_surfaceArea_by_state + p2_nidStorage_by_state + \n  p3_surface_area_nidStorage_by_state + p4_n_dams_by_state +\n  plot_annotation(\n    title = \"Distributions by state: surfaceArea, nidStorage, and surfaceArea / nidStorage\",\n    subtitle = glue(\"Red indicator is median for each subplot. All rows sorted by median surfaceArea.\",\n                    \"\\nX axis in panels A-C are on log10 scale.&lt;br&gt;\"),\n    caption = my_caption_nid_opentopography\n  ) +\n  plot_layout(design = my_layout) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.11: Distributions by state: surfaceArea, nidStorage, and surfaceArea / nidStorage\n\n\n\n\n\n\nOf note re: Figure 10.12:\nFaceting by nidHeightId shows the distributions of the largest dams “Greater than 100 ft” have the most variation in the distributions. This is due in part to the much larger nidHeight range in this category (~101 to ~800 ft).\n\n\nShow the code\ndta_for_plot &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  mutate(state_median_surfaceArea = median(surfaceArea),\n         state_median_nidStorage = median(nidStorage),\n         state_median_area_to_vol = median(area_to_volume_dam),\n         .by = state_abb) |&gt;\n  mutate(state_abb = fct_reorder(state_abb, state_median_surfaceArea))\n\np1_surfaceArea_by_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(surfaceArea, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot |&gt;\n      distinct(state_abb, state_median_surfaceArea),\n    aes(state_median_surfaceArea, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  # guides(fill = guide_legend(position = \"inside\")) +\n  guides(fill = \"none\") + #guide_legend(position = \"inside\")) +\n  theme(legend.position.inside = c(0.75, 0.15),\n        strip.text = element_text(size = rel(0.75))) +\n  facet_wrap(~ nidHeightId, nrow = 1) +\n  labs(\n    subtitle = \"A. surfaceArea&lt;br&gt;\",\n    y = NULL\n  )\n\np2_nidStorage_by_state &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_density_ridges(\n    aes(nidStorage, state_abb, fill = region_label),\n    rel_min_height = 0.005,\n    linewidth = 0.1,\n    color = NA,\n    alpha = 0.5\n  ) +\n  geom_text(\n    data = dta_for_plot |&gt;\n      distinct(state_abb, state_median_nidStorage),\n    aes(state_median_nidStorage, state_abb, label = \"^\"),\n    size = 4,\n    alpha = 0.75,\n    color = \"firebrick\"\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  # scale_x_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(fill = \"none\") + #guide_legend(position = \"inside\")) +\n  # theme(legend.position.inside = c(0.75, 0.15)) +\n  theme(strip.text = element_text(size = rel(0.75))) +\n  facet_wrap(~ nidHeightId, nrow = 1) +\n  coord_cartesian(xlim = c(1, 1e6)) +\n  labs(\n    subtitle = \"B. nidStorage&lt;br&gt;\",\n    y = NULL\n  )\n\nmy_layout &lt;-\nc(\"\nAB\")\n\np1_surfaceArea_by_state + p2_nidStorage_by_state + \n  plot_annotation(\n    title = \"Distribution of surfaceArea and nidStorage by nidHeightId - continental states\",\n    subtitle = glue(\"Red indicator is median for all nidHeightId. All rows sorted by median surfaceArea.\",\n                    \" X axes are on log10 scale.&lt;br&gt;\"),\n    caption = my_caption_nid_opentopography\n  ) +\n  plot_layout(design = my_layout) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.12: Distribution of surfaceArea and nidStorage in each state\n\n\n\n\n\n\nOf note re: Figure 10.13:\n\nThis plot is helpful in exploring the relationship between surfaceArea and nidStorage.\nThere appear to be data errors, data entry errors, or estimation heuristics at play at small surfaceArea values around 1 acre (see horizontal lines in panel A).\nOtherwise, there appears to be near-linear relationships between surfaceArea and nidStorage, implying that dams generally have a similar “shape”: they grow in surfaceArea as nidStorage grows.\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(nidStorage, surfaceArea, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"A. storage_area / nidStorage&lt;br&gt;\",\n    x = \"nidStorage (log10 scale)\",\n    y = \"surfaceArea (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(nidStorage, surfaceArea, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    # size = 0.25,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.35, 0.85)) +\n  labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"nidStorage (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"surfaceArea by nidStorage - all dams\",\n    # subtitle = \"REPLACE ME&lt;br&gt;\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.13: surfaceArea by nidStorage - all dams\n\n\n\n\n\n\n\n\n10.4.1.3 Model mod.h2.1\nThe model mod.h2.1 has some explanatory power. \\(R^2\\) = 0.38.\n\\[mod.h2.1: surfaceArea \\sim nidStorage\\]\n\n\nShow the code\nmod.h2.1 &lt;- dta_for_model |&gt;\n  lm(surfaceArea ~ nidStorage,\n       data = _)\n\nsummary(mod.h2.1)\n\n\n\nCall:\nlm(formula = surfaceArea ~ nidStorage, data = dta_for_model)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-145078    -151    -146    -132  399225 \n\nCoefficients:\n                Estimate   Std. Error t value Pr(&gt;|t|)    \n(Intercept) 155.48337258  12.43326056   12.51   &lt;2e-16 ***\nnidStorage    0.01017373   0.00004963  205.01   &lt;2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 3240 on 68054 degrees of freedom\n  (17798 observations deleted due to missingness)\nMultiple R-squared:  0.3818,    Adjusted R-squared:  0.3818 \nF-statistic: 4.203e+04 on 1 and 68054 DF,  p-value: &lt; 2.2e-16\n\n\n\n\n\n10.4.1.4 Model mod.h2.2\nThe model mod.h2.2 has some explanatory power. \\(R^2\\) = 0.39 (which is less improvement over mod.h2.1 than I expected). So there isn’t really a state-level effect on the ratio \\(surfaceArea::nidStorage\\).\n\\[mod.h2.2: surfaceArea \\sim nidStorage | state\\]\n\n\nShow the code\nmod.h2.2 &lt;- dta_for_model |&gt;\n  mutate(surfaceArea_scaled = scale(surfaceArea),\n         nidStorage_scaled = scale(nidStorage)) |&gt;\n  lmer(surfaceArea ~ nidStorage_scaled + state_abb + (1 | state_abb),\n       data = _)\n\nsummary(mod.h2.2)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: surfaceArea ~ nidStorage_scaled + state_abb + (1 | state_abb)\n   Data: mutate(dta_for_model, surfaceArea_scaled = scale(surfaceArea),  \n    nidStorage_scaled = scale(nidStorage))\n\nREML criterion at convergence: 1292501\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-44.635  -0.038  -0.016  -0.008 123.305 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept)     3713   60.93 \n Residual              10454667 3233.37 \nNumber of obs: 68056, groups:  state_abb, 48\n\nFixed effects:\n                  Estimate Std. Error t value\n(Intercept)        141.797    366.601   0.387\nnidStorage_scaled 2296.989     11.217 204.777\nstate_abbFL        314.508    384.745   0.817\nstate_abbMI        211.262    385.632   0.548\nstate_abbLA        504.886    391.486   1.290\nstate_abbIL        249.938    392.183   0.637\nstate_abbMN       1410.151    390.375   3.612\nstate_abbND        -78.014    390.353  -0.200\nstate_abbMS        -29.856    375.369  -0.080\nstate_abbTX         76.693    374.188   0.205\nstate_abbKS         18.274    378.782   0.048\nstate_abbWI        764.930    387.355   1.975\nstate_abbOK         43.983    374.918   0.117\nstate_abbNE        -20.414    376.458  -0.054\nstate_abbRI         19.966    433.194   0.046\nstate_abbIN          6.842    385.174   0.018\nstate_abbSD        530.707    397.678   1.335\nstate_abbSC         82.017    377.787   0.217\nstate_abbAL        496.076    397.146   1.249\nstate_abbIA         -4.798    375.155  -0.013\nstate_abbMO        -14.619    374.252  -0.039\nstate_abbGA          4.605    374.407   0.012\nstate_abbAR        717.161    389.205   1.843\nstate_abbNJ          8.135    389.746   0.021\nstate_abbOH         21.453    382.068   0.056\nstate_abbME       1045.453    397.426   2.631\nstate_abbMD          3.124    410.381   0.008\nstate_abbMA         22.566    384.116   0.059\nstate_abbMT        157.714    398.124   0.396\nstate_abbTN        152.525    383.668   0.398\nstate_abbVA         -3.916    379.463  -0.010\nstate_abbCT          6.443    389.202   0.017\nstate_abbNC          3.552    376.362   0.009\nstate_abbWY         55.390    381.273   0.145\nstate_abbNM        258.783    415.748   0.622\nstate_abbNH        175.393    393.391   0.446\nstate_abbNY        169.048    379.331   0.446\nstate_abbNV       -229.166    399.539  -0.574\nstate_abbAZ       -234.985    416.789  -0.564\nstate_abbKY        201.683    386.604   0.522\nstate_abbPA         17.651    382.504   0.046\nstate_abbWA        259.276    391.631   0.662\nstate_abbID        821.693    407.604   2.016\nstate_abbVT         30.464    410.063   0.074\nstate_abbOR        304.713    390.128   0.781\nstate_abbCO        234.956    378.961   0.620\nstate_abbUT        802.745    660.980   1.214\nstate_abbCA        147.673    382.018   0.387\nstate_abbWV         51.198    405.764   0.126\n\n\nShow the code\nr_squared &lt;- rsq(mod.h2.2)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\n\n\n\n10.4.2 Second: exploring the relationship among tri_meansample, sufaceArea, and nidStorage\n\n10.4.2.1 Plots\nOf note re: Figure 10.14:\n\nThe near-vertical nature of the categories in panel A indicate that there is no strong relationship between \\(tri\\_mean_{sample}\\) and surfaceArea.\nOne could tell a story from panel B if the model explained a lot of the variability (which is not likely given panel A). Regression sec-h3-mod1 Model 1 confirms this. Only when we adjust for state does the model capture some of the variability: sec-h3-mod4 Model 4.\n\nThe more surfaceArea, the lower the \\(tri\\_mean_{sample}\\) (panel B). This makes some sense, since lakes behind dams are flat, resulting in lower \\(tri\\_mean_{sample}\\).\nThe regression lines are somewhat parallel: in general, for any surfaceArea value, the higher the nidHeightId, the higher the \\(tri\\_mean_{sample}\\).\n\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(surfaceArea, tri_mean_sample, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  # scale_y_continuous(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"A. Scatter plot&lt;br&gt;\",\n    x = \"surface_area (log10 scale)\",\n    y = \"tri_mean_sample (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(surfaceArea, tri_mean_sample, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    # size = 0.25,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.75, 0.2),\n        legend.background = element_rect(fill = \"transparent\")) +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"surface_area (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;sample&lt;/sub&gt; by surfaceArea&lt;br&gt;for local areas around dams\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.14: tri_meansample by surfaceArea\n\n\n\n\n\n\nOf note re: Figure 10.15:\n\nIt looks like there is a data entry artifact at nidStorage = 100 among small dams (the vertical line in panel A). The people estimating nidStorage probably use 100 acre-feet as a handy guestimate.\nLike with surfaceArea in plot Figure 10.14, the near-vertical nature of the categories in panel A indicate that there is no strong relationship between \\(tri\\_mean_{sample}\\) and surfaceArea.\nOne could tell a story from panel B if the model explained a lot of the variability. Regression sec-h3-mod2 Model 2 confirms this. Only when we adjust for state does the model capture some of the variability: sec-h3-mod5 Model 5\n\nThe more nidStorage, the lower the \\(tri\\_mean_{sample}\\) (panel B). This makes some sense, since surfaceArea grows as nidStorage grows (Figure 10.13), and lakes behind dams are flat, resulting in lower \\(tri\\_mean_{sample}\\).\nThe regression lines are somewhat parallel: in general, for any surfaceArea value, the higher the nidHeightId, the higher the \\(tri\\_mean_{sample}\\).\n\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage),\n         nidStorage &gt;= 1) |&gt;\n  ggplot(aes(nidStorage, tri_mean_sample, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  coord_cartesian(ylim = c(0.1, 100)) +labs(\n    subtitle = \"A. Scatter plot\",\n    x = \"nidStorage (log10 scale)\",\n    y = \"tri_mean_sample (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage),\n         nidStorage &gt;= 1) |&gt;\n  ggplot(aes(nidStorage, tri_mean_sample, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.75, 0.2),\n        legend.background = element_rect(fill = \"transparent\")) +\n  coord_cartesian(ylim = c(0.1, 100)) +labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"nidStorage (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;sample&lt;/sub&gt; by nidStorage&lt;br&gt;for local areas around dams\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.15: tri_meansample by nidStoragefor local areas around dams\n\n\n\n\n\n\nOf note re: Figure 10.16 :\nThe plots below using \\(surfaceArea::nidStorage\\) are similar to those above, and the same conclusions apply.\n\nPanel A suggests no meaningful relationship between \\(tri\\_mean_{sample}\\) and \\(\\frac{surfaceArea}{nidStorage}\\)\nOne could tell a story from panel B if the model explained a lot of the variability (which is not likely given panel A). Regression in Section 10.5.2.3 Model 3 confirm this.\n\nThe regression lines are somewhat parallel: in general, for any \\(surfaceArea::nidStorage\\) ratio, the higher the nidHeightId, the higher the \\(tri\\_mean_{sample}\\).\n\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(area_to_volume_dam, tri_mean_sample, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"A. Scatter plot&lt;br&gt;\",\n    x = \"surface_area::nidStorage (log10 scale)\",\n    y = \"tri_mean_saample (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(area_to_volume_dam, tri_mean_sample, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.75, 0.2),\n        legend.background = element_rect(fill = \"transparent\")) +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"surface_area::nidStorage (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;sample&lt;/sub&gt; by surfaceArea::nidStorage&lt;br&gt;for local areas around dams\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.16: tri_meansample by surfaceArea::nidStoragefor local areas around dams\n\n\n\n\n\n\n\n\n10.4.2.2 Regression models\nGiven my observations about Figure 10.16, and the fact that all three of the above plots have “vertical” features in the scatter plots, doubt there is a real relationship with \\(tri\\_mean_{sample}\\). I explore only the best-performing model used in \\(H_3\\): Section 10.5.2.5 Model 5, which has \\(R^2\\) = 0.50 (but that’s not very good given Section 10.5.2.6 Model 6 using only state_abb has \\(R^2\\) = 0.42).\n\n10.4.2.2.1 Model mod.h2.3\nModel mod.h2.3 \\(R^2\\) = 0.49 (which is better than I expected).\n\\[mod.h2.3: tri\\_mean_{dam} \\sim nidstorage | state\\]\n\n\nShow the code\nmod.h2.3 &lt;- dta_for_model |&gt; \n  mutate(tri_mean_sample_scaled = scale(tri_mean_sample),\n         nidStorage_scaled = scale(nidStorage)) |&gt;\n  lmer(tri_mean_sample_scaled ~ nidStorage_scaled + state_abb + (1 | state_abb),\n     data = _)\n\nsummary(mod.h2.3)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_sample_scaled ~ nidStorage_scaled + state_abb + (1 |  \n    state_abb)\n   Data: \nmutate(dta_for_model, tri_mean_sample_scaled = scale(tri_mean_sample),  \n    nidStorage_scaled = scale(nidStorage))\n\nREML criterion at convergence: 206380.2\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.4308 -0.3894 -0.1134  0.2036 10.8448 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 0.342    0.5848  \n Residual              0.659    0.8118  \nNumber of obs: 85156, groups:  state_abb, 48\n\nFixed effects:\n                   Estimate Std. Error t value\n(Intercept)       -0.703919   0.591588  -1.190\nnidStorage_scaled  0.015223   0.002785   5.465\nstate_abbFL        0.030041   0.832248   0.036\nstate_abbMI        0.170992   0.832265   0.205\nstate_abbLA        0.068816   0.832437   0.083\nstate_abbIL        0.144136   0.832124   0.173\nstate_abbMN        0.132261   0.832230   0.159\nstate_abbND        0.229857   0.832334   0.276\nstate_abbMS        0.266060   0.831938   0.320\nstate_abbTX        0.335930   0.831928   0.404\nstate_abbKS        0.233193   0.832051   0.280\nstate_abbWI        0.375901   0.832289   0.452\nstate_abbOK        0.417555   0.831953   0.502\nstate_abbNE        0.365198   0.832008   0.439\nstate_abbRI        0.354044   0.833722   0.425\nstate_abbIN        0.235095   0.832248   0.282\nstate_abbSD        0.368236   0.832030   0.443\nstate_abbSC        0.288565   0.832038   0.347\nstate_abbAL        0.597051   0.832056   0.718\nstate_abbIA        0.336578   0.831971   0.405\nstate_abbMO        0.578288   0.831947   0.695\nstate_abbGA        0.434063   0.831947   0.522\nstate_abbAR        0.670377   0.832190   0.806\nstate_abbNJ        0.339538   0.832392   0.408\nstate_abbOH        0.509397   0.832158   0.612\nstate_abbME        0.722752   0.832601   0.868\nstate_abbMD        0.504976   0.832896   0.606\nstate_abbMA        0.776572   0.832200   0.933\nstate_abbMT        1.611265   0.832007   1.937\nstate_abbTN        1.107426   0.832204   1.331\nstate_abbVA        1.293486   0.832020   1.555\nstate_abbCT        0.857129   0.832377   1.030\nstate_abbNC        0.741665   0.831994   0.891\nstate_abbWY        1.333745   0.832143   1.603\nstate_abbNM        0.901844   0.832888   1.083\nstate_abbNH        1.480325   0.832499   1.778\nstate_abbNY        1.084699   0.832089   1.304\nstate_abbNV        1.417800   0.832669   1.703\nstate_abbAZ        1.261012   0.832971   1.514\nstate_abbKY        1.474209   0.832247   1.771\nstate_abbPA        1.567438   0.832145   1.884\nstate_abbWA        2.747030   0.832377   3.300\nstate_abbID        2.258452   0.832929   2.711\nstate_abbVT        1.645687   0.833011   1.976\nstate_abbOR        2.138093   0.832339   2.569\nstate_abbCO        1.723418   0.832077   2.071\nstate_abbUT        1.749662   0.832359   2.102\nstate_abbCA        2.179372   0.832152   2.619\nstate_abbWV        2.828031   0.832719   3.396\n\n\nShow the code\nr_squared &lt;- rsq(mod.h2.3)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\n\n\n\n\n10.4.3 Conclusion: H2\nThe plots in Section 10.4.2, in particular the near-vertical nature of the categories in the scatter plots indicate that there is no strong relationship between \\(tri\\_mean_{sample}\\) or \\(tri\\_mean_{dam}\\)) and either surfaceArea, nidStorage, or \\(surfaceArea::nidStorage\\)\nFor this reason I minimized my time investment by modeling only the one regression with the most promise (after exploring it in \\(H_3\\)). It wasn’t helpful.\nIn other words, \\(H_2\\) is not supported by the data.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#sec-h3-explore",
    "href": "ruggedness.html#sec-h3-explore",
    "title": "10  Terrain ruggedness",
    "section": "10.5 Exploring H3 : Compared to H2 there is a stronger inverse proportional relationship between ruggeness in the local areas around dams and surfaceArea::nidStorage",
    "text": "10.5 Exploring H3 : Compared to H2 there is a stronger inverse proportional relationship between ruggeness in the local areas around dams and surfaceArea::nidStorage\nThis seems intuitive when compared to \\(H_2\\): dams are built where the topography provides good places to hold water, and where terrain is more rugged and thus the hills steeper, the basins holding water are likely to be deeper.\n\n10.5.1 Plots\nOf note re: Figure 10.17:\n\nBoth panels show that dams with higher surface area tend to have lower \\(tri\\_mean_{dam}\\), and the higher the nidHeightId, the higher the \\(tri\\_mean_{dam}\\).\nCompared to \\(H_2\\)’s Figure 10.14, Figure 10.17 does seem to show some relationship in panel A. See regression Section 10.5.2.1 Model 1.\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(surfaceArea, tri_mean_dam, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"A. Scatter plot&lt;br&gt;\",\n    x = \"surface_area (log10 scale)\",\n    y = \"tri_mean_dam (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(surfaceArea, tri_mean_dam, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    # size = 0.25,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.75, 0.2)) +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"surface_area (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;dam&lt;/sub&gt; by surfaceArea&lt;br&gt;for local areas around dams\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.17: tri_meandam by surfaceArea\n\n\n\n\n\n\nOf note re: Figure 10.18:\n\nThere is a similar story for nidStorage: dams with higher nidStorage tend to have lower \\(tri\\_mean_{dam}\\), and the higher the nidHeightId, the higher the \\(tri\\_mean_{dam}\\).\nIt looks like there is a data entry artifact at nidStorage = 100 among small dams (the vertical line in panel A). People estimating nidStorage probably use 100 acre-feet as a handy guestimate.\nCompared to \\(H_2\\)’s Figure 10.15, Figure 10.18 does seem to show some relationship in panel A. See regression Section 10.5.2.2 Model 2.\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage),\n         nidStorage &gt;= 1) |&gt;\n  ggplot(aes(nidStorage, tri_mean_dam, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  coord_cartesian(ylim = c(0.1, 100)) +labs(\n    subtitle = \"A. Scatter plot\",\n    x = \"nidStorage (log10 scale)\",\n    y = \"tri_mean_dam (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage),\n         nidStorage &gt;= 1) |&gt;\n  ggplot(aes(nidStorage, tri_mean_dam, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    # size = 0.25,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.75, 0.2)) +\n  coord_cartesian(ylim = c(0.1, 100)) +labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"nidStorage (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;dam&lt;/sub&gt; by nidStorage&lt;br&gt;for local areas around dams\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.18: tri_meandam by nidStoragefor local areas around dams\n\n\n\n\n\n\nOf note re: Figure 10.19:\nResults are the same as when using \\(tri\\_mean_{sample}\\) in Figure 10.16 above to explore \\(H_2\\).\n\nPanel A suggests there is no meaningful relationship between \\(tri\\_mean_{dam}\\) and \\(\\frac{surfaceArea}{nidStorage}\\)\nOne could tell a story from panel B if the model explained a lot of the variability (which is not likely given panel A). Regressions in sec-h3-mod6 Model 6 confirm this.\n\nThe regression lines are somewhat parallel: in general, for any surfaceArea::nidStorage ratio, the higher the nidHeightId, the higher the \\(tri\\_mean_{sample}\\).\n\n\n\n\nShow the code\np1 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(area_to_volume_dam, tri_mean_dam, color = nidHeightId, group = nidHeightId)) +\n  geom_point(\n    size = 0.25,\n    alpha = 0.25\n  ) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"A. Scatter plot&lt;br&gt;\",\n    x = \"surface_area::nidStorage (log10 scale)\",\n    y = \"tri_mean_dam (log10 scale)\"\n  )\n\np2 &lt;- dta_for_model |&gt;\n  filter(!is.na(surfaceArea),\n         !is.na(nidStorage)) |&gt;\n  ggplot(aes(area_to_volume_dam, tri_mean_dam, color = nidHeightId, group = nidHeightId)) +\n  geom_smooth(\n    method = 'gam',\n    formula = y ~ s(x, bs = \"cs\"),\n    linewidth = 0.5,\n    alpha = 0.8,\n    se = FALSE) +\n  scale_x_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_y_log10(label = label_number(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = guide_legend(position = \"inside\",\n                              override.aes = list(linewidth = 3))) +\n  theme(legend.position.inside = c(0.75, 0.2)) +\n  coord_cartesian(ylim = c(0.1, 100)) +\n  labs(\n    subtitle = \"B. Regression line plot (same data)&lt;br&gt;\",\n    x = \"surface_area::nidStorage (log10 scale)\",\n    y = NULL\n  )\n\np1 + p2 + \n  plot_annotation(\n    title = \"tri_mean&lt;sub&gt;dam&lt;/sub&gt; by surfaceArea::nidStorage&lt;br&gt;for local areas around dams\",\n    caption = my_caption_nid_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 10.19: tri_meandam by surfaceArea::nidStoragefor local areas around dams\n\n\n\n\n\n\n\n\n10.5.2 Regression models\n\n10.5.2.1 Model mod.h3.1\nThe model mod.h3.1 has no explanatory power. \\(R^2\\) is effectively zero.\n\\[mod.h3.1: tri\\_mean_{dam} \\sim surfaceArea\\]\n\n\nShow the code\nmod.h3.1 &lt;- dta_for_model |&gt;\n  lm(tri_mean_dam ~ surfaceArea,\n     data = _)\n\nsummary(mod.h3.1)\n\n\n\nCall:\nlm(formula = tri_mean_dam ~ surfaceArea, data = dta_for_model)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-7.923 -2.550 -1.379  0.508 58.869 \n\nCoefficients:\n               Estimate  Std. Error t value Pr(&gt;|t|)    \n(Intercept) 4.776714814 0.017544845 272.257  &lt; 2e-16 ***\nsurfaceArea 0.000011097 0.000004263   2.603  0.00925 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 4.584 on 68542 degrees of freedom\n  (17310 observations deleted due to missingness)\nMultiple R-squared:  9.882e-05, Adjusted R-squared:  8.423e-05 \nF-statistic: 6.774 on 1 and 68542 DF,  p-value: 0.009251\n\n\n\n\n\n10.5.2.2 Model mod.h3.2\nSimilarly, the model mod.h3.2 has no explanatory power. \\(R^2\\) is effectively zero.\n\\[mod.h3.2: tri\\_mean_{dam} \\sim nidStorage\\]\n\n\nShow the code\nmod.h3.2 &lt;- dta_for_model |&gt;\n  lm(tri_mean_dam ~ nidStorage,\n     data = _)\n\nsummary(mod.h3.2)\n\n\n\nCall:\nlm(formula = tri_mean_dam ~ nidStorage, data = dta_for_model)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-13.932  -2.485  -1.359   0.405  58.967 \n\nCoefficients:\n                 Estimate    Std. Error t value        Pr(&gt;|t|)    \n(Intercept) 4.67615140184 0.01578323542 296.273         &lt; 2e-16 ***\nnidStorage  0.00000046983 0.00000006975   6.736 0.0000000000164 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 4.602 on 85154 degrees of freedom\n  (698 observations deleted due to missingness)\nMultiple R-squared:  0.0005325, Adjusted R-squared:  0.0005208 \nF-statistic: 45.37 on 1 and 85154 DF,  p-value: 0.00000000001642\n\n\n\n\n\n10.5.2.3 Model mod.h3.3\nThe model mod.h3.3 has no explanatory power. \\(R^2\\) is effectively zero and, accordingly, the \\(p\\) value is very high.\n\\[mod.h3.3: tri\\_mean_{dam} \\sim ratio\\]\nwhere \\(ratio = \\frac{surfaceArea}{nidStorage}\\).\n\n\nShow the code\nmod.h3.3 &lt;- dta_for_model |&gt;\n  lm(tri_mean_dam ~ area_to_volume_dam,\n     data = _)\n\nsummary(mod.h3.3)\n\n\n\nCall:\nlm(formula = tri_mean_dam ~ area_to_volume_dam, data = dta_for_model)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-4.744 -2.550 -1.384  0.494 58.877 \n\nCoefficients:\n                   Estimate Std. Error t value Pr(&gt;|t|)    \n(Intercept)         4.77071    0.01766 270.201   &lt;2e-16 ***\narea_to_volume_dam  0.01656    0.01205   1.374    0.169    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 4.594 on 68054 degrees of freedom\n  (17798 observations deleted due to missingness)\nMultiple R-squared:  2.775e-05, Adjusted R-squared:  1.306e-05 \nF-statistic: 1.889 on 1 and 68054 DF,  p-value: 0.1694\n\n\n\n\n\n10.5.2.4 Model mod.h3.4\nAdjusting for state in a linear mixed model offers more explanatory power: mod.h3.4 \\(R^2\\) = 0.47.\n\\[mod.h3.4: tri\\_mean_{dam} \\sim surfaceArea | state\\]\n\n\nShow the code\nmod.h3.4 &lt;- dta_for_model |&gt; # dams_with_tri |&gt;\n  mutate(tri_mean_dam_scaled = scale(tri_mean_dam),\n         surfaceArea_scaled = scale(surfaceArea)) |&gt;\n  lmer(tri_mean_dam_scaled ~ surfaceArea_scaled + state_abb + (1 | state_abb),\n     data = _)\n\nsummary(mod.h3.4)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_dam_scaled ~ surfaceArea_scaled + state_abb + (1 | state_abb)\n   Data: mutate(dta_for_model, tri_mean_dam_scaled = scale(tri_mean_dam),  \n    surfaceArea_scaled = scale(surfaceArea))\n\nREML criterion at convergence: 164361.2\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-4.7335 -0.4130 -0.0943  0.2242 14.5480 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 2.188    1.4791  \n Residual              0.642    0.8012  \nNumber of obs: 68544, groups:  state_abb, 48\n\nFixed effects:\n                    Estimate Std. Error t value\n(Intercept)        -0.796668   1.481781  -0.538\nsurfaceArea_scaled  0.002789   0.003069   0.909\nstate_abbFL         0.099150   2.093784   0.047\nstate_abbMI         0.180159   2.093794   0.086\nstate_abbLA         0.179884   2.093861   0.086\nstate_abbIL         0.215946   2.093869   0.103\nstate_abbMN         0.227510   2.093849   0.109\nstate_abbND         0.278619   2.093848   0.133\nstate_abbMS         0.330694   2.093680   0.158\nstate_abbTX         0.328485   2.093667   0.157\nstate_abbKS         0.375448   2.093718   0.179\nstate_abbWI         0.403496   2.093814   0.193\nstate_abbOK         0.450294   2.093675   0.215\nstate_abbNE         0.456201   2.093692   0.218\nstate_abbRI         0.488730   2.094362   0.233\nstate_abbIN         0.496939   2.093787   0.237\nstate_abbSD         0.428591   2.093932   0.205\nstate_abbSC         0.567741   2.093707   0.271\nstate_abbAL         0.490383   2.093927   0.234\nstate_abbIA         0.622551   2.093678   0.297\nstate_abbMO         0.643281   2.093668   0.307\nstate_abbGA         0.645353   2.093669   0.308\nstate_abbAR         0.698400   2.093835   0.334\nstate_abbNJ         0.702580   2.093838   0.336\nstate_abbOH         0.707544   2.093754   0.338\nstate_abbME         0.759280   2.093929   0.363\nstate_abbMD         0.789333   2.094073   0.377\nstate_abbMA         0.890187   2.093777   0.425\nstate_abbMT         1.635832   2.093938   0.781\nstate_abbTN         1.061460   2.093772   0.507\nstate_abbVA         1.209061   2.093725   0.577\nstate_abbCT         1.054984   2.093771   0.504\nstate_abbNC         1.180449   2.093691   0.564\nstate_abbWY         1.201428   2.093745   0.574\nstate_abbNM         1.202664   2.094142   0.574\nstate_abbNH         1.304317   2.093883   0.623\nstate_abbNY         1.440652   2.093724   0.688\nstate_abbNV         1.438821   2.093954   0.687\nstate_abbAZ         1.396055   2.094161   0.667\nstate_abbKY         1.226042   2.093805   0.586\nstate_abbPA         1.769214   2.093759   0.845\nstate_abbWA         1.945266   2.093863   0.929\nstate_abbID         1.958452   2.094050   0.935\nstate_abbVT         2.057331   2.094080   0.982\nstate_abbOR         2.149127   2.093846   1.026\nstate_abbCO         2.112241   2.093720   1.009\nstate_abbUT         3.774710   2.098016   1.799\nstate_abbCA         2.737416   2.093754   1.307\nstate_abbWV         3.009690   2.094024   1.437\n\n\nShow the code\nr_squared &lt;- rsq(mod.h3.4)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\n\n\n10.5.2.5 Model mod.h3.5\nA similar mod.h3.5 has slightly better results: \\(R^2\\) = 0.50.\n\\[mod.h3.5: tri\\_mean_{dam} \\sim nidstorage | state\\]\n\n\nShow the code\nmod.h3.5 &lt;- dta_for_model |&gt; # dams_with_tri |&gt;\n  mutate(tri_mean_dam_scaled = scale(tri_mean_dam),\n         nidStorage_scaled = scale(nidStorage)) |&gt;\n  lmer(tri_mean_dam_scaled ~ nidStorage_scaled + state_abb + (1 | state_abb),\n     data = _)\n\nsummary(mod.h3.5)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_dam_scaled ~ nidStorage_scaled + state_abb + (1 | state_abb)\n   Data: mutate(dta_for_model, tri_mean_dam_scaled = scale(tri_mean_dam),  \n    nidStorage_scaled = scale(nidStorage))\n\nREML criterion at convergence: 205879.3\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.5830 -0.4164 -0.1007  0.2139 14.4515 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 1.0557   1.0275  \n Residual              0.6551   0.8094  \nNumber of obs: 85156, groups:  state_abb, 48\n\nFixed effects:\n                   Estimate Std. Error t value\n(Intercept)       -0.795199   1.031310  -0.771\nnidStorage_scaled  0.014489   0.002777   5.217\nstate_abbFL        0.097349   1.455997   0.067\nstate_abbMI        0.174747   1.456007   0.120\nstate_abbLA        0.177532   1.456104   0.122\nstate_abbIL        0.206033   1.455927   0.142\nstate_abbMN        0.276087   1.455987   0.190\nstate_abbND        0.281396   1.456046   0.193\nstate_abbMS        0.327705   1.455821   0.225\nstate_abbTX        0.336124   1.455815   0.231\nstate_abbKS        0.374391   1.455885   0.257\nstate_abbWI        0.439131   1.456020   0.302\nstate_abbOK        0.450830   1.455830   0.310\nstate_abbNE        0.455028   1.455861   0.313\nstate_abbRI        0.489115   1.456835   0.336\nstate_abbIN        0.489100   1.455997   0.336\nstate_abbSD        0.511593   1.455873   0.351\nstate_abbSC        0.569573   1.455878   0.391\nstate_abbAL        0.610712   1.455888   0.419\nstate_abbIA        0.619730   1.455840   0.426\nstate_abbMO        0.640944   1.455826   0.440\nstate_abbGA        0.647461   1.455826   0.445\nstate_abbAR        0.680338   1.455964   0.467\nstate_abbNJ        0.703274   1.456079   0.483\nstate_abbOH        0.700364   1.455946   0.481\nstate_abbME        0.760266   1.456198   0.522\nstate_abbMD        0.788313   1.456366   0.541\nstate_abbMA        0.875513   1.455970   0.601\nstate_abbMT        0.909781   1.455860   0.625\nstate_abbTN        1.039303   1.455972   0.714\nstate_abbVA        1.045716   1.455868   0.718\nstate_abbCT        1.063890   1.456071   0.731\nstate_abbNC        1.143199   1.455853   0.785\nstate_abbWY        1.194106   1.455937   0.820\nstate_abbNM        1.257300   1.456361   0.863\nstate_abbNH        1.308047   1.456140   0.898\nstate_abbNY        1.425883   1.455907   0.979\nstate_abbNV        1.440460   1.456236   0.989\nstate_abbAZ        1.442600   1.456408   0.991\nstate_abbKY        1.502459   1.455997   1.032\nstate_abbPA        1.740860   1.455939   1.196\nstate_abbWA        1.903134   1.456070   1.307\nstate_abbID        1.951624   1.456384   1.340\nstate_abbVT        2.056167   1.456431   1.412\nstate_abbOR        2.064702   1.456049   1.418\nstate_abbCO        2.164664   1.455900   1.487\nstate_abbUT        2.636034   1.456060   1.810\nstate_abbCA        2.698780   1.455943   1.854\nstate_abbWV        3.194126   1.456265   2.193\n\n\nShow the code\nr_squared &lt;- rsq(mod.h3.5)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\n\n\n10.5.2.6 Model mod.h3.6\nThe model mod.h3.6 has some explanatory power. \\(R^2\\) = 0.42, however, it explains less variation than the two models above using surfaceArea and nidStorage as separate predictors.\n\\[mod.h3.6: tri\\_mean_{dam} \\sim ratio | state\\]\nwhere \\(ratio = \\frac{surfaceArea}{nidStorage}\\)\n\n\nShow the code\n# mod6 &lt;- dta_for_model |&gt;\n#   lmer(tri_mean_dam ~ area_to_volume_dam + (1 | state_abb),\n#      data = _)\n\nmod.h3.6 &lt;- dta_for_model |&gt;\n  mutate(tri_mean_dam_scaled = scale(tri_mean_dam),\n         area_to_volume_dam_scaled = scale(area_to_volume_dam)) |&gt;\n  lmer(tri_mean_dam_scaled ~ area_to_volume_dam_scaled + state_abb + (1 | state_abb),\n       data = _)\n\nsummary(mod.h3.6)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_dam_scaled ~ area_to_volume_dam_scaled + state_abb +  \n    (1 | state_abb)\n   Data: mutate(dta_for_model, tri_mean_dam_scaled = scale(tri_mean_dam),  \n    area_to_volume_dam_scaled = scale(area_to_volume_dam))\n\nREML criterion at convergence: 163453\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-4.7186 -0.4121 -0.0943  0.2231 14.5186 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 0.09228  0.3038  \n Residual              0.64444  0.8028  \nNumber of obs: 68056, groups:  state_abb, 48\n\nFixed effects:\n                           Estimate Std. Error t value\n(Intercept)               -0.796721   0.316759  -2.515\narea_to_volume_dam_scaled -0.003785   0.003079  -1.229\nstate_abbFL                0.099587   0.439578   0.227\nstate_abbMI                0.180016   0.439626   0.409\nstate_abbLA                0.180261   0.439945   0.410\nstate_abbIL                0.216103   0.439983   0.491\nstate_abbMN                0.228196   0.439884   0.519\nstate_abbND                0.278764   0.439882   0.634\nstate_abbMS                0.330563   0.439078   0.753\nstate_abbTX                0.328454   0.439016   0.748\nstate_abbKS                0.375324   0.439259   0.854\nstate_abbWI                0.404142   0.439719   0.919\nstate_abbOK                0.450162   0.439054   1.025\nstate_abbNE                0.456021   0.439135   1.038\nstate_abbRI                0.490155   0.442348   1.108\nstate_abbIN                0.498546   0.439601   1.134\nstate_abbSD                0.429141   0.440286   0.975\nstate_abbSC                0.567735   0.439206   1.293\nstate_abbAL                0.490743   0.440257   1.115\nstate_abbIA                0.622374   0.439067   1.417\nstate_abbMO                0.642044   0.439019   1.462\nstate_abbGA                0.645237   0.439027   1.470\nstate_abbAR                0.698930   0.439820   1.589\nstate_abbNJ                0.706553   0.439849   1.606\nstate_abbOH                0.707418   0.439434   1.610\nstate_abbME                0.761086   0.440273   1.729\nstate_abbMD                0.792350   0.441005   1.797\nstate_abbMA                0.890169   0.439544   2.025\nstate_abbMT                1.636419   0.440311   3.717\nstate_abbTN                1.061525   0.439520   2.415\nstate_abbVA                1.209035   0.439295   2.752\nstate_abbCT                1.064990   0.439820   2.421\nstate_abbNC                1.178392   0.439130   2.683\nstate_abbWY                1.201424   0.439391   2.734\nstate_abbNM                1.194106   0.441314   2.706\nstate_abbNH                1.304429   0.440049   2.964\nstate_abbNY                1.439915   0.439288   3.278\nstate_abbNV                1.440967   0.440390   3.272\nstate_abbAZ                1.396704   0.441372   3.164\nstate_abbKY                1.224942   0.439678   2.786\nstate_abbPA                1.768951   0.439457   4.025\nstate_abbWA                1.946315   0.439953   4.424\nstate_abbID                1.959219   0.440846   4.444\nstate_abbVT                2.057327   0.440986   4.665\nstate_abbOR                2.149651   0.439870   4.887\nstate_abbCO                2.111321   0.439268   4.806\nstate_abbUT                3.776444   0.459380   8.221\nstate_abbCA                2.737617   0.439431   6.230\nstate_abbWV                3.014099   0.440741   6.839\n\n\nShow the code\nr_squared &lt;- rsq(mod.h3.6)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\n\n\n10.5.2.7 Model mod.h3.7\nmod.h3.7 uses only state effects. \\(R^2\\) = 0.40.\n\n\nShow the code\nmod.h3.7 &lt;- dta_for_model |&gt;\n  mutate(tri_mean_dam_scaled = scale(tri_mean_dam)) |&gt;\n  lmer(tri_mean_dam_scaled ~  1 | state_abb,\n       data = _)\n\nsummary(mod.h3.7)\n\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: tri_mean_dam_scaled ~ 1 | state_abb\n   Data: mutate(dta_for_model, tri_mean_dam_scaled = scale(tri_mean_dam))\n\nREML criterion at convergence: 207681.1\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-3.5983 -0.4175 -0.1013  0.2144 14.4448 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n state_abb (Intercept) 0.5590   0.7477  \n Residual              0.6552   0.8095  \nNumber of obs: 85854, groups:  state_abb, 48\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept)   0.2026     0.1080   1.876\n\n\nShow the code\nr_squared &lt;- rsq(mod.h3.7)\n\nrsq_comment &lt;- glue(\n  \"r_squared: {round(r_squared$model, digits = 2)}\", \n     \"\\nconsisting of fixed effects: {round(r_squared$fixed, digits = 2)}\", \n     \" and random effects: {round(r_squared$random, digits = 2)}\"\n  )\n\n\n\n\n\n\n10.5.3 Conclusion: H3\nPlots re: \\(tri\\_mean_{dam}\\) are similar to those when using \\(tri\\_mean_{sample}\\) in Figure 10.16 above to explore \\(H_2\\). See Figure 10.19.\nThe near-vertical nature of the categories in the scatter plots indicate that there is no strong relationship between \\(tri\\_mean_{sample}\\) or \\(tri\\_mean_{dam}\\)) and either surfaceArea, nidStorage, or \\(surfaceArea::nidStorage\\).\nI explored seven regression models. None strenghen the case for \\(H_3\\).\nIn other words, \\(H_3\\) is not supported by the data.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#summary-insights-from-ruggedness",
    "href": "ruggedness.html#summary-insights-from-ruggedness",
    "title": "10  Terrain ruggedness",
    "section": "10.6 Summary: insights from ruggedness",
    "text": "10.6 Summary: insights from ruggedness\n\\(H_1\\) is the only one of the three hypotheses supported by the data–and that only on a qualified basis. In flatter regions it’s true that the areas around dams are more rugged than the median ruggedness. This is not true for mountainous regions, since dams are placed in valleys, which are flatter than the surrounding mountains. Additionally large dams create flatness by virtue of their lakes.\n\\(H_2\\) and \\(H_3\\) are disproved by the data. While surfaceArea and nidStorage are related (Figure 10.13), the ratio \\(surfaceArea::nidStorage\\) does not appear to have an association with ruggedness–either of the areas around dams (\\(tri\\_mean_{dam}\\)) or around random points in the state (\\(tri\\_mean_{sample}\\)).",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness.html#footnotes",
    "href": "ruggedness.html#footnotes",
    "title": "10  Terrain ruggedness",
    "section": "",
    "text": "And in the case of dams for mine tailings and waste products from coal-based electricity generation: other liquids and semi-liquids.↩︎\nWilson et al 2007, Multiscale Terrain Analysis of Multibeam Bathymetry Data for Habitat Mapping on the Continental Slope. Marine Geodesy 30:3-35. See also the original paper defining TRI by Riley, DeGloia, and Elliot (1999): A Terrain Ruggedness Index that Quantifies Topographic Heterogeneity. Authors: Shawn J. Riley, Stephen D. DeGloria, Robert Elliot. Intermountain Journal of Sciences, Vol. 5, No. 1-4, 1999. https://arc.lib.montana.edu/ojs/index.php/IJS/article/view/1794/1457 which is available for download from the Archives and Special Collections of Montana State University.↩︎\nhttps://www.earthdata.nasa.gov/data/instruments/srtm ↩︎\nSee https://geoservice.dlr.de/web/dataguide/srtm/ and https://gis.stackexchange.com/questions/110755/is-srtm-3-second-arc-free-of-non-terrain-features ↩︎\nhttps://en.wikipedia.org/wiki/List_of_extreme_points_of_the_United_States ↩︎",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness-preparing.html",
    "href": "ruggedness-preparing.html",
    "title": "11  Preparing terrain ruggedness",
    "section": "",
    "text": "11.1 Key assumptions and quantifications\nIt took some work to get the data ready for Chapter 10 Terrain ruggedness. This chapter is a commentary on that work and some of the questions I asked and trade offs I made along the way. It’s also the chapter that generates the data needed for that chapter.\nFirst, each chapter has a setup chunk that loads libraries and sets some constants (setup.R) and prepares the dam data (prepare-data-R). Below that are additional constants used in this chapter.",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Preparing terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness-preparing.html#key-assumptions-and-quantifications",
    "href": "ruggedness-preparing.html#key-assumptions-and-quantifications",
    "title": "11  Preparing terrain ruggedness",
    "section": "",
    "text": "11.1.1 Defining ruggedness\nI use terrain ruggedness index (TRI) as my measure of roughness. The terra::terrain() function does this for me using digital elevation model (DEM) data I downloaded and saved in GeoTIFF files. It uses eight-neighbor “classic” TRI per Wilson et al. (2007).1. From the terra::terrain() help:\n\n“TRI (Terrain Ruggedness Index) is the mean of the absolute differences between the value of a cell and its 8 surrounding cells.”].\n\nSee also the original paper defining TRI by Riley, DeGloia, and Elliot (1999)2 which is available for download from the Archives and Special Collections of Montana State University.\nTerrain ruggedness can be measured at various resolutions, and at finer resolutions vegetation and human-built structures can add significant noise to elevation values. For example, at pixel resolution ~100 m they likely are noticeable whereas at pixel resolution ~1000 m, in any non-flat area, this noise is a much smaller component of the differences in elevation. In any case, over many points, the noise likely cancels out (I hope!).\n\n\n11.1.2 Defining area around dam and calculating local roughness\nI define a circle of radius r = 5 km around each dam location, get the elevation raster for each circle, and calculate the TRI for all points in the circle. Then I can use the data individually and aggregated by state, region, nidHeight, etc.\n\n\n11.1.3 Defining an approach to compare local tri_mean at dams and random state locations\nFor each state in the continental USA:\n\nUse (A) dam point locations; or (B) get state boundaries and randomly sample the same number points as dams within each state\nGet the elevation raster for the circle around each point, at 5 km radius\nCompute the TRI for the points in each circle\nCompute summary stats (tri_mean_dam, tri_median_dam, tri_sd_dam, etc.) or (tri_mean_sample, tri_median_sample, tri_sd_sample, etc.) for each circle.\n\nIt seems likely that in some cases the circles will overlap. I think this is generally OK, because I am computing tri_mean for each circle, and every state has a lot of dams (and thus equivalent randomly sampled points).\nThen I look at the distribution of means of the sample. I order tri_mean_dam and tri_mean_sample values from smallest to largest for each state, then join them in a data frame, and evaluate the models \\[tri\\_mean_{state} \\sim tri\\_mean_{dam} + \\epsilon\\]\nas well as adjusting for state:\n\\[tri\\_mean_{state} \\sim tri\\_mean_{dam} | state + \\epsilon\\] I do this in Chapter 10 Terrain ruggedness.\n\n\n11.1.4 Selecting a resolution of the elevation data\nSince the state is the basic aggregation unit, I need state boundaries (state_boundaries_sf), which are conveniently provided by USAboundaries::us_states(). And since I sample random points and get the elevation of the points in a circle 5 km radius from each sample point, I need state boundaries that are 5 km inside the actual state boundaries (state_boundaries_smaller_sf).\n\n11.1.4.1 Resolution of elevation data varies by latitude\nIssue: the geographical area included in an elevation raster at a constant zoom level varies by latitude, so to compare states fairly, for each state I could (1) hold the number of pixels constant and cover more area at high latitudes (the default behavior as seen in Figure 11.4); or (2) hold the area constant and sacrifice some data at the lower latitudes. In the initial implementation, I accept the default behavior and may reconsider this topic later if it seems meaningful to do so.\nelevatr::get_elev_raster() help text includes the following re: zoom level:\n\nThe zoom ranges from 1 to 14 [or is it now 1..15; see Mapzen URL –Daniel]. Resolution of the resultant raster is determined by the zoom and latitude. For details on zoom and resolution see the documentation from Tilezen.\n\nFor latitudes in degrees, the Tilezen page offers this formula to determine meters per pixel:\n\\[ground\\_resolution = cos(latitude * \\frac{pi}{180}) \\frac{2 pi * 6378137 m}{256 * 2^{zoom\\_level}\\ pixel}\\]\nZoom = {7, 9} generates elevation rasters with a cell (a.k.a. pixel) resolution at three ranges of relevant latitudes (Table 11.1). Note that zoom level in elev_get_raster() is one off from the documentation.\n\n\nShow the code\nget_pixel_res &lt;-function(lat, zoom) {\n  cos(lat * pi/180) * 2 * pi * 6378137 / (256 * 2^(zoom+1)) # 6378137 meters\n}\n\nmid_lat_nc &lt;- mean(c(36.58812, 33.85111))\nlatitudes &lt;- c(49.4, mid_lat_nc, 24.5)\nzoom_level &lt;- c(7, 9)\ncomment = c(\"Northewest Angle Inlet, Lake of the Woods, MN\", \n              \"Middle latitude of NC\",\n              \"Ballast Key, FL\")\n\nres_df = tibble(\n  res_zoom = c(\n    map(7, \\(x) get_pixel_res(latitudes, x)),\n    map(9, \\(x) get_pixel_res(latitudes, x))\n  ) |&gt;\n    unlist(),\n  \n  cmt = rep(comment, 2)\n\n)\n\ntibble(\n  latitude = rep(latitudes, times = 2),\n  zoom = c(rep(7, 3), rep(9, 3)),\n  pixel_res_m = res_df$res_zoom,\n  comment = res_df$cmt\n) |&gt;\n  group_by(zoom) |&gt;\n  mutate(pct = pixel_res_m / min(pixel_res_m)) |&gt;\n  gt() |&gt;\n  tab_header(\n    md(glue(\"**Ground resolution per pixel at various latitudes**\",\n            \"&lt;br&gt;at zoom levels 7 and 9\"))) |&gt;\n  tab_source_note(\n    md(glue(\"*get_elev_raster() zoom level 9 seems to be equivalent to zoom level 10 in the docs\",\n       \" at &lt;https://github.com/tilezen/joerd/blob/master/docs/data-sources.md#what-is-the-ground-resolution&gt;*\"))) |&gt;\n  fmt_number(columns = c(latitude, pixel_res_m),\n             decimals = 1) |&gt;\n  fmt_percent(columns = pct,\n              decimals = 0)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nGround resolution per pixel at various latitudesat zoom levels 7 and 9\n\n\nlatitude\npixel_res_m\ncomment\npct\n\n\n\n\n7\n\n\n49.4\n397.9\nNorthewest Angle Inlet, Lake of the Woods, MN\n100%\n\n\n35.2\n499.6\nMiddle latitude of NC\n126%\n\n\n24.5\n556.4\nBallast Key, FL\n140%\n\n\n9\n\n\n49.4\n99.5\nNorthewest Angle Inlet, Lake of the Woods, MN\n100%\n\n\n35.2\n124.9\nMiddle latitude of NC\n126%\n\n\n24.5\n139.1\nBallast Key, FL\n140%\n\n\n\nget_elev_raster() zoom level 9 seems to be equivalent to zoom level 10 in the docs at https://github.com/tilezen/joerd/blob/master/docs/data-sources.md#what-is-the-ground-resolution\n\n\n\n\n\n\n\n\n\nTable 11.1: Exploring elevation pixel resolution\n\n\n\n\n\n\n\n11.1.4.2 In summary: zoom = 9\nSince I’m interested in the local roughness around the dams, I use zoom level 9 data to get ~120 m resolution in elevation in the mid latitudes corresponding to the middle of North Carolina.\nZoom level 9 creates enough data already:\n\n\nShow the code\nfname &lt;- here(\"data/processed/test-res-nc-z07.tif\")\nif(!file_exists(fname)) {\n  nc_z7 &lt;- rast(here(\"data/processed/state-elevation-zoom7/NC.tif\")) |&gt;\n    project(\"epsg:5070\")\n    writeRaster(nc_z7, fname, overwrite = TRUE)\n} else {\n  nc_z7 &lt;- rast(here(\"data/processed/test-res-nc-z07.tif\"))\n}\n\nfname &lt;- here(\"data/processed/test-res-nc-z08.tif\")\nif(!file_exists(fname)) {\n  nc_z8 &lt;- elevatr::get_elev_raster(nc_boundary, z = 8) |&gt;\n    rast() |&gt;\n    project(\"epsg:5070\")\n  writeRaster(nc_z8, fname, overwrite = TRUE)\n} else {\n  nc_z8 &lt;- rast(fname)\n}\n\nfname &lt;- here(\"data/processed/test-res-nc-z09.tif\")\nif(!file_exists(fname)) {\n  nc_z9 &lt;- elevatr::get_elev_raster(nc_boundary, z = 9) |&gt;\n    rast() |&gt;\n    project(\"epsg:5070\")\n  writeRaster(nc_z9, fname, overwrite = TRUE)\n} else {\n  nc_z9 &lt;- rast(fname)\n}\n\nfname &lt;- here(\"data/processed/test-res-nc-z10.tif\")\nif(!file_exists(fname)) {\n  nc_z10 &lt;- rast(here(\"data/processed/state-elevation-zoom10/NC.tif\")) |&gt;\n    project(\"epsg:5070\")\n  writeRaster(nc_z10, fname, overwrite = TRUE)\n} else {\n  nc_z10 &lt;- rast(fname)\n}\n\nzoom_level_comparison &lt;- tribble(\n  ~zoom_level,  ~resolution_m,      ~n_points,                    ~filesize,\n  7,            res(nc_z7)[1],      ncol(nc_z7) * nrow(nc_z7),    file_size(here(\"data/processed/test-res-nc-z07.tif\")),\n  8,            res(nc_z8)[1],      ncol(nc_z8) * nrow(nc_z8),    file_size(here(\"data/processed/test-res-nc-z08.tif\")),\n  9,            res(nc_z9)[1],      ncol(nc_z9) * nrow(nc_z9),    file_size(here(\"data/processed/test-res-nc-z09.tif\")),\n  10,           res(nc_z10)[1],     ncol(nc_z10) * nrow(nc_z10),  file_size(here(\"data/processed/test-res-nc-z10.tif\"))\n)\n\ngt(zoom_level_comparison) |&gt;\n  tab_header(md(\"**elevatr::get_elev_raster() zoom levels**&lt;br&gt;in North Carolina elevation GeoTIFF\")) |&gt;\n  tab_source_note(\n    md(glue(\"Note elevatr zoom level is equivalent to one higher in documentation at\", \n            \" &lt;https://github.com/tilezen/joerd/blob/master/docs/data-sources.md#what-is-the-ground-resolution&gt;\")\n    )\n  ) |&gt;\n  fmt_number(columns = resolution_m,\n             decimals = 1) |&gt;\n  fmt_number_si(columns = n_points,\n                decimals = 0) |&gt;\n  fmt_number_si(columns = filesize,\n                decimals = 1) |&gt;\n  cols_align(columns = filesize,\n             align = \"right\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nelevatr::get_elev_raster() zoom levelsin North Carolina elevation GeoTIFF\n\n\nzoom_level\nresolution_m\nn_points\nfilesize\n\n\n\n\n7\n475.5\n2 M\n3.1 M\n\n\n8\n247.8\n10 M\n33.0 M\n\n\n9\n123.8\n30 M\n82.4 M\n\n\n10\n61.8\n98 M\n139.5 M\n\n\n\nNote elevatr zoom level is equivalent to one higher in documentation at https://github.com/tilezen/joerd/blob/master/docs/data-sources.md#what-is-the-ground-resolution\n\n\n\n\n\n\n\n\n\n\n\n11.1.4.3 Data from elevatr::get_elev_raster() and its source\nI get elevation data from elevatr::get_elev_raster() at zoom = 9, which returns SRTM3 data from Open Topography. Its digital elevation model (DEM) has a range over continental North America south of 60° N latitude. This range is fine, since the northernmost point in the continental USA is the Northwest Angle Inlet in Lake of the Woods, MN at 49.4°)4.\nThe Shuttle Radar Topography Mission (SRTM)’s Digital Elevation Model (DEM) is a Digital Surface Model (DSM) rather than a Digital Terrain Model (DTM). In other words, the radar reflections used to calculate elevations in some cases are from the tops of buildings and partway through the tree canopy; elevation values have not been adjusted to estimate ground level.5",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Preparing terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness-preparing.html#implementation",
    "href": "ruggedness-preparing.html#implementation",
    "title": "11  Preparing terrain ruggedness",
    "section": "11.2 Implementation",
    "text": "11.2 Implementation\n\n11.2.1 Getting state boundaries and elevations\nSince I sample a lot of points, it’s worth downloading state elevation data and reusing it. It takes a while and some disk space. I save the TRI data for each state as a GeoTIFF file.\n\n\nShow the code\nstate_boundaries_smaller_sf &lt;- state_boundaries_sf |&gt; # shrink borders a little to make future sampling \"safe\"\n  st_transform(crs_m) |&gt; # change to meter-based CRS to make the st_buffer(dist=) easier\n  st_buffer(dist = -5000) |&gt; # 5 km\n  st_transform(\"NAD83\") # change back\n\nnc_boundary &lt;- state_boundaries_sf |&gt;\n  filter(state_abb == \"NC\")\n\n###### Get Blue Ridge Parkway multiline\n\nfname &lt;- here(\"data/processed/blue-ridge-parkway.rds\")\nif(!file.exists(fname)) {\n  \n  results &lt;- st_bbox(nc_boundary) |&gt;\n    opq() %&gt;%\n    add_osm_feature(key = \"name\", \n                    value = \"Blue Ridge Parkway\") %&gt;%\n    osmdata_sf()\n  \n  parkway_lines &lt;- results$osm_multilines |&gt;\n    st_transform(\"NAD83\")\n  \n  parkway_lines_nc &lt;- st_intersection(parkway_lines, nc_boundary)\n  \n  write_rds(parkway_lines_nc, fname)\n  \n} else {\n  \n  parkway_lines_nc &lt;- read_rds(fname)\n  \n}\n\n\n\n\nShow the code\n# Note: this becomes more expensive in time and disk space for higher zoom levels\n\n###### Create elevation files for each state\n\nif(!dir_exists(state_elevation_fname_root)) {\n  \n  dir_create(state_elevation_fname_root)\n  \n}\n\nstate_boundaries_for_elevation_sf &lt;- state_boundaries_sf |&gt;\n  mutate(fname = paste0(state_elevation_fname_root, state_abb, \".tif\"))\n\nfor(i in seq_len(nrow(state_boundaries_for_elevation_sf))) {\n  \n  if(!file.exists(state_boundaries_for_elevation_sf$fname[i])) {\n    \n    ###### get elevation data for each state and save each as separate GeoTIFF file\n    \n    for(i in seq_len(nrow(state_boundaries_for_elevation_sf))) {\n      if(!file.exists(state_boundaries_for_elevation_sf$fname[[i]])) {\n        elev &lt;- \n          rast(\n            get_elev_raster(\n              locations = state_boundaries_for_elevation_sf |&gt;\n                filter(state_abb == state_boundaries_for_elevation_sf$state_abb[[i]]) |&gt;\n                st_buffer(dist = 0.05), # ~5 km at lat of Pennsylvania \n                                        # (to make sure we get all area in the state--can crop later)\n              prj = \"NAD83\",\n              z = my_zoom,\n              clip = \"locations\",\n              verbose = \"FALSE\")\n          )\n        \n        terra::writeRaster(x = elev,\n                           filename = state_boundaries_for_elevation_sf$fname[[i]],\n                           overwrite = TRUE,\n                           datatype = 'INT2S'\n        )\n        \n      }\n    } \n  }\n}\n\n\nIf they didn’t already exist, I just created and saved elevation files for each state in ./data/processed/state-elevation-zoom9/ .\nA plot of the elevation for North Carolina (Figure 11.1) shows I am on track.\n\n\nShow the code\n###### Parkway multiline\n\nfname &lt;- here(\"data/processed/blue-ridge-parkway.rds\")\n\nif(!file.exists(fname)) {\n\n  results &lt;- st_bbox(nc_boundary) |&gt;\n    opq() %&gt;%\n    add_osm_feature(key = \"name\",\n                    value = \"Blue Ridge Parkway\") %&gt;%\n    osmdata_sf()\n\n  parkway_lines &lt;- results$osm_multilines |&gt;\n    st_transform(\"NAD83\")\n\n  parkway_lines_nc &lt;- st_intersection(parkway_lines, nc_boundary)\n\n  write_rds(parkway_lines_nc, fname)\n\n} else {\n\n  parkway_lines_nc &lt;- read_rds(fname)\n\n}\n\n###### NC elevation\n\nnc_elevation &lt;- mask(\n  rast(paste0(state_elevation_fname_root, \"NC\", \".tif\")),\n  nc_boundary\n)\nnames(nc_elevation) &lt;- \"elevation\"\n\nnc_elevation_m &lt;- project(nc_elevation, \"EPSG:5070\")\nnc_elev_res_m &lt;- res(nc_elevation_m)\n\n\n\n\nShow the code\nggplot() +\n  geom_spatraster(data = nc_elevation,\n          na.rm = TRUE) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"darkgrey\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\") +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE)) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    title = \"North Carolina elevation\",\n    subtitle = glue(\"Elevation data via elevatr::get_elev_raster() with data from Mapzen Terrain Tiles\"),\n    caption = my_caption_opentopography,\n    fill = \"Elevation\\n(meters)\"\n  )\n\n\n\n\n\n\n\n\nFigure 11.1: Elevation data - North Carolina\n\n\n\n\n\n\n\n\n11.2.2 Local elevation data and TRI cacluations around dams\nIn this section I create TRI summary statistics for the circles around dams (if they don’t already exist), saving them in the file system. I use these TRI summary stat files below and in Chapter 10 Terrain ruggedness.\n\n\nShow the code\nif(!dir.exists(state_dam_tri_summary_pname)) {\n  dir.create(state_dam_tri_summary_pname)\n}\n\nget_tri_values &lt;- function(my_dam) {\n  # input: sf with one dam (geometry is one POINT)\n  # output: vector of TRI values (real numbers only)\n  \n  # TEST\n  # my_dam &lt;- dams |&gt;\n  #   select(nidId, state_abb, geom) |&gt;\n  #   filter(state_abb == \"NC\") |&gt;\n  #   head(1)\n  \n  crs_current &lt;- st_crs(my_dam)\n  circle_sf &lt;- my_dam |&gt; \n    st_transform(crs_m) |&gt;    # need projection in meters for st_buffer()\n    st_buffer(dist = 5000) |&gt; # meters (circle with diameter of 10 km)\n    st_transform(crs_current)     # back to usual projection\n  \n  circle_v &lt;- vect(circle_sf)\n  state_cropped &lt;- crop(my_state, circle_v) # performance benefit before mask(); supplied by env outside get_tri_values()\n  circle_elev &lt;- mask(state_cropped, circle_v)\n  circle_tri &lt;- terrain(circle_elev,\n                        v = \"TRI\")\n  \n  circle_tri_values &lt;- values(circle_tri) %&gt;%\n    subset(is.finite(.)) |&gt;\n    as.vector()\n  \n  circle_tri_values\n  \n}\n\nstates_with_dams &lt;- sort(unique(dams$state_abb))\n\nfor(i in seq_len(length(states_with_dams))) {\n  \n  state_dam_tri_summary_fname &lt;- paste0(state_dam_tri_summary_pname, \"/\", states_with_dams[i], \".rds\")\n  \n  if(!file.exists(state_dam_tri_summary_fname)) {\n    \n    dams_one_state &lt;- dams |&gt;\n      filter(state_abb == states_with_dams[i]) |&gt;\n      select(nidId, state_abb, geom)\n    \n    my_state &lt;- rast(paste0(state_elevation_fname_root, states_with_dams[i], \".tif\"))\n  \n    tri = map(seq_len(nrow(dams_one_state)), \n              ~ get_tri_values(dams_one_state[.x, ]), get_tri_values)\n    \n    dams_one_state$tri &lt;- tri\n    \n    dams_one_state_tri_summary &lt;- dams_one_state |&gt;\n      st_drop_geometry() |&gt;\n      unnest(tri) |&gt;\n      reframe(tri_n = n(),\n              tri_mean = mean(tri),\n              tri_median = median(tri),\n              tri_sd = sd(tri),\n              .by = c(nidId, state_abb))\n    \n    write_rds(dams_one_state_tri_summary, state_dam_tri_summary_fname)\n    \n  } else {\n    # do nothing (since file exists, go to next state)\n  }\n  \n}\n\nstates_and_regions &lt;- tibble(\n  state_region = state.region,\n  state_abb = state.abb) |&gt;\n  filter(state_abb %in% states_with_dams) |&gt;\n  mutate(n_states = n(),\n         region_label = glue(\"{state_region} (n={n_states})\"),\n         .by = state_region)\n\nstate_dam_tri_summary_df &lt;- map(dir(state_dam_tri_summary_pname,\n                                    full.names = TRUE), read_rds) |&gt;\n  bind_rows() |&gt;\n  left_join(\n    states_and_regions,\n    by = \"state_abb\"\n  ) |&gt;\n  rename(tri_n_dam = tri_n,\n         tri_mean_dam = tri_mean,\n         tri_median_dam = tri_median,\n         tri_sd_dam = tri_sd)\n\ndams_with_tri &lt;- dams |&gt;\n  inner_join(state_dam_tri_summary_df |&gt;\n               select(-c(state_region:region_label)),\n             by = join_by(nidId, state_abb)) |&gt;\n  filter(nidHeightId != \"Undetermined\")\n\nn_dams_with_tri &lt;- state_dam_tri_summary_df |&gt;\n  nrow()\n\n\nIf they didn’t already exist, I just created and saved TRI summary statistics for local areas around dams for each state in ./data/processed/state-dam-tri-summary-zoom9 .\n\n\n\n11.2.3 Local elevation data and TRI cacluations around random points\nIn this section (if they don’t already exist) I create TRI summary statistics for the circles around the same number of random points per state as there are dams, saving them in the file system. I use these TRI summary stat files below and in Chapter 10 Terrain ruggedness.\n\n\nShow the code\n# NOTE: this takes quite a while to run if the files don't exist in state_tri_circle_samples_pname\n\nif(!dir.exists(state_tri_circle_samples_pname)) {\n  dir.create(state_tri_circle_samples_pname)\n}\n\nget_state_tri_values &lt;- function(my_point) {\n  # input:  sf with one point for one state (geometry is one POINT)\n  # output: vector of TRI values (real numbers only)\n  \n  # TEST\n  # my_point &lt;- state_point_sample_sf\n  #   filter(state_abb == \"NC\") |&gt;\n  #   head(1)\n  \n  crs_current &lt;- crs(my_point)\n  circle_sf &lt;- my_point |&gt; \n    st_transform(crs_m) |&gt;    # need projection in meters for st_buffer()\n    st_buffer(dist = 5000) |&gt; # meters (circle with diameter of 10 km)\n    st_transform(crs_current)     # back to usual projection\n  \n  circle_v &lt;- vect(circle_sf)\n  my_state &lt;- rast(paste0(state_elevation_fname_root, my_point$state_abb, \".tif\"))\n  state_cropped &lt;- crop(my_state, circle_v) # performance benefit before mask()\n  circle_elev &lt;- mask(state_cropped, circle_v)\n  circle_tri &lt;- terrain(circle_elev,\n                        v = \"TRI\")\n  \n  circle_tri_values &lt;- values(circle_tri) %&gt;%\n    subset(is.finite(.)) |&gt;\n    as.vector()\n  \n  circle_tri_values\n  \n}\n\n####### Create the same number of random points as there are dams in the state\n# Get sample points for all states\n# Using a shrunken state boundary, sample the same number of points as there are dams in the state\n\nset.seed(my_seed)\nn_samples_per_state_df &lt;- dams_no_geo |&gt;\n  count(state_abb, name = \"n_dams\")\n\nstate_point_sample_tmp &lt;- tibble(state_abb = \"\")\n  \nfor(i in seq_len(nrow(n_samples_per_state_df))) {\n  \n  one_state &lt;- n_samples_per_state_df[i, ]\n  one_state_points_sample_df &lt;- state_boundaries_smaller_sf |&gt;\n    filter(state_abb == one_state$state_abb) |&gt;\n    st_sample(one_state$n_dams) |&gt;\n    st_as_sf() |&gt;\n    mutate(state_abb = one_state$state_abb)\n  \n  state_point_sample_tmp &lt;- bind_rows(state_point_sample_tmp, one_state_points_sample_df)\n  \n}\n\nstate_point_sample_sf &lt;- state_point_sample_tmp |&gt;\n  filter(state_abb != \"\") |&gt;\n  rename(geometry = x) |&gt;\n  st_as_sf(crs = \"NAD83\") |&gt;\n  mutate(idx = row_number(),\n         sample_id = paste0(state_abb, str_pad(idx, width = 5, side = \"left\", pad = \"0\")),\n         .by = state_abb)\n\n# TEST\n# plot(state_point_sample_sf)\n\n\n###### Get elevation filenames\n\nls_state_elevation_files &lt;- function(path = state_elevation_fname_root) {\n    \n    tibble(\n      pname = dir_ls(path),\n      fname = dir(path)\n    ) |&gt;\n      mutate(state_abb = str_extract(fname, \"[[:alpha:]]{2}\")) |&gt;\n      select(pname, fname, state_abb)\n    \n  }\n  \nstate_elevation_files &lt;- ls_state_elevation_files()\n\n\n###### Get TRI values around each sampled point\n\nstates_with_points &lt;- sort(unique(state_point_sample_sf$state_abb))\n\nfor(i in seq_len(length(states_with_points))) {\n  \n  state_tri_circle_samples_fname &lt;- paste0(state_tri_circle_samples_pname, \"/\", states_with_points[i], \".rds\")\n  \n  if(!file.exists(state_tri_circle_samples_fname)) {\n    \n    points_one_state &lt;- state_point_sample_sf |&gt;\n      filter(state_abb == states_with_points[i])\n    \n    tri = map(seq_len(nrow(points_one_state)),\n              \\(x) get_state_tri_values(points_one_state[x, ]))\n    \n    points_one_state$tri &lt;- tri\n    \n    points_one_state_tri_summary &lt;- points_one_state |&gt;\n      st_drop_geometry() |&gt;\n      unnest(tri) |&gt;\n      reframe(tri_n = n(),\n              tri_mean = mean(tri),\n              tri_median = median(tri),\n              tri_sd = sd(tri),\n              .by = c(sample_id, state_abb)\n              )\n    \n    write_rds(points_one_state_tri_summary, state_tri_circle_samples_fname)\n    \n  } else {\n    # do nothing (since file exists, go to next state)\n  }\n  \n}\n\n\n\n\nShow the code\nstate_samples_tri_summary_df &lt;- map(dir(state_tri_circle_samples_pname,\n                                    full.names = TRUE), read_rds) |&gt;\n  bind_rows() |&gt;\n  left_join(\n    states_and_regions,\n    by = \"state_abb\"\n  ) |&gt;\n  rename(tri_n_sample = tri_n,\n         tri_mean_sample = tri_mean,\n         tri_median_sample = tri_median,\n         tri_sd_sample = tri_sd)\n\n\nIf they didn’t already exist, I just created and saved TRI summary statistics for local areas around random points in each state in ./data/processed/state-circle-tri-samples-zoom9 .\nThe maps below (Figure 11.2) show mean Terrain Ruggedness Index (TRI) (panel A) and standard deviation of the TRI (panel B) by state. Panel A is a good reminder that West Virginia is quite mountainous.\n\n\nShow the code\ndta_for_plot &lt;- \n  left_join(state_boundaries_sf,\n            state_samples_tri_summary_df |&gt;\n              reframe(mean_tri_mean_sample = mean(tri_mean_sample),\n                      mean_tri_median_sample = mean(tri_median_sample),\n                      mean_tri_sd_sample = sd(tri_sd_sample),\n                      .by = state_abb\n              ),\n            by = \"state_abb\"\n  ) |&gt;\n  select(state_abb, mean_tri_mean_sample, mean_tri_median_sample, mean_tri_sd_sample, geometry)\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_sf(aes(fill = mean_tri_mean_sample),\n          color = \"black\",\n          alpha = 0.8) +\n  scale_fill_gradient(low = \"lightblue\",\n                      high = \"firebrick\") +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE)) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.9, 0.3)) +\n  labs(\n    subtitle = \"A. Mean TRI. States with the largest proportion of the area being mountainous have highest mean TRI.\",\n    fill = \"TRI mean\"\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_sf(aes(fill = mean_tri_sd_sample),\n          color = \"black\",\n          alpha = 0.8) +\n  scale_fill_gradient(low = \"lightblue\",\n                      high = \"firebrick\") +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE)) +\n  theme(axis.text = element_blank(),\n        axis.ticks = element_blank(),\n        axis.title = element_blank(),\n        legend.position.inside = c(0.9, 0.3)) +\n  labs(\n    subtitle = \"B. TRI standard deviation. States with large areas that are flat and mountainous have highest standard deviation.\",\n    fill = \"TRI\\nstandard\\ndeviation\"\n  )\n\np1 / p2 + \n  plot_annotation(\n    title = \"Terrain Ruggedness Index (TRI) by state\",\n    subtitle = glue(\"Calculated from elevation circles around randomly selected points in each state,\",\n                    \" matching the number of dams.\"),\n    caption = my_caption_opentopography,\n  )\n\n\n\n\n\n\n\n\nFigure 11.2: Mean Terrain Ruggedness Index (TRI) by state\n\n\n\n\n\n\nLooking at the distribution of summary statistics values tri_median, tri_mean and tri_sd in Figure 11.3: their ECDF curves look quite similar, which makes sense given the definition of the terrain ruggedness index.\n\n\nShow the code\nstate_samples_tri_summary_df |&gt; \n  pivot_longer(cols = starts_with(\"tri_\"),\n              names_to = \"metric\",\n              values_to = \"value\") |&gt;\n  mutate(metric = factor(metric, levels = c(\"tri_median_sample\", \"tri_mean_sample\", \"tri_sd_sample\", \"tri_n_sample\"))) |&gt;\n  ggplot() +\n  stat_ecdf(aes(value)) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  scale_y_continuous(labels = label_percent()) +\n  facet_wrap(~metric, scales = \"free_x\") +\n  labs(\n    title = \"Terrain Ruggedness Index (TRI) data - summary stats\",\n    subtitle = glue(\"ECDF of summary stats for states in the continental USA.\",\n                    \" tri_n_sample is number of tri values in circle.\"),\n    x = NULL,\n    y = \"Percent of samples\",\n    caption = my_caption_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.3: Terrain Ruggedness Index (TRI) data - summary stats\n\n\n\n\n\n\nBut why is there so much variation in the number of points in the samples (tri_n) in Figure 11.3?\nBecause the earth is roughly a sphere, and the resolution of points is higher as latitude increases (Figure 11.4). Each arc in the plot below is one or more states.\n\n\nShow the code\ndta_for_plot &lt;- bind_cols(\n  dams_with_tri |&gt;\n    select(nidId, tri_n_dam),\n  st_coordinates(dams_with_tri, geometry)\n) |&gt;\n  clean_names()\n\ndta_for_plot |&gt; \n  ggplot() +\n  geom_jitter(aes(tri_n_dam, y),\n              size = 0.25,\n              alpha = 0.25) +\n  labs(\n    title = \"The number of points in cicles of same size\\n centered on dams increases with latitude\",\n    subtitle = \"Each arc is one or more state's circles.\",\n    x = \"Number of points in circle\",\n    y = \"Latitude\",\n    caption = my_caption_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.4: Effect of latitude on number of points in a circle of constant radius\n\n\n\n\n\n\ntri_mean_sample values are strongly correlated with high tri_sd_sample standard deviations. That makes sense, given the definition of TRI.\n\n\nShow the code\nmod &lt;- lm(tri_sd_sample ~ tri_mean_sample,\n          data = state_samples_tri_summary_df)\nr2 &lt;- glance(mod) |&gt;\n  select(adj.r.squared)\n\nmod_gam &lt;- mgcv::gam(tri_sd_sample ~ s(tri_mean_sample, bs = \"cs\"),\n                     data = state_samples_tri_summary_df)\nr2_gam &lt;- glance(mod_gam) |&gt;\n  select(adj.r.squared)\n\nstate_samples_tri_summary_df |&gt; \n  ggplot(aes(tri_mean_sample, tri_sd_sample)) +\n  geom_point(size = 0.25,\n             alpha = 0.5) +\n  geom_smooth(method = \"lm\", \n              formula = 'y ~ x',\n              se = FALSE) +\n  geom_smooth(method = 'gam',\n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"firebrick\") +\n  annotate(\"text\", x = I(0.1), y = I(0.9),\n           label = glue(\"Adjusted R2 = {round(r2, digits = 2)} (straight line)\"),\n           hjust = 0,\n           color = \"blue\") +\n  annotate(\"text\", x = I(0.1), y = I(0.85),\n           label = glue(\"Adjusted R2 = {round(r2_gam, digits = 2)} (spline)\"),\n           hjust = 0,\n           color = \"firebrick\") +\n  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +\n  labs(\n    title = \"State samples with high mean TRI also have\\nhigh standard deviation\",\n    subtitle = glue(\"Continental US states\"),\n    caption = my_caption_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.5: Terrain Ruggedness Index (TRI) std dev by mean",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Preparing terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness-preparing.html#tri-in-north-carolina",
    "href": "ruggedness-preparing.html#tri-in-north-carolina",
    "title": "11  Preparing terrain ruggedness",
    "section": "11.3 TRI in North Carolina",
    "text": "11.3 TRI in North Carolina\n\n11.3.1 Relationship between tri_meandam and nidHeight in local areas around dams in NC\nUsing TRI threshold values I selected through manual inspection of maps…\n\n\nShow the code\nthreshold_coastal = 1.5 \nthreshold_piedmont = 8 \n\nnc_dams_with_tri &lt;- dams |&gt;\n  inner_join(state_dam_tri_summary_df,\n             by = join_by(nidId, state_abb)) |&gt;\n  filter(state_abb == \"NC\",\n         nidHeightId != \"Undetermined\") |&gt;\n  mutate(est_region = case_when(\n    tri_mean_dam &lt; threshold_coastal      ~ \"3. Coastal\",\n    tri_mean_dam &lt; threshold_piedmont     ~ \"2. Piedmont\",\n    .default = \"1. Mountains\"\n  ))\n\nnc_n_dams_with_tri = nrow(nc_dams_with_tri)\n\np1 &lt;- nc_dams_with_tri |&gt;\n  ggplot() +\n  stat_ecdf(aes(tri_mean_dam),\n            geom = \"line\",\n            linewidth = 0.5,\n            alpha = 0.5,\n            pad = FALSE\n  ) +\n  geom_vline(xintercept = c(threshold_coastal, threshold_piedmont),\n             lty = 2,\n             linewidth = 0.25,\n             alpha = 0.5\n             ) +\n  scale_y_continuous(labels = label_percent()) +\n  labs(\n    subtitle = \"A. Mean values\",\n    y = \"Percent of dams\"\n  )\n\np2 &lt;- nc_dams_with_tri |&gt;\n  ggplot() +\n  stat_ecdf(aes(tri_median_dam),\n            geom = \"line\",\n            linewidth = 0.5,\n            alpha = 0.5,\n            pad = FALSE\n  ) +\n  geom_vline(xintercept = c(threshold_coastal, threshold_piedmont),\n             lty = 2,\n             linewidth = 0.25,\n             alpha = 0.5\n             ) +\n  scale_y_continuous(labels = label_percent()) +\n  labs(\n    subtitle = \"B. Median values\",\n    y = \"Percent of dams\"\n  )\n\np3a &lt;- nc_dams_with_tri |&gt;\n  ggplot(aes(tri_mean_dam, tri_sd_dam,\n             color = est_region)) +\n  geom_point(size = 0.5,\n             alpha = 0.5\n  ) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"white\",\n              linewidth = 1.5) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"grey40\") +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\")) +\n  # guides(color = guide_legend(override.aes = list(size = 3))) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"C: Std dev by mean\",\n    color = \"Predicted\\nNC region\"\n  )\n\np3b &lt;- nc_dams_with_tri |&gt;\n  ggplot(aes(tri_mean_dam, tri_sd_dam,\n             color = est_region)) +\n  geom_point(size = 0.5,\n             alpha = 0.5\n  ) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"white\",\n              linewidth = 1.5) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\")) +\n  guides(color = \"none\") +\n  facet_wrap(~est_region, scales = \"free\") +\n  labs(\n    subtitle = \"D: Std dev by mean (X and Y axis scale varies)\",\n    color = \"Predicted\\nNC region\"\n  )\n\n(p1 + p2 + p3a) / p3b +\n  plot_annotation(\n    title = \"TRI summary stats in areas around dams in NC\",\n    subtitle = glue(\"{nc_n_dams_with_tri} circles with radius of 5 km.\",\n                    \" tri_mean&lt;sub&gt;dam&lt;/sub&gt; thresholds: mountain &gt; {threshold_piedmont}; piedmont; {threshold_coastal} &gt; coastal.\"),\n    caption = my_caption_opentopography\n  ) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 11.6: TRI summary stats in areas around dams in NC\n\n\n\n\n\n\n\n\nShow the code\npA1 &lt;- nc_dams_with_tri |&gt;\n  ggplot(aes(nidHeight, tri_mean_dam,\n             color = nidHeightId)) +\n  geom_point(size = 0.5,\n             alpha = 0.5\n  ) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"white\",\n              linewidth = 1.5) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"grey40\") +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"A: tri_mean&lt;sub&gt;dam&lt;/sub&gt; by nidHeight&lt;br&gt;\"\n  )\n\npB &lt;- nc_dams_with_tri |&gt;\n  ggplot() +\n  stat_ecdf(aes(tri_mean_dam, color = nidHeightId),\n            geom = \"line\",\n            linewidth = 0.5,\n            alpha = 0.75,\n            pad = FALSE\n  ) +\n  scale_y_continuous(labels = label_percent()) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  labs(\n    subtitle = \"B. tri_mean&lt;sub&gt;dam&lt;/sub&gt; ECDF by nidHeightID&lt;br&gt;\",\n    y = \"Percent of dams\"\n  )\n  \npC &lt;- nc_dams_with_tri |&gt;\n  ggplot(aes(nidHeight, tri_mean_dam,\n             color = nidHeightId)) +\n  geom_point(size = 0.5,\n             alpha = 0.5\n  ) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE,\n              color = \"white\",\n              linewidth = 1.5) +\n  geom_smooth(method = 'gam', \n              formula = y ~ s(x, bs = \"cs\"),\n              se = FALSE) +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\", \"skyblue\")) +\n  guides(color = \"none\") +\n  facet_wrap(~nidHeightId, scales = \"free\") +\n  labs(\n    subtitle = \"C: tri_mean&lt;sub&gt;dam&lt;/sub&gt; by nidHeight (X and Y axis scale varies)&lt;br&gt;\"\n  )\n\nmy_layout &lt;- \nc(\"\nAACC\nBBCC\"\n)\n\n(pA1 / pB) + pC + \n  plot_annotation(\n    title = glue(\"There is a weak, non-linear relationship between nidHeight\\nand tri_mean&lt;sub&gt;dam&lt;/sub&gt;\", \n                 \" in local area around dams in NC\"),\n    subtitle = glue(\"{nc_n_dams_with_tri} circles with radius of 5 km.\"),\n    caption = my_caption_opentopography\n  ) + \n  plot_layout(design = my_layout) &\n  theme(plot.title = element_textbox_simple(),\n        plot.subtitle = element_textbox_simple())\n\n\n\n\n\n\n\n\nFigure 11.7: Local areas around North Carolina dams: TRI summary stats - by nidHeight\n\n\n\n\n\n\n\n\n11.3.2 Predicting NC regions from TRI values\nTerrain ruggedness index (TRI) is a useful way to predict the three main geographical land regions in North Carolina: the Blue Ridge mountains in the west, the rolling hills of the Piedmont in the middle, and the coastal plain in the east.\n\n\nShow the code\n# ###### NC TRI spatRaster and values as data.frame\n\nnc_tri &lt;- terrain(\n      x = nc_elevation,\n      v = \"TRI\")\nnc_tri[nc_tri &gt; 150] &lt;- NA # remove four outliers\n\nnc_tri_values &lt;- values(nc_tri) %&gt;%\n  subset(is.finite(.)) |&gt;\n  data.frame()\n\n\nI use TRI values for the whole state: 7,636,743 points.\nIn Figure 11.8 and other plots below, the red line below is the Blue Ridge Parkway, which in the northern half of NC, runs along the top edge of the Blue Ridge escarpment.\n\n\nShow the code\np1 &lt;- ggplot() +\n  geom_spatraster(data = nc_elevation,\n          na.rm = TRUE) +\n  geom_sf(data = parkway_lines_nc,\n          color = \"firebrick\",\n          linewidth = 0.05\n          ) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"grey50\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\") +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE)) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = \"North Carolina elevation\",\n    fill = \"Elevation\\n(meters)\"\n  )\n\np2 &lt;- ggplot() +\n  geom_spatraster(data = nc_tri,\n          na.rm = TRUE) +\n  geom_sf(data = parkway_lines_nc,\n          color = \"firebrick\",\n          linewidth = 0.05\n          ) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"grey50\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\") +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE)) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = glue(\"North Carolina terrain ruggedness (TRI)\"),\n    fill = \"TRI\"\n  )\n\np1 / p2 +\n  plot_annotation(\n    title = \"NC elevation and ruggedness\",\n    subtitle = glue(\"Red line is the Blue Ridge Parkway. In the north half of the state,\", \n                    \"\\nit mostly runs along the top of the Blue Ridge escarpment.\"),\n    caption = my_caption_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.8: Ruggedness - North Carolina\n\n\n\n\n\n\n\n\nShow the code\nrange_nc_tri &lt;- c(0, max(values(nc_tri), na.rm = TRUE))\nnc_tri2 &lt;- nc_tri\nnc_tri2[ nc_tri2 &lt; threshold_coastal ] &lt;- NA\nnc_tri2[ nc_tri2 &gt; threshold_piedmont ] &lt;- NA\n\nthreshold_coastal_elevation_ft &lt;- 300   # meters\nthreshold_piedmont_elevation_ft &lt;- 1500 # meters\n\np1 &lt;- ggplot() +\n  geom_spatraster(data = nc_tri2,\n          na.rm = TRUE) +\n  geom_sf(data = parkway_lines_nc,\n          color = \"firebrick\",\n          linewidth = 0.05\n          ) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"darkblue\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\",\n                             limits = range_nc_tri\n                             ) +\n  guides(fill = \"none\") +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = glue(\"A. Large green area is the Piedmont.\",\n                    \" TRI: Coastal plain &lt; {threshold_coastal}; Piedmont; &lt; {threshold_piedmont} Mountains\"), \n    fill = \"TRI\"\n  )\n\nrange_nc_elevation &lt;- c(0, max(values(nc_elevation, na.rm = TRUE)))\nnc_elevation2 &lt;- nc_elevation\nnc_elevation2[ nc_elevation2$elevation &lt; threshold_coastal_elevation_ft * 0.3048 ] &lt;- NA # &lt; 300 ft is coastal\nnc_elevation2[ nc_elevation2$elevation &gt; threshold_piedmont_elevation_ft * 0.3048 ] &lt;- NA # &gt; 1500 ft is mountain\n\np2 &lt;- ggplot() +\n  geom_spatraster(data = nc_elevation2,\n          na.rm = TRUE) +\n  geom_sf(data = parkway_lines_nc,\n          color = \"firebrick\",\n          linewidth = 0.05\n          ) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"darkblue\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\",\n                             limits = range_nc_elevation) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE,\n                             )) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = glue(\"B. NC region defined by elevation.\",\n                    \" Coastal plain &lt; {threshold_coastal_elevation_ft} ft ({round(threshold_coastal_elevation_ft * 0.3048)} m)\", \n                    \"; Piedmont; {threshold_piedmont_elevation_ft} ft ({round(threshold_piedmont_elevation_ft * 0.3048)} m) &lt; Mountains\",\n                    \"\\nSource: www.ncpedia.org/geography/region/piedmont\"),\n    fill = \"Elevation\\n(meters)\"\n  )\n\np1 / p2 +\n  plot_annotation(\n    # title = glue(\"Ruggedness values (panel A) do as well defining\",\n    #              \"\\nNorth Carolina regions (mountains, Piedmont, and coastal plain) \",\n    #              \"\\nas commonly accepted elevations (panel B)\",\n    #              ),\n    title = glue(\"Ruggedness (panel A) does as well as elevation (panel B) in defining\",\n                 \"\\nNorth Carolina regions (mountains, Piedmont, and coastal plain).\",\n                 ),\n    caption = my_caption_nid_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.9: Ruggedness (panel A) does as well as elevation (panel B) in defining North Carolina regions (mountains, Piedmont, and coastal plain)\n\n\n\n\n\n\n\n\n11.3.3 Predicting dams’ NC region from tri_meandam\nThe NC region in which dams (25+ ft high) are placed can be predicted from \\(tri\\_mean_{dam}\\) (Figure 11.10).\n\n\nShow the code\nggplot() +\n  geom_spatraster(data = nc_elevation,\n          na.rm = TRUE,\n          show.legend = FALSE) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"grey50\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  geom_sf(data = nc_dams_with_tri |&gt;\n            filter(nidHeight &gt;= 25),\n          aes(color = est_region),\n          size = 0.35) +\n  scale_fill_cross_blended_c(trans = \"sqrt\") +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\")) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE,\n                             override.aes = list(size = 3)\n                             )) +\n  guides(color = guide_legend(position = \"inside\",\n                             reverse = FALSE,\n                             override.aes = list(size = 3)\n                             )) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    title = \"North Carolina elevation with dams (excluding small dams)\",\n    subtitle = glue(\"Includes dams with nidHeight &gt;= 25 ft. Mean TRI calculated from circle around dam with radius 5 km.\",\n                    \"\\nResolution of points in TRI caculation ~120 m.\", \n                    \" TRI thresholds: mountain &gt; {threshold_piedmont}; piedmont; {threshold_coastal} &gt; coastal.\"), \n    caption = my_caption_nid_opentopography,\n    fill = \"Elevation\\n(meters)\",\n    color = \"Dam's region predicted\\nfrom mean TRI\"\n  )\n\n\n\n\n\n\n\n\nFigure 11.10: Ruggedness - North Carolina\n\n\n\n\n\n\nThe NC region in which small dams (less than 25 ft high) are placed can be predicted from \\(tri\\_mean_{dam}\\) too–but not as accurately (Figure 11.11).\n\n\nShow the code\nggplot() +\n  geom_spatraster(data = nc_elevation,\n          na.rm = TRUE,\n          show.legend = FALSE) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"grey50\",\n          linewidth = 0.5,\n          alpha = 0.8,\n          na.rm = TRUE) +\n  geom_sf(data = nc_dams_with_tri |&gt;\n            filter(nidHeight &lt; 25),\n          aes(color = est_region),\n          size = 0.35) +\n  scale_fill_cross_blended_c(trans = \"sqrt\") +\n  scale_color_manual(values = c(\"firebrick\", \"darkslategrey\", \"blue\")) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE,\n                             override.aes = list(size = 3)\n                             )) +\n  guides(color = guide_legend(position = \"inside\",\n                             reverse = FALSE,\n                             override.aes = list(size = 3)\n                             )) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    title = \"North Carolina elevation with dams (small dams only)\",\n    subtitle = glue(\"Includes dams with nidHeight &lt; 25 ft. Mean TRI calculated from circle around dam with radius 5 km.\",\n                    \"\\nResolution of points in TRI caculation ~120 m.\", \n                    \" TRI thresholds: mountain &gt; {threshold_piedmont}; piedmont; {threshold_coastal} &gt; coastal.\"), \n    caption = my_caption_nid_opentopography,\n    fill = \"Elevation\\n(meters)\",\n    color = \"Dam's region predicted\\nfrom mean TRI\"\n  )\n\n\n\n\n\n\n\n\nFigure 11.11: Ruggedness - North Carolina\n\n\n\n\n\n\n\n\n11.3.4 Comparing TRI and elevation prediction heuristics\nThe two heuristics for predicting region generally agree: (1) TRI thresholds and (2) elevation thresholds.\n\n\nShow the code\nthreshold_table &lt;- tribble(\n  ~ heuristic,  ~threshold,                         ~value,                           ~comparison,  ~predicted_region,     ~unit,\n  \"TRI\",        \"threshold_coastal\",                threshold_coastal,                \"&lt;\",                    \"Coastal\",   \"m\",\n  \"TRI\",        \"threshold_piedmont\",               threshold_piedmont,               \"&lt;=\",                   \"Piedmont\",  \"m\",\n  \"TRI\",        \"threshold_piedmont\",               threshold_piedmont,               \"&gt;\",                    \"Mountains\", \"m\",\n  \"Elevation\",  \"threshold_coastal_elevation_ft\",   threshold_coastal_elevation_ft,   \"&lt;\",                    \"Coastal\",   \"ft\",\n  \"Elevation\",  \"threshold_piedmont_elevation_ft\",  threshold_piedmont_elevation_ft,  \"&lt;=\",                   \"Piedmont\",  \"ft\",\n  \"Elevation\",  \"threshold_piedmont_elevation_ft\",  threshold_piedmont_elevation_ft,  \"&gt;\",                    \"Mountains\", \"ft\"\n) |&gt; \n  select(heuristic, comparison, value, unit, predicted_region)\n  \n\nthreshold_table |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Table of heuristics and threshold values used for predicting NC region**\"))\n\n\n\n\n\n\n\n\nTable of heuristics and threshold values used for predicting NC region\n\n\nheuristic\ncomparison\nvalue\nunit\npredicted_region\n\n\n\n\nTRI\n&lt;\n1.5\nm\nCoastal\n\n\nTRI\n&lt;=\n8.0\nm\nPiedmont\n\n\nTRI\n&gt;\n8.0\nm\nMountains\n\n\nElevation\n&lt;\n300.0\nft\nCoastal\n\n\nElevation\n&lt;=\n1500.0\nft\nPiedmont\n\n\nElevation\n&gt;\n1500.0\nft\nMountains\n\n\n\n\n\n\n\n\nUsing the above heuristics:\n\n\nShow the code\nnc_dams_vec &lt;- nc_dams_with_tri |&gt;\n  select(nidId, state_abb, nidHeight, nidHeightId, starts_with(\"tri\"), geom) |&gt;\n                      vect()\n\nnc_dams_vec$elev = terra::extract(nc_elevation, nc_dams_vec)[ , 2]\n\nnc_dams_with_elev_sf &lt;- st_as_sf(nc_dams_vec) |&gt;\n  left_join(\n    nc_dams_with_tri |&gt;\n      st_drop_geometry() |&gt;\n      select(nidId, est_region),\n    by = join_by(nidId)\n  ) |&gt;\n  mutate(est_region_elev = case_when(\n    elev &lt; threshold_coastal_elevation_ft * 0.3048     ~ \"3. Coastal\",\n    elev &lt; threshold_piedmont_elevation_ft * 0.3048    ~ \"2. Piedmont\",\n    .default = \"1. Mountains\"\n  ),\n  agree = est_region == est_region_elev\n  )\n\nagree_df &lt;- nc_dams_with_elev_sf |&gt;\n  st_drop_geometry() |&gt;\n  reframe(\n    n_agree = sum(agree),\n    n_rows = n(),\n    pct_agree = n_agree / n_rows,\n    .by = nidHeightId\n  ) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  mutate(pct_agree = n_agree / n_rows)\n\nagree_df |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Prediction methods mostly agree**&lt;br&gt;Using (1) TRI and (2) elevation heuristics&lt;br&gt;Dams in North Carolina\")) |&gt;\n  cols_align(columns = nidHeightId,\n             align = \"left\") |&gt;\n  fmt_percent(columns = pct_agree,\n              decimals = 1)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPrediction methods mostly agreeUsing (1) TRI and (2) elevation heuristicsDams in North Carolina\n\n\nnidHeightId\nn_agree\nn_rows\npct_agree\n\n\n\n\nLess than 25 feet\n1360\n1721\n79.0%\n\n\n51-100 feet\n114\n145\n78.6%\n\n\n25-50 feet\n1223\n1447\n84.5%\n\n\nGreater than 100 feet\n27\n33\n81.8%\n\n\nTotal\n2724\n3346\n81.4%\n\n\n\n\n\n\n\n\nTable 11.2: Prediction methods mostly agree\n\n\n\n\n\n\n\n11.3.5 Optimizing agreement between the two prediction methods\nCan I find better TRI threshold values to maximize the agreement with elevation in estimating NC region? Yes, using a grid search to vary coast_val and pied_val threshold values.\n\n\nShow the code\nregion_est_compare_tmp &lt;- nc_dams_with_elev_sf |&gt;\n  st_drop_geometry() |&gt;\n  rename(orig_agree = agree) |&gt;\n  mutate(orig_est = parse_number(est_region_elev))\n\nmy_grid &lt;- tibble(\n  threshold_coastal_tri = c(1.0, 1.25, 1.5, 1.75, 2.0, 2.25, 2.5, 2.75, 3.0),\n  threshold_piedmont_tri = c(7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 11)\n)\n\nregion_est_compare &lt;- region_est_compare_tmp\nfor(i in seq_len(length(my_grid$threshold_coastal_tri))) {\n  for(j in seq_len(length(my_grid$threshold_piedmont_tri))) {\n    my_col_est &lt;- glue(\"coast_{my_grid$threshold_coastal_tri[i]}_pied_{my_grid$threshold_piedmont_tri[j]}_est\")\n    my_col_agree &lt;- glue(\"coast_{my_grid$threshold_coastal_tri[i]}_pied_{my_grid$threshold_piedmont_tri[j]}_agree\")\n    \n    new_cols &lt;- region_est_compare |&gt;\n      mutate(\n        tmp := case_when(\n          tri_mean_dam &lt; my_grid$threshold_coastal_tri[i]      ~ 3, # Coastal\n          tri_mean_dam &lt;= my_grid$threshold_piedmont_tri[j]    ~ 2, # Piedmont\n          .default = 1 # Mountains\n        ),\n        {{my_col_agree}} := tmp == orig_est\n      ) |&gt;\n      rename({{my_col_est}} := tmp)\n    \n    region_est_compare &lt;- new_cols\n    \n  }\n}\n\nregion_est_compare_long &lt;- region_est_compare |&gt;\n  pivot_longer(cols = ends_with(\"_agree\"),\n               names_to = \"params\",\n               values_to = \"agree\")\n\nregion_est_compare_summary &lt;- region_est_compare_long |&gt;\n  reframe(\n    n_agree = sum(agree),\n    pct_agree = n_agree / n(),\n    .by = params\n  )\n\noptimal_tri_params &lt;- region_est_compare_summary |&gt;\n  filter(pct_agree == max(pct_agree)) |&gt;\n  mutate(coast_val = parse_number(str_extract(params, \"(?&lt;=coast_)\\\\d([.])?(\\\\d+)?\")),\n         pied_val = parse_number(str_extract(params, \"(?&lt;=pied_)\\\\d+([.])?(\\\\d+)?\"))\n  )\n  \noptimal_tri_params |&gt;\n  gt() |&gt;\n  tab_header(md(glue(\"**Optimal TRI threshold values**\", \n                     \"&lt;br&gt;to match elevation heuristic predicting NC regions\"))) |&gt;\n  fmt_percent(columns = pct_agree,\n              decimals = 2) |&gt;\n  fmt_number(columns = ends_with(\"_val\"),\n             decimals = 2)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nOptimal TRI threshold valuesto match elevation heuristic predicting NC regions\n\n\nparams\nn_agree\npct_agree\ncoast_val\npied_val\n\n\n\n\ncoast_2.75_pied_9.5_agree\n2859\n85.45%\n2.75\n9.50\n\n\n\n\n\n\n\n\n\n\nShow the code\ndta_for_plot &lt;- region_est_compare_summary |&gt;\n  mutate(coast_val = parse_number(str_extract(params, \"(?&lt;=coast_)\\\\d([.])?(\\\\d+)?\")),\n         pied_val = parse_number(str_extract(params, \"(?&lt;=pied_)\\\\d+([.])?(\\\\d+)?\"))\n         ) |&gt;\n  mutate(label = case_when(\n    params == optimal_tri_params$params    ~ glue(\"optimal:\\n{percent(pct_agree, accuracy = 0.1)}\"),\n    coast_val == threshold_coastal & \n      pied_val == threshold_piedmont       ~ glue(\"original:\\n{percent(pct_agree, accuracy = 0.1)}\"),\n    .default =  glue(\"{percent(pct_agree, accuracy = 0.1)}\")\n  ) \n  )\n\ndta_for_plot |&gt;\n  ggplot(aes(x = coast_val, y = pied_val)) +\n  geom_tile(aes(fill = pct_agree),\n            na.rm = TRUE,\n            alpha = 0.8) +\n  geom_text(aes(label = label),\n            na.rm = TRUE) +\n  geom_tile(aes(x = if_else(str_detect(label, \"^o\"),\n                               coast_val,\n                               NA),\n                y = if_else(str_detect(label, \"^o\"),\n                               pied_val,\n                               NA),\n                width = 0.25,\n                height = 0.5,\n                ),\n            na.rm = TRUE,\n            color = \"firebrick\",\n            fill = NA,\n            alpha = 0.8) +\n  guides(fill = \"none\") +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.04))) +\n  theme(palette.colour.continuous = scales::pal_viridis(end = 0.95),\n        axis.text = element_text(size = 14)) +\n  labs(\n    title = \"Grid search found better\\nTRI region thresholds\",\n    subtitle = glue(\"Optimsal TRI thresholds\",\n                    \": Coastal plain &lt; {optimal_tri_params$coast_val}; Piedmont;\", \n                    \" &lt;= {optimal_tri_params$pied_val} Mountains\",\n                    \"\\nMatching elevation heuristic with {percent(optimal_tri_params$pct_agree, accuracy = 0.01)}\", \n                    \" agreement in predicting NC region\"),\n    fill = \"Agreement\",\n    caption = my_caption_self_only\n  )\n\n\n\n\n\n\n\n\nFigure 11.12: Grid search for best TRI thresholds that match the elevation heuristic for predicting NC region\n\n\n\n\n\n\nCompared to the results using original TRI threshold values (Table 11.2), agreement of NC region predictions for small dams improved 6 percent while agreement for the largest dams (fewer in number) declined 6 percent.\n\n\nShow the code\nparams_est &lt;- paste0(str_remove(optimal_tri_params$params, \"_agree\"), \"_est\")\n\nagree_df &lt;- region_est_compare_long |&gt;\n  filter(params == optimal_tri_params$params) |&gt;\n  select(nidId, nidHeight, nidHeightId, state_abb, est_region_elev, {{params_est}}, params, agree) |&gt;\n  reframe(\n    n_agree = sum(agree),\n    n_rows = n(),\n    pct_agree = n_agree / n_rows,\n    .by = nidHeightId\n  ) |&gt;\n  adorn_totals(where = \"row\") |&gt;\n  mutate(pct_agree = n_agree / n_rows)\n\nagree_df |&gt;\n  gt() |&gt;\n  tab_header(md(glue(\"**Prediction methods mostly agree**&lt;br&gt;Using (1) optimal TRI thresholds and\", \n                     \"&lt;br&gt;(2) elevation heuristics&lt;br&gt;Dams in North Carolina\"))) |&gt;\n  cols_align(columns = nidHeightId,\n             align = \"left\") |&gt;\n  fmt_percent(columns = pct_agree,\n              decimals = 1)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPrediction methods mostly agreeUsing (1) optimal TRI thresholds and(2) elevation heuristicsDams in North Carolina\n\n\nnidHeightId\nn_agree\nn_rows\npct_agree\n\n\n\n\nLess than 25 feet\n1456\n1721\n84.6%\n\n\n51-100 feet\n117\n145\n80.7%\n\n\n25-50 feet\n1261\n1447\n87.1%\n\n\nGreater than 100 feet\n25\n33\n75.8%\n\n\nTotal\n2859\n3346\n85.4%\n\n\n\n\n\n\n\n\nTable 11.3: Prediction methods mostly agree sing (1) optimal TRI thresholds and (2) elevation heuristics\n\n\n\n\n\n\n\nShow the code\nrange_nc_tri &lt;- c(0, max(values(nc_tri), na.rm = TRUE))\nnc_tri3 &lt;- nc_tri\nnc_tri3[ nc_tri3 &lt; optimal_tri_params$coast_val ] &lt;- NA\nnc_tri3[ nc_tri3 &gt; optimal_tri_params$pied_val ] &lt;- NA\n\nthreshold_coastal_elevation_ft &lt;- 300   # meters\nthreshold_piedmont_elevation_ft &lt;- 1500 # meters\n\np1 &lt;- ggplot() +\n  geom_spatraster(data = nc_tri3,\n          na.rm = TRUE) +\n  geom_sf(data = parkway_lines_nc,\n          color = \"firebrick\",\n          linewidth = 0.05\n          ) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"grey50\",\n          linewidth = 0.5,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\",\n                             limits = range_nc_tri\n                             ) +\n  guides(fill = \"none\") +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = glue(\"A. Large green area is the predicted Piedmont\",\n                    \" with optimal TRI: Coastal plain &lt; {optimal_tri_params$coast_val}; Piedmont;\", \n                    \" &lt;= {optimal_tri_params$pied_val} Mountains\",\n                    \"\\nMatching elevation heuristic with {percent(optimal_tri_params$pct_agree, accuracy = 0.01)}\", \n                    \" agreement in predicted region\"), \n    fill = \"TRI\"\n  )\n\nrange_nc_elevation &lt;- c(0, max(values(nc_elevation, na.rm = TRUE)))\nnc_elevation2 &lt;- nc_elevation\nnc_elevation2[ nc_elevation2$elevation &lt; threshold_coastal_elevation_ft * 0.3048 ] &lt;- NA # &lt; 300 ft is coastal\nnc_elevation2[ nc_elevation2$elevation &gt; threshold_piedmont_elevation_ft * 0.3048 ] &lt;- NA # &gt; 1500 ft is mountain\n\np2 &lt;- ggplot() +\n  geom_spatraster(data = nc_elevation2,\n          na.rm = TRUE) +\n  geom_sf(data = parkway_lines_nc,\n          color = \"firebrick\",\n          linewidth = 0.05\n          ) +\n  geom_sf(data = nc_boundary,\n          fill = NA,\n          color = \"grey50\",\n          linewidth = 0.5,\n          na.rm = TRUE) +\n  scale_fill_cross_blended_c(trans = \"sqrt\",\n                             limits = range_nc_elevation) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE,\n                             )) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = glue(\"B. NC region defined by elevation.\",\n                    \" Coastal plain &lt; {threshold_coastal_elevation_ft} ft ({round(threshold_coastal_elevation_ft * 0.3048)} m)\", \n                    \"; Piedmont; {threshold_piedmont_elevation_ft} ft ({round(threshold_piedmont_elevation_ft * 0.3048)} m) &lt; Mountains\",\n                    \"\\nSource: www.ncpedia.org/geography/region/piedmont\"),\n    fill = \"Elevation\\n(meters)\"\n  )\n\np1 / p2 +\n  plot_annotation(\n    # title = glue(\"Using optimal TRI thresholds predicting NC regions (panel A)\",\n    #              \"\\ndoes as well as commonly accepted elevations (panel B)\"\n    #              ),\n    title = glue(\"Optimal TRI thresholds (panel A) do as well as elevation (panel B)\",\n                 \"\\nin defining NC regions (mountains, Piedmont, and coastal plain).\",\n                 ),\n    caption = my_caption_nid_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.13: Optimal TRI thresholds (panel A) do as well as elevations (panel B) in defining Carolina regions (mountains, Piedmont, and coastal plain).\n\n\n\n\n\n\nCombining the intersection and disjoint set of original (Figure 11.9) and optimal (Figure 11.13) plots thresholds into one plot (Figure 11.14): the optimal thresholds remove a lot of points around rivers in the coastal plain–and unfortunately, also flat spots in the Piedmont.\nI prefer the visual look in the original Figure 11.9, because (1) it’s interesting to see the shapes of the rivers in the coastal plain (one is not tempted to think the Piedmont extends into the coastal plain along the rivers); and (2) there are fewer white “holes” in the Piedmont.\n\n\nShow the code\n# TODO: can I do better?\n# So far I can plot results of intersect() which are {TRUE, FALSE, NA} values\n# I'd rather have two plots, one for TRUE and one for FALSE and in both cases plot the TRI values rather than TRUE/FALSE\n# Perhaps use terra::segregate(), thresh(), or divide()?\n\n# TODO: change fig.height to 10 or 11 if plotting 2 NC maps\n\nrange_nc_tri &lt;- c(0, max(values(nc_tri), na.rm = TRUE))\n\nnc_tri4 &lt;- c(nc_tri2 |&gt; \n               rename(TRI2 = TRI), \n             nc_tri3 |&gt; \n               rename(TRI3 = TRI)\n             )\n\nnc_tri4$intersect &lt;- intersect(nc_tri2, nc_tri3)\n\nnc_tri4[is.na(nc_tri4$intersect)] &lt;- NA\n\np1 &lt;- ggplot() +\n  geom_spatraster(\n    data = nc_tri4[[\"intersect\"]],\n    alpha = 0.7) +\n  geom_sf(\n    data = parkway_lines_nc,\n    color = \"firebrick\",\n    linewidth = 0.05\n  ) +\n  geom_sf(\n    data = nc_boundary,\n    fill = NA,\n    color = \"grey50\",\n    linewidth = 0.5,\n    # alpha = 0.8,\n    na.rm = TRUE) +\n  scale_fill_gradient(low = \"gold\",\n                      high = \"darkgreen\",\n                      na.value = \"white\",\n                      breaks = c(0, 1)) +\n  guides(fill = guide_legend(position = \"inside\",\n                             reverse = TRUE,\n                             )) +\n  theme(legend.position.inside = c(0.3, 0.2),\n        axis.title = element_blank(),\n        axis.text = element_blank(),\n        axis.ticks = element_blank()\n        ) +\n  labs(\n    subtitle = glue(\"NC Piedmont region predicted by both TRI threshold sets (1) and only one set (0).\"),\n    fill = \"TRI\"\n  )\n\np1 +\n  plot_annotation(\n    title = glue(\"Prediction of land as 'Piedmont' using original\\nand optimized TRI threshold sets\"),\n    caption = my_caption_nid_opentopography\n  )\n\n\n\n\n\n\n\n\nFigure 11.14: Comparing the predicted region using original and optimal sets of ruggedness (TRI) thresholds in North Carolina",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Preparing terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "ruggedness-preparing.html#footnotes",
    "href": "ruggedness-preparing.html#footnotes",
    "title": "11  Preparing terrain ruggedness",
    "section": "",
    "text": "Wilson et al 2007, Multiscale Terrain Analysis of Multibeam Bathymetry Data for Habitat Mapping on the Continental Slope. Marine Geodesy 30:3-35.↩︎\nA Terrain Ruggedness Index that Quantifies Topographic Heterogeneity. Authors: Shawn J. Riley, Stephen D. DeGloria, Robert Elliot. Intermountain Journal of Sciences, Vol. 5, No. 1-4, 1999. https://arc.lib.montana.edu/ojs/index.php/IJS/article/view/1794/1457 ↩︎\nhttps://www.earthdata.nasa.gov/data/instruments/srtm ↩︎\nhttps://en.wikipedia.org/wiki/List_of_extreme_points_of_the_United_States ↩︎\nSee https://geoservice.dlr.de/web/dataguide/srtm/ and https://gis.stackexchange.com/questions/110755/is-srtm-3-second-arc-free-of-non-terrain-features ↩︎",
    "crumbs": [
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>Preparing terrain ruggedness</span>"
    ]
  },
  {
    "objectID": "notes.html",
    "href": "notes.html",
    "title": "12  Notes and limitations",
    "section": "",
    "text": "12.1 Source notes",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  },
  {
    "objectID": "notes.html#source-notes",
    "href": "notes.html#source-notes",
    "title": "12  Notes and limitations",
    "section": "",
    "text": "12.1.1 National Inventory of Dams\nThere is a useful, simple overview at https://nid.sec.usace.army.mil/#/dam-basics/what-is-a-dam. See also https://nid.sec.usace.army.mil/#/about-the-nid/data and https://nid.sec.usace.army.mil/#/about-the-nid/faq\nThere is a glossary of terms and a brief description of each field on the developer page which also summarizes additional information available via API. The NID data dictionary was last updated in December 2021.\nI downloaded the National Inventory of Dams on 2025-05-15.\nNotes:\n\nlatitude and longitude are at dam centerline expressed as a single value in decimal degrees, NAD83.\n“nid” in the name refers to a value created for this database. In many cases these are conveniences for analysis and plotting. For example, nidHeight combines is the “maximum value of dam height, structural height, and hydraulic height. Accepted as the general height of the dam”.\n\n\nhttps://nid.sec.usace.army.mil/#/\nNational Inventory of Dams\nMore than 90,000 dams nation-wide\n\nDisclaimer You must agree to the following terms to continue to the site.\nYou are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only. By using this IS (which includes any device attached to this IS), you consent to the following conditions:\nThe USG routinely intercepts and monitors communications on this IS for purposes including, but not limited to, penetration testing, COMSEC monitoring, network operations and defense, personnel misconduct (PM), law enforcement (LE), and counterintelligence (CI) investigations. At any time, the USG may inspect and seize data stored on this IS. Communications using, or data stored on, this IS are not private, are subject to routine monitoring, interception, and search, and may be disclosed or used for any USG-authorized purpose. This IS includes security measures (e.g., authentication and access controls) to protect USG interests–not for your personal benefit or privacy.\nNotwithstanding the above, using this IS does not constitute consent to PM, LE or CI investigative searching or monitoring of the content of privileged communications, or work product, related to personal representation or services by attorneys, psychotherapists, or clergy, and their assistants. Such communications and work product are private and confidential. See User Agreement for details.\n\nhttps://nid.sec.usace.army.mil/#/downloads\nData last updated 2025-05-07 downloaded on 2025-05-15\n\nnation.csv\nnation.gpkg\n\nThere is a brief description of each field at https://nid.sec.usace.army.mil/api/developer which also summarizes additional information available via API.\n\nThe National Inventory of Dams (NID) API is a complete, programmable interface to all NID functionality. The NID API is a RESTful web service, using standard technologies like HTTP verbs, headers, and status codes.\nThe NID website is built on this API, and all of its services are available for integration into your application. To get started, we recommend exploring the website to learn about the functionality that is available.\nCurrently, you can develop your application with the public API. If you need assistance, please email us at NID@usace.army.mil with any questions.\n\nSee also https://nid.sec.usace.army.mil/#/about-the-nid/data and https://nid.sec.usace.army.mil/#/about-the-nid/faq\nUseful, simple overview: https://nid.sec.usace.army.mil/#/dam-basics/what-is-a-dam\nThere is also a glossary of terms: https://www.fema.gov/sites/default/files/2020-08/fema_dam-safety_glossary_P-148.pdf\nNational Inventory of Dams. Data Dictionary. December 2021 https://usace-cwbi-prod-il2-nld2-docs.s3-us-gov-west-1.amazonaws.com/ec51e2ba-daff-4dbe-95eb-af13b91066ba/NID%20Data%20Dictionary%202021-12-14.pdf\nNotes:\n\nlatitude and longitude are at dam centerline expressed as a single value in decimal degrees, NAD83.\nvolume refers to the dam; storage refers to the capacity of the dam to store water.\n\n\n\n12.1.2 Other sources of data\nSee river and hydrology data at the end of this chapter and the list in Acknowledgements section of Chapter 1 Introduction.",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  },
  {
    "objectID": "notes.html#limitations",
    "href": "notes.html#limitations",
    "title": "12  Notes and limitations",
    "section": "12.2 Limitations",
    "text": "12.2 Limitations\n\nAs in any large data set consisting of records provided by many parties over many years…\n\nThere are some errors and inconsistencies in the data.\nThere are a lot of missing values for some fields. Very few records have data in every field.\nprimaryPurposeId requires someone to pick one reason. Many dams were built for multiple reasons, or at least now serve multiple purposes. Views that look only at primary purpose may present a skewed view.\n\n\n\n\nShow the code\ndta_for_plot &lt;- dams_no_geo |&gt;\n  slice_max(order_by = dataUpdated,\n            n = 1,\n            with_ties = FALSE,\n            by = state_abb) |&gt;\n  mutate(days_since_last_update = as.numeric(difftime(ymd(\"2025-05-15\"), dataUpdated, \"days\"))) |&gt;\n  arrange(days_since_last_update) |&gt;\n  mutate(idx = row_number()) \n\n\n\nThis data set is subject to selection bias. Some state departments may be more diligent in recording information for small dams or have preferences in how categorize purpose or encode data in other fields.\nData freshness: While it’s not obvious how often the states provide relevant updates to the NID, it is a good sign that the most recent update occurred only 8 days prior to my download, and half the states updated at least one record in the month before I downloaded it (Figure 12.1 panel B). The longest period since update by any state is 120 days. However, we don’t know for sure that all states provide updates when there is a relevant update–-or how long information may sit in government offices before being sent to the NID. All that said, given every state provided an update within the last 120 days, it seems to me that we can be confided that the data is actively and regularly updated.\n\n\n\nShow the code\n##| column: page-right\n\np1 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  geom_histogram(aes(days_since_last_update),\n                 binwidth = 7) +\n  scale_y_continuous(breaks = 0:10 * 2,\n                     expand = expansion(mult = c(0, 0.04))) +\n  labs(\n    subtitle = \"A: Histogram\",\n    x = \"Days\",\n    y = \"Count\"\n  )\n\np2 &lt;- dta_for_plot |&gt;\n  ggplot() +\n  stat_ecdf(aes(days_since_last_update),\n            linewidth = 0.5,\n            color = \"steelblue\") +\n  scale_y_continuous(labels = label_percent(),\n                     expand = expansion(mult = c(0, 0.04))) +\n  labs(\n    subtitle = \"B: Cumulative distribution\",\n    x = \"Days\",\n    y = \"Percent of states in continental USA\"\n  )\n\np1 + p2 +\n  plot_annotation(\n    title =\"States' days since last update to NID\", \n    subtitle =  glue(\"Prior to my download on {nid_download_date}\"),\n    caption = my_caption\n  )\n\n\n\n\n\n\n\n\nFigure 12.1: NID update frequency",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  },
  {
    "objectID": "notes.html#todos-and-questions",
    "href": "notes.html#todos-and-questions",
    "title": "12  Notes and limitations",
    "section": "12.3 TODOs and questions",
    "text": "12.3 TODOs and questions\n\nDONE: remove stuff in prepare-data.R that is no longer used\nDONE: Decide whether to keep RMSE in ruggedness.qmd - removed it.\nDONE: Add commentary above plots that lack it.\nDONE: Confirm auto-dark is working OK. Including: should I stay with SVGs or move pack to PNGs? The SVGs are much bigger. I went back to cosmo theme + plots as PNGs\nDONE: confirm “Michigan corrected” wherever surfaceArea and nidStorage are used\nDONE: Resolve remaining “TODO’ statements in markup (not in code blocks–leave them)\nDONE: Ensure captions have the right data sources\nSTARTED: Remove “processed” files no longer needed\nTODO: Remove “raw” files not used\nTODO: Push to GH\nTODO: Render to GH Pages\n\n\n12.3.1 Exclude ancillary dam features. I only want “every main dam”.\nExclude any record with a value in otherStructureID. Data exists in this field only for structures other than the main dams.\n\n\n12.3.2 Exclude dikes and levees\n\nDONE: Multiple dikes and levees around the same water feature all “claim” the water, inflating the nidStorage, surfaceArea, etc. See examples in Table 12.1 below. Since I’m only interested in dams, I exclude them by removing all rows of data that include “[Dd]ike” if not accompanied by “[Dd]am”. This removes about 14K rows (92K to 78K)\nfilter(!(str_detect(name, \"[Ddike]\") & !str_detect(name, \"[Dam]\"))) |&gt; # no dikes period unless with dam\n\nThere are other cases of duplicate accounting, for example the following:\nnidId \"OH00581\", # Grand Lake St. Marys - East Embankment in Ohio (duplicate surface area with West Embankment)\nnidId \"WA00266\" # North Dam; same surface area and nidStorage as Dry Falls Dam\n\n\n\n\n12.3.3 Address other special cases creating outliers\n\nDONE: Remove outliers when it makes sense do to so (especially related to nidStorage and surfaceArea).\n\nThe most egregious case is the modest MI00650 Soo Locks which “claims” a large portion of the water of Lake Superior as discussed in Chapter 6 Numbers.\n\n\n\n\nShow the code\ndams_all |&gt;\n  st_drop_geometry() |&gt;\n  slice_max(order_by = surfaceArea, n = 20) |&gt;\n  arrange(desc(surfaceArea)) |&gt;\n  select(state, name, nidId, surfaceArea, nidStorage) |&gt;\n  gt() |&gt;\n  tab_header(md(\"**Top 20 NID records with largest surfaceArea**\")) |&gt;\n  tab_source_note(md(\"*Source: National Inventory of Dams. Table: Daniel Moul*\")) |&gt;\n  fmt_number(columns = c(surfaceArea, nidStorage),\n             decimals = 0)\n\n\n\n\n\n\n\n\n\n\n\nTop 20 NID records with largest surfaceArea\n\n\nstate\nname\nnidId\nsurfaceArea\nnidStorage\n\n\n\n\nMichigan\nSoo Locks\nMI00650\n20,255,000\n277,540,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ G\nFL36001\n467,200\n8,519,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ A\nFL36001\n467,200\n8,519,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ F\nFL36001\n467,200\n8,519,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ C\nFL36001\n467,200\n8,519,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ B\nFL36001\n467,200\n8,519,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ D\nFL36001\n467,200\n8,519,000\n\n\nFlorida\nHerbert Hoover Dike - CIZ E\nFL36001\n467,200\n8,519,000\n\n\nArkansas\nBull Shoals Dam\nAR00160\n454,400\n5,408,000\n\n\nColorado\nFlatiron Dam\nCO01654\n381,500\n1,136\n\n\nSouth Dakota\nOahe Dam - Fort Yates Flood Protection Project\nSD01095\n376,000\n23,600,000\n\n\nSouth Dakota\nOahe Dam\nSD01095\n376,000\n23,600,000\n\n\nMinnesota\nLower Red Lake Dam\nMN00573\n288,640\n3,428,000\n\n\nTexas\nToledo Bend Saddle Dike 2\nLA00030\n182,490\n5,097,500\n\n\nTexas\nToledo Bend Saddle Dike 3\nLA00030\n182,490\n5,097,500\n\n\nTexas\nToledo Bend Saddle Dike 1\nLA00030\n182,490\n5,097,500\n\n\nLouisiana\nToledo Bend\nLA00030\n182,490\n5,097,500\n\n\nWisconsin\nMenasha Lock and Dam\nWI00814\n173,000\n2,430,000\n\n\nNevada\nHoover Dam\nNV10122\n162,700\n30,237,000\n\n\nArizona\nGlen Canyon Dam\nAZ10307\n160,784\n25,025,826\n\n\n\nSource: National Inventory of Dams. Table: Daniel Moul\n\n\n\n\n\n\n\n\n\nTable 12.1: Top 20 NID records with largest surfaceArea",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  },
  {
    "objectID": "notes.html#nid-data-column-detais",
    "href": "notes.html#nid-data-column-detais",
    "title": "12  Notes and limitations",
    "section": "12.4 NID data column detais",
    "text": "12.4 NID data column detais\nThe NID’s nation.gpkg file has more than 91K rows of data. After partial cleaning and converting appropriate columns from character to numeric type, variables can be grouped by Date, character and numeric type.\n\n\nShow the code\ndta_for_skimr_table &lt;- dams_all |&gt;\n  st_drop_geometry() |&gt;\n  skimr::skim() |&gt;\n  select(-c(character.empty, character.whitespace)) |&gt;\n  mutate(idx = row_number()) |&gt;\n  relocate(idx)\n\ndta_for_skimr_table |&gt;\n  select(idx:complete_rate, starts_with(\"Date\")) |&gt;\n  filter(skim_type == \"Date\") |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 10) |&gt;\n  tab_header(md(\"**Date data in the `dams_all` dataframe**\")) |&gt;\n  fmt_number(columns = c(n_missing, starts_with(c(\"numeric\", \"character\"))),\n             decimals = 0) |&gt;\n  fmt_percent(columns = complete_rate,\n              decimals = 0) |&gt;\n  sub_missing()\n\n\n\n\n\n\n\n\nDate data in the dams_all dataframe\n\n\nidx\nskim_type\nskim_variable\nn_missing\ncomplete_rate\nDate.min\nDate.max\nDate.median\nDate.n_unique\n\n\n\n\n1\nDate\ndataUpdated\n1\n100%\n2015-09-30\n2025-05-07\n2023-07-06\n432\n\n\n2\nDate\ninspectionDate\n34,562\n63%\n1901-01-01\n5023-05-25\n2019-07-25\n7694\n\n\n3\nDate\nconditionAssessDate\n52,375\n43%\n1965-01-01\n2031-06-30\n2020-04-22\n4435\n\n\n4\nDate\neapLastRevDate\n74,847\n19%\n1960-01-17\n2025-12-30\n2019-06-11\n4342\n\n\n5\nDate\noperationalStatusDate\n75,906\n18%\n1991-06-10\n2025-04-29\n2022-05-21\n1043\n\n\n\n\n\n\n\n\n\nShow the code\ndta_for_skimr_table |&gt;\n  select(idx:complete_rate, starts_with(\"character\")) |&gt;\n  filter(skim_type == \"character\") |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 10) |&gt;\n  tab_header(md(\"**Character data in the `dams_all` dataframe**\")) |&gt;\n  fmt_number(columns = c(n_missing, starts_with(c(\"numeric\", \"character\"))),\n             decimals = 0) |&gt;\n  fmt_percent(columns = complete_rate,\n              decimals = 0) |&gt;\n  sub_missing()\n\n\n\n\n\n\n\n\nCharacter data in the dams_all dataframe\n\n\nidx\nskim_type\nskim_variable\nn_missing\ncomplete_rate\ncharacter.min\ncharacter.max\ncharacter.n_unique\n\n\n\n\n6\ncharacter\nname\n4,326\n95%\n1\n78\n77,549\n\n\n7\ncharacter\notherNames\n66,025\n28%\n1\n108\n23,607\n\n\n8\ncharacter\nformerNames\n82,255\n11%\n1\n152\n7,865\n\n\n9\ncharacter\nnidId\n1\n100%\n7\n8\n91,498\n\n\n10\ncharacter\notherStructureId\n91,308\n1%\n1\n23\n25\n\n\n11\ncharacter\nfederalId\n0\n100%\n7\n12\n92,245\n\n\n12\ncharacter\nownerNames\n7,291\n92%\n1\n586\n53,242\n\n\n13\ncharacter\nownerTypeIds\n9\n100%\n5\n90\n26\n\n\n14\ncharacter\nprimaryOwnerTypeId\n10\n100%\n5\n17\n7\n\n\n15\ncharacter\nseparateStructuresCount\n4,028\n96%\n1\n2\n15\n\n\n16\ncharacter\nisAssociatedStructureId\n0\n100%\n2\n3\n2\n\n\n17\ncharacter\ndesignerNames\n45,176\n51%\n1\n197\n6,531\n\n\n18\ncharacter\nnonFederalDamOnFederalId\n13,556\n85%\n2\n3\n2\n\n\n19\ncharacter\nprimaryPurposeId\n5,783\n94%\n5\n42\n12\n\n\n20\ncharacter\npurposeIds\n5,780\n94%\n5\n153\n572\n\n\n21\ncharacter\nsourceAgency\n1\n100%\n4\n43\n69\n\n\n22\ncharacter\nstateFedId\n26,456\n71%\n1\n17\n63,066\n\n\n23\ncharacter\nstate\n0\n100%\n4\n14\n52\n\n\n24\ncharacter\ncounty\n28\n100%\n3\n33\n1,793\n\n\n25\ncharacter\ncountyState\n33\n100%\n9\n41\n3,045\n\n\n26\ncharacter\ncity\n27,520\n70%\n1\n93\n17,128\n\n\n27\ncharacter\nriverName\n9,001\n90%\n1\n137\n34,671\n\n\n28\ncharacter\ncongDist\n38\n100%\n31\n41\n423\n\n\n29\ncharacter\nstateRegulatedId\n0\n100%\n2\n3\n2\n\n\n30\ncharacter\njurisdictionAuthorityId\n1,205\n99%\n2\n3\n2\n\n\n31\ncharacter\nstateRegulatoryAgency\n19,842\n78%\n1\n52\n101\n\n\n32\ncharacter\npermittingAuthorityId\n558\n99%\n2\n3\n2\n\n\n33\ncharacter\ninspectionAuthorityId\n558\n99%\n2\n3\n2\n\n\n34\ncharacter\nenforcementAuthorityId\n559\n99%\n2\n3\n2\n\n\n35\ncharacter\nfedRegulatedId\n0\n100%\n2\n3\n2\n\n\n36\ncharacter\nfedOwnerIds\n89,383\n3%\n7\n43\n18\n\n\n37\ncharacter\nfedFundingIds\n77,980\n15%\n7\n53\n17\n\n\n38\ncharacter\nfedDesignIds\n65,092\n29%\n7\n102\n30\n\n\n39\ncharacter\nfedConstructionIds\n78,167\n15%\n7\n53\n21\n\n\n40\ncharacter\nfedRegulatoryIds\n87,307\n5%\n7\n63\n20\n\n\n41\ncharacter\nfedInspectionIds\n75,637\n18%\n7\n75\n24\n\n\n42\ncharacter\nfedOperationIds\n89,460\n3%\n7\n53\n18\n\n\n43\ncharacter\nfedOtherIds\n90,939\n1%\n7\n41\n11\n\n\n44\ncharacter\nsecretaryAgricultureBuiltId\n668\n99%\n2\n3\n2\n\n\n45\ncharacter\nnrcsWatershedAuthorizationId\n1,946\n98%\n3\n73\n5\n\n\n46\ncharacter\nprimaryDamTypeId\n7,828\n92%\n4\n25\n12\n\n\n47\ncharacter\ndamTypeIds\n7,287\n92%\n4\n46\n271\n\n\n48\ncharacter\ncoreTypeIds\n46,798\n49%\n5\n135\n24\n\n\n49\ncharacter\nfoundationTypeIds\n47,392\n49%\n4\n21\n7\n\n\n50\ncharacter\nnidHeightId\n0\n100%\n10\n21\n5\n\n\n51\ncharacter\nyearCompletedId\n0\n100%\n9\n12\n13\n\n\n52\ncharacter\nyearsModified\n85,560\n7%\n2\n66\n1,208\n\n\n53\ncharacter\nspillwayTypeId\n35,799\n61%\n4\n12\n3\n\n\n54\ncharacter\nspillwayWidth\n46,522\n50%\n1\n18\n1,452\n\n\n55\ncharacter\noutletGateTypes\n52,817\n43%\n4\n87\n541\n\n\n56\ncharacter\ninspectionFrequency\n34,196\n63%\n1\n3\n15\n\n\n57\ncharacter\nhazardId\n0\n100%\n3\n12\n4\n\n\n58\ncharacter\nconditionAssessId\n17,811\n81%\n4\n14\n6\n\n\n59\ncharacter\neapId\n58\n100%\n2\n12\n3\n\n\n60\ncharacter\nwebsiteUrl\n17\n100%\n19\n115\n274\n\n\n61\ncharacter\nusaceDivision\n19\n100%\n21\n40\n9\n\n\n62\ncharacter\nusaceDistrict\n19\n100%\n14\n40\n39\n\n\n63\ncharacter\noperationalStatusId\n75,893\n18%\n14\n68\n5\n\n\n64\ncharacter\ninundationNidAddedId\n1\n100%\n2\n3\n3\n\n\n65\ncharacter\nhuc2\n36\n100%\n2\n2\n22\n\n\n66\ncharacter\nhuc4\n36\n100%\n4\n4\n215\n\n\n67\ncharacter\nhuc6\n36\n100%\n6\n6\n353\n\n\n68\ncharacter\nhuc8\n36\n100%\n8\n8\n2,018\n\n\n69\ncharacter\nzipcode\n1,734\n98%\n5\n5\n16,771\n\n\n70\ncharacter\nnation\n0\n100%\n3\n3\n1\n\n\n71\ncharacter\nstateKey\n0\n100%\n2\n2\n52\n\n\n72\ncharacter\nfemaRegion\n20\n100%\n1\n2\n10\n\n\n73\ncharacter\nfemaCommunity\n42\n100%\n4\n63\n9,241\n\n\n74\ncharacter\naiannh\n86,573\n6%\n8\n74\n156\n\n\n\n\n\n\n\n\n\nShow the code\ndta_for_skimr_table |&gt;\n  select(idx:complete_rate, starts_with(\"numeric\")) |&gt;\n  filter(skim_type == \"numeric\") |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 10) |&gt;\n  tab_header(md(\"**Numeric data in the `dams_all` dataframe after converting sutable data columns to numeric type**\")) |&gt;\n  fmt_number(columns = c(n_missing, starts_with(c(\"numeric\", \"character\"))),\n             decimals = 0) |&gt;\n  fmt_percent(columns = complete_rate,\n              decimals = 0) |&gt;\n  sub_missing()\n\n\n\n\n\n\n\n\nNumeric data in the dams_all dataframe after converting sutable data columns to numeric type\n\n\nidx\nskim_type\nskim_variable\nn_missing\ncomplete_rate\nnumeric.mean\nnumeric.sd\nnumeric.p0\nnumeric.p25\nnumeric.p50\nnumeric.p75\nnumeric.p100\nnumeric.hist\n\n\n\n\n75\nnumeric\nlatitude\n2\n100%\n38\n5\n13\n34\n38\n41\n71\n▁▆▇▁▁\n\n\n76\nnumeric\nlongitude\n2\n100%\n−92\n12\n−177\n−98\n−92\n−84\n145\n▁▇▁▁▁\n\n\n77\nnumeric\ndistance\n50,650\n45%\n11\n18\n0\n2\n6\n14\n2,005\n▇▁▁▁▁\n\n\n78\nnumeric\ndamHeight\n10,006\n89%\n28\n27\n1\n16\n24\n31\n789\n▇▁▁▁▁\n\n\n79\nnumeric\nhydraulicHeight\n37,754\n59%\n27\n26\n1\n15\n22\n30\n776\n▇▁▁▁▁\n\n\n80\nnumeric\nstructuralHeight\n40,050\n57%\n30\n29\n1\n18\n25\n33\n770\n▇▁▁▁▁\n\n\n81\nnumeric\nnidHeight\n497\n99%\n29\n28\n1\n16\n24\n32\n789\n▇▁▁▁▁\n\n\n82\nnumeric\ndamLength\n14,667\n84%\n1,069\n3,229\n1\n334\n534\n926\n470,610\n▇▁▁▁▁\n\n\n83\nnumeric\nvolume\n65,823\n29%\n256,545\n2,295,080\n1\n10,400\n20,000\n55,142\n125,628,000\n▇▁▁▁▁\n\n\n84\nnumeric\nyearCompleted\n18,776\n80%\n1,961\n29\n1,637\n1,952\n1,965\n1,976\n2,024\n▁▁▁▂▇\n\n\n85\nnumeric\nnidStorage\n1,268\n99%\n15,629\n958,431\n0\n70\n135\n427\n277,540,000\n▇▁▁▁▁\n\n\n86\nnumeric\nmaxStorage\n3,380\n96%\n15,748\n969,660\n0\n70\n135\n423\n277,540,000\n▇▁▁▁▁\n\n\n87\nnumeric\nnormalStorage\n9,403\n90%\n11,550\n985,247\n−48\n36\n67\n176\n277,540,000\n▇▁▁▁▁\n\n\n88\nnumeric\nsurfaceArea\n21,394\n77%\n669\n76,378\n0\n6\n12\n31\n20,255,000\n▇▁▁▁▁\n\n\n89\nnumeric\ndrainageArea\n35,227\n62%\n685\n36,015\n0\n0\n2\n18\n8,300,000\n▇▁▁▁▁\n\n\n90\nnumeric\nmaxDischarge\n50,041\n46%\n9,150\n61,533\n0\n194\n634\n2,100\n3,707,516\n▇▁▁▁▁\n\n\n91\nnumeric\nnumberOfLocks\n92,049\n0%\n1\n1\n1\n1\n1\n1\n5\n▇▂▁▁▁\n\n\n92\nnumeric\nlengthOfLocks\n92,052\n0%\n574\n278\n35\n400\n600\n600\n1,200\n▂▂▇▁▂\n\n\n93\nnumeric\nwidthOfLocks\n92,059\n0%\n88\n27\n16\n65\n110\n110\n110\n▁▂▂▃▇\n\n\n94\nnumeric\nsecondaryLengthOfLocks\n92,244\n0%\n600\n—\n600\n600\n600\n600\n600\n▁▁▇▁▁\n\n\n95\nnumeric\nsecondaryWidthOfLocks\n92,244\n0%\n110\n—\n110\n110\n110\n110\n110\n▁▁▇▁▁\n\n\n\n\n\n\n\n\n\n12.4.1 Dams working set\nI did further cleaning to arrive at a working data set called dams\n\n\nShow the code\ndams |&gt;\n  # select(idx:complete_rate, starts_with(\"numeric\")) |&gt;\n  # filter(skim_type == \"numeric\") |&gt;\n  st_drop_geometry() |&gt;\n  skimr::skim() |&gt;\n  arrange(skim_type, skim_variable) |&gt;\n  mutate(idx = row_number()) |&gt;\n  relocate(idx) |&gt;\n  gt() |&gt;\n  tab_options(table.font.size = 10) |&gt;\n  tab_header(md(\"**`Dams` working data set**\")) |&gt;\n  fmt_number(columns = c(n_missing, starts_with(c(\"numeric\", \"character\"))),\n             decimals = 0) |&gt;\n  fmt_percent(columns = complete_rate,\n              decimals = 0) |&gt;\n  sub_missing()\n\n\n\n\n\n\n\n\nDams working data set\n\n\nidx\nskim_type\nskim_variable\nn_missing\ncomplete_rate\nDate.min\nDate.max\nDate.median\nDate.n_unique\ncharacter.min\ncharacter.max\ncharacter.empty\ncharacter.n_unique\ncharacter.whitespace\nfactor.ordered\nfactor.n_unique\nfactor.top_counts\nlogical.mean\nlogical.count\nnumeric.mean\nnumeric.sd\nnumeric.p0\nnumeric.p25\nnumeric.p50\nnumeric.p75\nnumeric.p100\nnumeric.hist\n\n\n\n\n1\nDate\nconditionAssessDate\n47,569\n45%\n1965-01-01\n2031-06-30\n2020-03-17\n4418\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n2\nDate\ndataUpdated\n1\n100%\n2015-09-30\n2025-05-07\n2023-05-31\n401\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n3\nDate\neapLastRevDate\n70,150\n19%\n1960-01-17\n2025-12-30\n2019-04-23\n4285\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n4\nDate\ninspectionDate\n30,458\n65%\n1901-01-01\n5023-05-25\n2019-07-02\n7561\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n5\ncharacter\ncoreTypeIds\n45,901\n47%\n—\n—\n—\n—\n5\n135\n0\n24\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n6\ncharacter\ncounty\n25\n100%\n—\n—\n—\n—\n3\n17\n0\n1,740\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n7\ncharacter\ndamTypeIds\n4,060\n95%\n—\n—\n—\n—\n4\n46\n0\n268\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n8\ncharacter\nfederalId\n0\n100%\n—\n—\n—\n—\n7\n11\n0\n86,351\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n9\ncharacter\nformerNames\n76,481\n11%\n—\n—\n—\n—\n1\n152\n0\n7,761\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n10\ncharacter\nfoundationTypeIds\n46,481\n46%\n—\n—\n—\n—\n4\n21\n0\n7\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n11\ncharacter\ninspectionFrequency\n29,802\n65%\n—\n—\n—\n—\n1\n3\n0\n15\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n12\ncharacter\nname\n0\n100%\n—\n—\n—\n—\n1\n76\n0\n75,995\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n13\ncharacter\nnidId\n0\n100%\n—\n—\n—\n—\n7\n8\n0\n86,351\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n14\ncharacter\notherNames\n64,638\n25%\n—\n—\n—\n—\n1\n108\n0\n19,435\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n15\ncharacter\nownerNames\n7,216\n92%\n—\n—\n—\n—\n1\n586\n0\n49,305\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n16\ncharacter\nownerTypeIds\n9\n100%\n—\n—\n—\n—\n5\n90\n0\n25\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n17\ncharacter\nprimaryDamTypeId\n0\n100%\n—\n—\n—\n—\n4\n25\n0\n12\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n18\ncharacter\nprimaryOwnerTypeId\n0\n100%\n—\n—\n—\n—\n5\n22\n0\n7\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n19\ncharacter\nprimaryPurposeId\n0\n100%\n—\n—\n—\n—\n8\n42\n0\n12\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n20\ncharacter\npurposeIds\n4,007\n95%\n—\n—\n—\n—\n5\n153\n0\n561\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n21\ncharacter\nriverName\n8,691\n90%\n—\n—\n—\n—\n1\n137\n0\n33,676\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n22\ncharacter\nstate\n0\n100%\n—\n—\n—\n—\n4\n14\n0\n48\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n23\ncharacter\nstate_abb\n0\n100%\n—\n—\n—\n—\n2\n2\n0\n48\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n24\ncharacter\nwebsiteUrl\n2\n100%\n—\n—\n—\n—\n19\n115\n0\n271\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n25\ncharacter\nyearCompletedId\n0\n100%\n—\n—\n—\n—\n9\n12\n0\n13\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n26\ncharacter\nyearsModified\n79,829\n8%\n—\n—\n—\n—\n2\n66\n0\n1,201\n0\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n27\nfactor\nconditionAssessId\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\nFALSE\n5\nMis: 53624, Sat: 12307, Fai: 12079, Poo: 7348\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n28\nfactor\neapId\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\nFALSE\n4\nNot: 53434, Yes: 18187, No: 14674, Mis: 56\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n29\nfactor\nhazardId\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\nFALSE\n4\nLow: 55567, Hig: 15879, Sig: 11086, Und: 3819\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n30\nfactor\nnidHeightId\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\nFALSE\n5\nLes: 43017, 25-: 36295, 51-: 5023, Gre: 1526\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n31\nfactor\nstate_div\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\nFALSE\n9\nWes: 19107, Sou: 16089, Wes: 14208, Eas: 10600\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n32\nfactor\nstate_region\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\nFALSE\n4\nSou: 40897, Nor: 25179, Wes: 11950, Nor: 8325\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n33\nlogical\nbig_dam\n490\n99%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n0.01777291\nFAL: 84335, TRU: 1526\n—\n—\n—\n—\n—\n—\n—\n—\n\n\n34\nnumeric\ndamHeight\n9,834\n89%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n28\n28\n1\n16\n24\n31\n789\n▇▁▁▁▁\n\n\n35\nnumeric\ndamLength\n13,953\n84%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n1,046\n3,000\n1\n325\n530\n940\n470,610\n▇▁▁▁▁\n\n\n36\nnumeric\ndrainageArea\n31,477\n64%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n628\n36,481\n0\n0\n2\n19\n8,300,000\n▇▁▁▁▁\n\n\n37\nnumeric\nhydraulicHeight\n36,746\n57%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n27\n27\n1\n15\n22\n30\n776\n▇▁▁▁▁\n\n\n38\nnumeric\nlatitude\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n38\n5\n25\n34\n38\n41\n49\n▁▇▇▇▃\n\n\n39\nnumeric\nlongitude\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n−92\n11\n−125\n−98\n−92\n−83\n−67\n▁▂▇▇▂\n\n\n40\nnumeric\nmaxDischarge\n47,251\n45%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n8,972\n60,494\n0\n180\n660\n2,200\n3,707,516\n▇▁▁▁▁\n\n\n41\nnumeric\nmaxStorage\n3,175\n96%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n12,561\n989,053\n0\n72\n140\n435\n277,540,000\n▇▁▁▁▁\n\n\n42\nnumeric\nnidHeight\n490\n99%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n29\n28\n1\n16\n24\n32\n789\n▇▁▁▁▁\n\n\n43\nnumeric\nnidStorage\n1,145\n99%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n12,435\n977,268\n0\n72\n140\n437\n277,540,000\n▇▁▁▁▁\n\n\n44\nnumeric\nnormalStorage\n9,028\n90%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n9,523\n1,012,938\n−48\n37\n70\n180\n277,540,000\n▇▁▁▁▁\n\n\n45\nnumeric\nstate_area\n0\n100%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n80,266\n63,825\n1,214\n47,716\n58,876\n82,264\n267,339\n▆▇▁▁▂\n\n\n46\nnumeric\nstructuralHeight\n39,077\n55%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n30\n29\n1\n18\n25\n33\n770\n▇▁▁▁▁\n\n\n47\nnumeric\nsurfaceArea\n17,764\n79%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n561\n77,449\n0\n6\n12\n30\n20,255,000\n▇▁▁▁▁\n\n\n48\nnumeric\nvolume\n63,251\n27%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n268,114\n2,316,641\n1\n11,300\n22,876\n62,237\n125,628,000\n▇▁▁▁▁\n\n\n49\nnumeric\nyearCompleted\n17,048\n80%\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n—\n1,961\n29\n1,637\n1,952\n1,965\n1,977\n2,024\n▁▁▁▂▇\n\n\n\n\n\n\n\n\n\n\n12.4.2 NID data I chose not to use\nThe NID data includes damLength, however I don’t use it due to the variable nature of what it includes:\n\ndamLength: Length of the dam, in feet, which is defined as the length along the top of the dam. This also includes the spillway, powerplant, navigation lock, fish pass, etc., where these form part of the length of the dam. If detached from the dam, these structures should not be included.\n\nNor do I use volume, since in the NID this refers to the volume of the dam, not the water behind the dam:\n\nvolume: The total space occupied by the materials forming the dam structure computed between abutments and from top to bottom of dam. No deduction is made for small openings such as galleries, adits, tunnels, and operating chambers within the dam structure. Portions of powerplants, locks, spillway, etc., should be included only if they are necessary for the structural stability of the dam.",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  },
  {
    "objectID": "notes.html#river-shapefiles-available-from-the-nws",
    "href": "notes.html#river-shapefiles-available-from-the-nws",
    "title": "12  Notes and limitations",
    "section": "12.5 River shapefiles available from the NWS",
    "text": "12.5 River shapefiles available from the NWS\nhttps://www.weather.gov/gis/Rivers\nSource: National Weather Service National Operational Hydrologic Remote Sensing Center https://www.nohrsc.noaa.gov/gisdatasets/ The NOHRSC provides and maintains the NWS Integrated Hydrologic Automated Basin Boundary System (IHABBS) GIS database to support river and flood forecasting throughout the nation. Basin boundary data sets and RFC boundaries are provided here in shapefiles that have been tarred and gzipped.\n\nhttps://www.nohrsc.noaa.gov/gisdatasets/ includes many curated shapefiles.",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  },
  {
    "objectID": "notes.html#national-hydrology-dataset---usgs",
    "href": "notes.html#national-hydrology-dataset---usgs",
    "title": "12  Notes and limitations",
    "section": "12.6 National Hydrology Dataset - USGS",
    "text": "12.6 National Hydrology Dataset - USGS\nThis provides the detailed stream-level data for the area around Bad River, SD. –Daniel\n\nhttps://www.usgs.gov/national-hydrography/national-hydrography-dataset\n\nUSGS National Hydrology Database\n\nhttps://www.sciencebase.gov/catalog/item/5d30c27ee4b01d82ce84a9b3\nhttps://www.sciencebase.gov/catalog/item/5d30c27fe4b01d82ce84a9bb\nhttps://www.sciencebase.gov/catalog/item/5d30c27ee4b01d82ce84a9b5\nhttps://www.sciencebase.gov/catalog/item/5d30c27ee4b01d82ce84a9b1\nhttps://www.sciencebase.gov/catalog/item/5d30c27ee4b01d82ce84a9af\nhttps://www.sciencebase.gov/catalog/item/5d30c27ee4b01d82ce84a9ad\nhttps://www.usgs.gov/media/files/national-hydrography-dataset-nhd-data-model-v231\nhttps://www.usgs.gov/ngp-standards-and-specifications/national-hydrography-dataset-nhd-data-dictionary-0\nhttps://www.usgs.gov/ngp-standards-and-specifications/national-hydrography-dataset-nhd-data-dictionary-feature-classes\n\nNHDFlowline FType (Feature type)\n\n460: StreamRiver\n336 CanalDitch\n\nNHDArea FType\n\n460: StreamRiver\n336” CanalDitch\n343: DamWeir\n484 Wash (dry portion of stream bed that contains water only during/after rainfall)\n\nNHDWaterbody FType\n\n390: LakePond\n436: Reservoir\n\nI downloaded South Dakota state-level data from\n\nhttps://www.usgs.gov/national-hydrography/access-national-hydrography-products\ndownload by state: https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/NHD/State/GDB/",
    "crumbs": [
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>Notes and limitations</span>"
    ]
  }
]